<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Email System Test - Attendly</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #0D1117;
            color: #F0F6FC;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .card {
            background-color: #161B22;
            border: 1px solid #30363D;
        }
        .card-header {
            background-color: #21262D;
            border-bottom: 1px solid #30363D;
        }
        .form-control, .form-select {
            background-color: #21262D;
            border: 1px solid #30363D;
            color: #F0F6FC;
        }
        .form-control:focus, .form-select:focus {
            background-color: #21262D;
            border-color: #0A84FF;
            color: #F0F6FC;
            box-shadow: 0 0 0 0.2rem rgba(10, 132, 255, 0.25);
        }
        .btn-primary {
            background-color: #0A84FF;
            border-color: #0A84FF;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }
        .test-success {
            background-color: #0F2419;
            border: 1px solid #28a745;
            color: #4CBB17;
        }
        .test-error {
            background-color: #2D0A0A;
            border: 1px solid #dc3545;
            color: #FF6B6B;
        }
        .test-info {
            background-color: #0A1929;
            border: 1px solid #0A84FF;
            color: #64D2FF;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-envelope me-2"></i>
                            New Email System Test Suite
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            This test suite validates the new email system implementation.
                            All tests use the new Netlify Function-based email service.
                        </p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h5>System Tests</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="testEmailServiceInit()">
                                        <i class="fas fa-cog me-1"></i>Test Service Initialization
                                    </button>
                                    <button class="btn btn-primary" onclick="testNetlifyFunction()">
                                        <i class="fas fa-server me-1"></i>Test Netlify Function
                                    </button>
                                    <button class="btn btn-primary" onclick="testTemplateManager()">
                                        <i class="fas fa-file-alt me-1"></i>Test Template Manager
                                    </button>
                                </div>
                                <div id="systemTestResults"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5>Email Tests</h5>
                                <div class="mb-3">
                                    <label for="testEmail" class="form-label">Test Email Address</label>
                                    <input type="email" class="form-control" id="testEmail" 
                                           value="rahulhitwo@gmail.com" placeholder="Enter email address">
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="sendTestEmail()">
                                        <i class="fas fa-paper-plane me-1"></i>Send Test Email
                                    </button>
                                    <button class="btn btn-success" onclick="sendWelcomeEmail()">
                                        <i class="fas fa-user-plus me-1"></i>Send Welcome Email
                                    </button>
                                    <button class="btn btn-success" onclick="sendContactConfirmation()">
                                        <i class="fas fa-comments me-1"></i>Send Contact Confirmation
                                    </button>
                                </div>
                                <div id="emailTestResults"></div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="row">
                            <div class="col-12">
                                <h5>Comprehensive Test</h5>
                                <button class="btn btn-warning w-100" onclick="runAllTests()">
                                    <i class="fas fa-play me-1"></i>Run All Tests
                                </button>
                                <div id="allTestResults"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../config/firebase-config.js"></script>
    <!-- EmailJS service scripts -->
    <script src="../components/emailjs-error-handler.js"></script>
    <script src="../components/emailjs-service.js"></script>
    
    <script>
        // Test Results Helper
        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            container.appendChild(resultDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Test Email Service Initialization
        async function testEmailServiceInit() {
            showResult('systemTestResults', 'Testing email service initialization...', 'info');
            
            try {
                if (!window.emailService) {
                    throw new Error('Email service not found');
                }
                
                const status = window.emailService.getStatus();
                showResult('systemTestResults', `Service status: ${JSON.stringify(status)}`, 'info');
                
                if (window.emailService.isInitialized) {
                    showResult('systemTestResults', '✅ Email service is initialized', 'success');
                } else {
                    showResult('systemTestResults', '⚠️ Email service not initialized, attempting init...', 'info');
                    const result = await window.emailService.init();
                    if (result) {
                        showResult('systemTestResults', '✅ Email service initialized successfully', 'success');
                    } else {
                        showResult('systemTestResults', '❌ Email service initialization failed', 'error');
                    }
                }
            } catch (error) {
                showResult('systemTestResults', `❌ Error: ${error.message}`, 'error');
            }
        }

        // Test Netlify Function
        async function testNetlifyFunction() {
            showResult('systemTestResults', 'Testing Netlify Function connectivity...', 'info');
            
            try {
                const response = await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'test',
                        to_email: 'test@example.com',
                        subject: 'Connectivity Test',
                        html_content: '<p>Test</p>'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult('systemTestResults', `✅ Netlify Function responding: ${result.message}`, 'success');
                } else {
                    showResult('systemTestResults', `❌ Netlify Function error: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('systemTestResults', `❌ Network error: ${error.message}`, 'error');
            }
        }

        // Test Template Manager
        function testTemplateManager() {
            showResult('systemTestResults', 'Testing template manager...', 'info');
            
            try {
                if (!window.emailTemplateManager) {
                    throw new Error('Template manager not found');
                }
                
                const templates = window.emailTemplateManager.getAvailableTemplates();
                showResult('systemTestResults', `Available templates: ${templates.join(', ')}`, 'info');
                
                // Test template rendering
                const testTemplate = window.emailTemplateManager.renderTemplate('test', {
                    testName: 'Test User',
                    testTime: new Date().toLocaleString()
                });
                
                if (testTemplate.subject && testTemplate.html) {
                    showResult('systemTestResults', '✅ Template rendering successful', 'success');
                } else {
                    showResult('systemTestResults', '❌ Template rendering failed', 'error');
                }
            } catch (error) {
                showResult('systemTestResults', `❌ Error: ${error.message}`, 'error');
            }
        }

        // Send Test Email
        async function sendTestEmail() {
            const email = document.getElementById('testEmail').value;
            if (!email) {
                showResult('emailTestResults', '❌ Please enter an email address', 'error');
                return;
            }

            showResult('emailTestResults', `Sending test welcome email to ${email}...`, 'info');

            try {
                if (!window.emailJSService || !window.emailJSService.isInitialized) {
                    throw new Error('EmailJS service not initialized');
                }

                const result = await window.emailJSService.sendWelcomeEmail(email, 'Test User', 'test-user-id');

                if (result.success) {
                    showResult('emailTestResults', `✅ Test email sent successfully! Message ID: ${result.messageId}`, 'success');
                } else {
                    showResult('emailTestResults', `❌ Test email failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('emailTestResults', `❌ Error: ${error.message}`, 'error');
            }
        }

        // Send Welcome Email
        async function sendWelcomeEmail() {
            const email = document.getElementById('testEmail').value;
            if (!email) {
                showResult('emailTestResults', '❌ Please enter an email address', 'error');
                return;
            }

            showResult('emailTestResults', `Sending welcome email to ${email}...`, 'info');

            try {
                if (!window.emailJSService || !window.emailJSService.isInitialized) {
                    throw new Error('EmailJS service not initialized');
                }

                const result = await window.emailJSService.sendWelcomeEmail(email, 'Test User', 'test-user-id');

                if (result.success) {
                    showResult('emailTestResults', `✅ Welcome email sent successfully! Message ID: ${result.messageId}`, 'success');
                } else {
                    showResult('emailTestResults', `❌ Welcome email failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('emailTestResults', `❌ Error: ${error.message}`, 'error');
            }
        }

        // Send Contact Confirmation (Note: Only welcome emails supported in EmailJS system)
        async function sendContactConfirmation() {
            const email = document.getElementById('testEmail').value;
            if (!email) {
                showResult('emailTestResults', '❌ Please enter an email address', 'error');
                return;
            }

            showResult('emailTestResults', `Contact confirmations not supported in EmailJS system. Sending welcome email instead...`, 'info');

            try {
                if (!window.emailJSService || !window.emailJSService.isInitialized) {
                    throw new Error('EmailJS service not initialized');
                }

                const result = await window.emailJSService.sendWelcomeEmail(email, 'Test User', 'test-contact-user');

                if (result.success) {
                    showResult('emailTestResults', `✅ Welcome email sent successfully! Message ID: ${result.messageId}`, 'success');
                } else {
                    showResult('emailTestResults', `❌ Email failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('emailTestResults', `❌ Error: ${error.message}`, 'error');
            }
        }

        // Run All Tests
        async function runAllTests() {
            showResult('allTestResults', '🚀 Starting comprehensive test suite...', 'info');
            
            // Clear previous results
            document.getElementById('systemTestResults').innerHTML = '';
            document.getElementById('emailTestResults').innerHTML = '';
            
            // Run system tests
            await testEmailServiceInit();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testNetlifyFunction();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            testTemplateManager();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Run email tests (only if email is provided)
            const email = document.getElementById('testEmail').value;
            if (email) {
                await sendTestEmail();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                await sendWelcomeEmail();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                await sendContactConfirmation();
            }
            
            showResult('allTestResults', '✅ Comprehensive test suite completed!', 'success');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            showResult('allTestResults', 'Email system test suite loaded. Ready for testing.', 'info');
        });
    </script>
</body>
</html>
