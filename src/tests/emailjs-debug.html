<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmailJS Debug - Quick Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0D1117;
            color: #F0F6FC;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .card {
            background-color: #161B22;
            border: 1px solid #30363D;
        }
        .form-control {
            background-color: #21262D;
            border: 1px solid #30363D;
            color: #F0F6FC;
        }
        .form-control:focus {
            background-color: #21262D;
            border-color: #58A6FF;
            color: #F0F6FC;
            box-shadow: 0 0 0 0.25rem rgba(88, 166, 255, 0.25);
        }
        .btn-primary {
            background-color: #238636;
            border-color: #238636;
        }
        .debug-output {
            background-color: #0D1117;
            border: 1px solid #30363D;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #3FB950; }
        .error { color: #F85149; }
        .warning { color: #D29922; }
        .info { color: #58A6FF; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">üìß EmailJS Debug Tool</h4>
                        <small class="text-muted">Quick debugging for EmailJS configuration issues</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="testEmail" class="form-label">Test Email Address</label>
                            <input type="email" class="form-control" id="testEmail" 
                                   value="rahulhitwo@gmail.com" placeholder="Enter your email">
                        </div>
                        
                        <div class="d-grid gap-2 mb-4">
                            <button class="btn btn-primary" onclick="runDiagnostics()">
                                üîç Run Full Diagnostics
                            </button>
                            <button class="btn btn-success" onclick="testEmailSending()">
                                üìß Test Email Sending
                            </button>
                            <button class="btn btn-warning" onclick="clearOutput()">
                                üóëÔ∏è Clear Output
                            </button>
                        </div>

                        <div class="debug-output" id="debugOutput">
                            <div class="info">Ready to run diagnostics...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="../config/firebase-config.js"></script>
    
    <!-- EmailJS Components -->
    <script src="../components/emailjs-error-handler.js"></script>
    <script src="../components/emailjs-service.js"></script>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('debugOutput').innerHTML = '<div class="info">Output cleared...</div>';
        }

        async function runDiagnostics() {
            log('üîç Starting EmailJS diagnostics...', 'info');
            
            // Check 1: EmailJS Library
            log('1. Checking EmailJS library...', 'info');
            if (typeof emailjs !== 'undefined') {
                log('‚úÖ EmailJS library loaded', 'success');
            } else {
                log('‚ùå EmailJS library not found', 'error');
                log('Attempting to load EmailJS...', 'warning');
                try {
                    await window.emailJSService.loadEmailJS();
                    log('‚úÖ EmailJS library loaded successfully', 'success');
                } catch (error) {
                    log(`‚ùå Failed to load EmailJS: ${error.message}`, 'error');
                    return;
                }
            }

            // Check 2: EmailJS Service
            log('2. Checking EmailJS service...', 'info');
            if (window.emailJSService) {
                log('‚úÖ EmailJS service found', 'success');
                log(`Service ID: ${window.emailJSService.serviceId}`, 'info');
                log(`Template ID: ${window.emailJSService.templateId}`, 'info');
                log(`Public Key: ${window.emailJSService.publicKey.substring(0, 8)}...`, 'info');
            } else {
                log('‚ùå EmailJS service not found', 'error');
                return;
            }

            // Check 3: Service Initialization
            log('3. Checking service initialization...', 'info');
            if (window.emailJSService.isInitialized) {
                log('‚úÖ EmailJS service already initialized', 'success');
            } else {
                log('‚è≥ Initializing EmailJS service...', 'warning');
                try {
                    const result = await window.emailJSService.init();
                    if (result) {
                        log('‚úÖ EmailJS service initialized successfully', 'success');
                    } else {
                        log('‚ùå EmailJS service initialization failed', 'error');
                        return;
                    }
                } catch (error) {
                    log(`‚ùå Initialization error: ${error.message}`, 'error');
                    return;
                }
            }

            // Check 4: Error Handler
            log('4. Checking error handler...', 'info');
            if (window.emailJSErrorHandler) {
                log('‚úÖ Error handler loaded', 'success');
            } else {
                log('‚ö†Ô∏è Error handler not found (optional)', 'warning');
            }

            // Check 5: Firebase
            log('5. Checking Firebase connection...', 'info');
            if (typeof firebase !== 'undefined') {
                log('‚úÖ Firebase loaded', 'success');
                try {
                    const db = firebase.firestore();
                    await db.collection('test').limit(1).get();
                    log('‚úÖ Firebase connection working', 'success');
                } catch (error) {
                    log(`‚ö†Ô∏è Firebase connection issue: ${error.message}`, 'warning');
                }
            } else {
                log('‚ö†Ô∏è Firebase not loaded', 'warning');
            }

            log('üéâ Diagnostics complete!', 'success');
        }

        async function testEmailSending() {
            const email = document.getElementById('testEmail').value.trim();
            if (!email) {
                log('‚ùå Please enter a test email address', 'error');
                return;
            }

            log(`üìß Testing email sending to ${email}...`, 'info');

            try {
                // First ensure service is initialized
                if (!window.emailJSService.isInitialized) {
                    log('‚è≥ Initializing service...', 'warning');
                    await window.emailJSService.init();
                }

                // Try sending email
                log('‚è≥ Sending test email...', 'warning');
                const result = await window.emailJSService.sendWelcomeEmail(email, 'Debug Test User', 'debug-test-id');

                if (result.success) {
                    log(`‚úÖ Email sent successfully!`, 'success');
                    log(`Message ID: ${result.messageId}`, 'info');
                    log(`Provider: ${result.provider}`, 'info');
                } else {
                    log(`‚ùå Email sending failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error during email sending: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
            }
        }

        // Auto-run diagnostics on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ EmailJS Debug Tool loaded', 'success');
            log('Click "Run Full Diagnostics" to check your configuration', 'info');
        });
    </script>
</body>
</html>
