<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Form Debug - lowrybunks</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../styles/style.css">
    <style>
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .debug-section {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .debug-title {
            color: var(--accent-primary);
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .debug-log {
            background-color: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            white-space: pre-wrap;
        }

        .debug-button {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        .debug-button:hover {
            transform: translateY(-1px);
        }

        .debug-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-warning { background-color: #fbbf24; }
        .status-info { background-color: #3b82f6; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="debug-container">
        <h1 style="text-align: center; color: var(--accent-primary); margin-bottom: 30px;">
            <i class="fas fa-bug me-2"></i>Contact Form Debug Tool
        </h1>

        <div class="two-column">
            <!-- Debug Test Form -->
            <div class="debug-section">
                <h2 class="debug-title"><i class="fas fa-envelope me-2"></i>Test Contact Form</h2>
                
                <form id="debugContactForm">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" id="debugName" class="form-input" value="Debug Test User" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="debugEmail" class="form-input" value="rahulhitwo@gmail.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <select id="debugSubject" class="form-select" required>
                            <option value="technical-support">Technical Support</option>
                            <option value="bug-report">Bug Report</option>
                            <option value="feature-request">Feature Request</option>
                            <option value="general">General Inquiry</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea id="debugMessage" class="form-textarea" rows="4" required>This is a debug test message to verify the contact form functionality and Firebase integration.</textarea>
                    </div>
                    
                    <button type="submit" class="debug-button" id="submitDebugForm">
                        <i class="fas fa-paper-plane me-1"></i>Submit Test Form
                    </button>
                </form>
            </div>

            <!-- Debug Controls -->
            <div class="debug-section">
                <h2 class="debug-title"><i class="fas fa-cogs me-2"></i>Debug Controls</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="debug-button" onclick="testFirebaseConnection()">
                        <i class="fas fa-database me-1"></i>Test Firebase
                    </button>
                    <button class="debug-button" onclick="testEmailService()">
                        <i class="fas fa-envelope me-1"></i>Test Email Service
                    </button>
                    <button class="debug-button" onclick="loadContactSubmissions()">
                        <i class="fas fa-list me-1"></i>Load Submissions
                    </button>
                    <button class="debug-button" onclick="clearDebugLog()">
                        <i class="fas fa-trash me-1"></i>Clear Log
                    </button>
                </div>

                <!-- Status Indicators -->
                <div style="margin-bottom: 20px;">
                    <div><span class="status-indicator status-info" id="firebaseStatus"></span>Firebase: <span id="firebaseStatusText">Not tested</span></div>
                    <div><span class="status-indicator status-info" id="emailStatus"></span>Email Service: <span id="emailStatusText">Not tested</span></div>
                    <div><span class="status-indicator status-info" id="submissionStatus"></span>Form Submission: <span id="submissionStatusText">Not tested</span></div>
                </div>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="debug-section">
            <h2 class="debug-title"><i class="fas fa-terminal me-2"></i>Debug Log</h2>
            <div id="debugLog" class="debug-log">Debug log will appear here...\n</div>
        </div>

        <!-- Contact Submissions Display -->
        <div class="debug-section">
            <h2 class="debug-title"><i class="fas fa-table me-2"></i>Contact Submissions</h2>
            <div id="submissionsDisplay">
                <p>Click "Load Submissions" to view stored contact form submissions.</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBl4gC04HoBGzttBrNtVYu0-xWCzI9qYc0",
            authDomain: "attendance-a9a19.firebaseapp.com",
            databaseURL: "https://attendance-a9a19-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "attendance-a9a19",
            storageBucket: "attendance-a9a19.appspot.com",
            messagingSenderId: "1055787262218",
            appId: "1:1055787262218:web:c0c9c33d771456888d5af3",
            measurementId: "G-3XPB4VLFYH"
        };

        // Initialize Firebase
        let app, auth, db;
        
        function logDebug(message, type = 'info') {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'ℹ️',
                'success': '✅',
                'error': '❌',
                'warning': '⚠️'
            };
            
            debugLog.textContent += `[${timestamp}] ${typeIcon[type]} ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function updateStatus(statusId, textId, status, text) {
            const statusElement = document.getElementById(statusId);
            const textElement = document.getElementById(textId);
            
            statusElement.className = `status-indicator status-${status}`;
            textElement.textContent = text;
        }

        function clearDebugLog() {
            document.getElementById('debugLog').textContent = 'Debug log cleared...\n';
        }

        // Initialize Firebase
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = firebase.auth();
            db = firebase.firestore();
            logDebug('Firebase initialized successfully', 'success');
        } catch (error) {
            logDebug(`Firebase initialization failed: ${error.message}`, 'error');
        }

        // Test Firebase Connection
        async function testFirebaseConnection() {
            logDebug('Testing Firebase connection...', 'info');

            try {
                if (!db) {
                    throw new Error('Firebase not initialized');
                }

                // Test basic Firestore operation
                const testDoc = await db.collection('test').doc('connection-test').get();
                logDebug('Firebase connection successful', 'success');
                updateStatus('firebaseStatus', 'firebaseStatusText', 'success', 'Connected');

                // Test contactSubmissions collection access
                const contactsRef = db.collection('contactSubmissions');
                const snapshot = await contactsRef.limit(1).get();
                logDebug(`Contact submissions collection accessible. Found ${snapshot.size} documents`, 'success');

            } catch (error) {
                logDebug(`Firebase connection failed: ${error.message}`, 'error');
                updateStatus('firebaseStatus', 'firebaseStatusText', 'error', 'Failed');
            }
        }

        // Test Email Service
        async function testEmailService() {
            logDebug('Testing email service...', 'info');

            try {
                const testEmailData = {
                    to_email: 'rahulhitwo@gmail.com',
                    to_name: 'Debug Test',
                    subject: 'Email Service Test - lowrybunks',
                    html_content: '<p>This is a test email to verify the email service is working.</p>',
                    from_name: 'lowrybunks Team',
                    from_email: 'website.po45@gmail.com'
                };

                logDebug('Attempting to send test email...', 'info');

                // Try to send email
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testEmailData)
                });

                if (response.ok) {
                    const result = await response.json();
                    logDebug('Email service test successful', 'success');
                    updateStatus('emailStatus', 'emailStatusText', 'success', 'Working');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                logDebug(`Email service test failed: ${error.message}`, 'error');
                updateStatus('emailStatus', 'emailStatusText', 'error', 'Failed');

                // Try alternative email service endpoint
                logDebug('Trying alternative email endpoint...', 'warning');
                try {
                    const altResponse = await fetch('../api/send-email.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            to_email: 'rahulhitwo@gmail.com',
                            subject: 'PHP Email Test',
                            message: 'Testing PHP email service'
                        })
                    });

                    if (altResponse.ok) {
                        logDebug('Alternative PHP email service working', 'success');
                        updateStatus('emailStatus', 'emailStatusText', 'warning', 'PHP Service Available');
                    }
                } catch (altError) {
                    logDebug(`Alternative email service also failed: ${altError.message}`, 'error');
                }
            }
        }

        // Load Contact Submissions
        async function loadContactSubmissions() {
            logDebug('Loading contact submissions...', 'info');

            try {
                if (!db) {
                    throw new Error('Firebase not initialized');
                }

                const snapshot = await db.collection('contactSubmissions')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();

                logDebug(`Found ${snapshot.size} contact submissions`, 'success');

                const submissionsDisplay = document.getElementById('submissionsDisplay');

                if (snapshot.empty) {
                    submissionsDisplay.innerHTML = '<p style="color: #fbbf24;">No contact submissions found in Firebase.</p>';
                    logDebug('No contact submissions found in database', 'warning');
                } else {
                    let html = '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<tr style="background-color: var(--bg-tertiary);"><th style="padding: 8px; border: 1px solid var(--border-color);">Name</th><th style="padding: 8px; border: 1px solid var(--border-color);">Email</th><th style="padding: 8px; border: 1px solid var(--border-color);">Subject</th><th style="padding: 8px; border: 1px solid var(--border-color);">Date</th><th style="padding: 8px; border: 1px solid var(--border-color);">Status</th></tr>';

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const timestamp = data.timestamp ? data.timestamp.toDate().toLocaleString() : 'Unknown';
                        html += `<tr>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">${data.name || 'N/A'}</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">${data.email || 'N/A'}</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">${data.subject || 'N/A'}</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">${timestamp}</td>
                            <td style="padding: 8px; border: 1px solid var(--border-color);">${data.status || 'N/A'}</td>
                        </tr>`;
                    });

                    html += '</table>';
                    submissionsDisplay.innerHTML = html;
                }

            } catch (error) {
                logDebug(`Failed to load contact submissions: ${error.message}`, 'error');
                document.getElementById('submissionsDisplay').innerHTML = `<p style="color: #ef4444;">Error loading submissions: ${error.message}</p>`;
            }
        }

        // Form Validation
        function validateDebugForm(data) {
            const errors = [];

            if (!data.name || data.name.length < 2) {
                errors.push('Name must be at least 2 characters');
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!data.email || !emailRegex.test(data.email)) {
                errors.push('Invalid email address');
            }

            if (!data.subject) {
                errors.push('Subject is required');
            }

            if (!data.message || data.message.length < 10) {
                errors.push('Message must be at least 10 characters');
            }

            return errors;
        }

        // Debug Form Submission
        document.getElementById('debugContactForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = document.getElementById('submitDebugForm');
            const originalText = submitButton.innerHTML;

            logDebug('Starting debug form submission...', 'info');

            try {
                // Disable submit button
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';

                // Get form data
                const formData = {
                    name: document.getElementById('debugName').value.trim(),
                    email: document.getElementById('debugEmail').value.trim(),
                    subject: document.getElementById('debugSubject').value.trim(),
                    message: document.getElementById('debugMessage').value.trim()
                };

                logDebug(`Form data: ${JSON.stringify(formData)}`, 'info');

                // Validate form
                const validationErrors = validateDebugForm(formData);
                if (validationErrors.length > 0) {
                    throw new Error('Validation failed: ' + validationErrors.join(', '));
                }

                logDebug('Form validation passed', 'success');

                // Prepare contact data for Firebase
                const contactData = {
                    name: formData.name,
                    email: formData.email,
                    subject: formData.subject,
                    message: formData.message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'unread',
                    resolved: false,
                    userAgent: navigator.userAgent,
                    ipAddress: 'debug-test',
                    submissionId: null
                };

                logDebug('Attempting to save to Firebase...', 'info');

                // Save to Firestore
                const docRef = await db.collection('contactSubmissions').add(contactData);
                logDebug(`Successfully saved to Firebase with ID: ${docRef.id}`, 'success');

                // Update with document ID
                await docRef.update({ submissionId: docRef.id });
                logDebug('Document ID updated successfully', 'success');

                updateStatus('submissionStatus', 'submissionStatusText', 'success', 'Successful');

                // Try to send confirmation email
                logDebug('Attempting to send confirmation email...', 'info');

                try {
                    const emailData = {
                        to_email: formData.email,
                        to_name: formData.name,
                        subject: 'Contact Form Confirmation - lowrybunks',
                        html_content: `
                            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                                <h2>Thank you for contacting us!</h2>
                                <p>Dear ${formData.name},</p>
                                <p>We have received your message and will get back to you soon.</p>
                                <p><strong>Your message:</strong></p>
                                <div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px;">
                                    ${formData.message}
                                </div>
                                <p>Best regards,<br>The lowrybunks Team</p>
                            </div>
                        `,
                        from_name: 'lowrybunks Team',
                        from_email: 'website.po45@gmail.com'
                    };

                    const emailResponse = await fetch('/api/send-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(emailData)
                    });

                    if (emailResponse.ok) {
                        logDebug('Confirmation email sent successfully', 'success');
                    } else {
                        throw new Error(`Email failed: ${emailResponse.status}`);
                    }

                } catch (emailError) {
                    logDebug(`Email sending failed: ${emailError.message}`, 'warning');
                }

                logDebug('Form submission completed successfully!', 'success');

                // Reload submissions to show the new entry
                setTimeout(() => {
                    loadContactSubmissions();
                }, 1000);

            } catch (error) {
                logDebug(`Form submission failed: ${error.message}`, 'error');
                updateStatus('submissionStatus', 'submissionStatusText', 'error', 'Failed');
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        });

        // Auto-run initial tests
        window.addEventListener('load', function() {
            setTimeout(() => {
                testFirebaseConnection();
                loadContactSubmissions();
            }, 1000);
        });
    </script>
</body>
</html>
