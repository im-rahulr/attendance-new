<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Attendly</title>
    <meta name="description" content="Comprehensive admin panel for attendance management with user profiles, reporting, and system monitoring">
    <meta name="keywords" content="admin, attendance, management, reporting, analytics">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="../styles/admin-enhanced.css">

    <!-- Immediate Error Suppression -->
    <script>
        // Comprehensive error suppression for browser extensions and inspector
        (function() {
            const originalError = console.error;
            const originalWarn = console.warn;
            const originalLog = console.log;

            // Enhanced error message filtering
            const shouldSuppressMessage = (message) => {
                const suppressPatterns = [
                    'Minified React error',
                    'chrome-extension:',
                    'moz-extension:',
                    'safari-extension:',
                    'inspector',
                    'contentScript',
                    'Extension context invalidated',
                    'inspector.js',
                    'Uncaught Error: Minified React error',
                    'Cannot access contents of',
                    'Script error',
                    'Non-Error promise rejection captured',
                    'ResizeObserver loop limit exceeded',
                    'Failed to execute \'postMessage\'',
                    'SecurityError: Blocked a frame',
                    'The operation was aborted',
                    'NetworkError when attempting to fetch resource'
                ];

                return suppressPatterns.some(pattern =>
                    message.toLowerCase().includes(pattern.toLowerCase())
                );
            };

            console.error = function(...args) {
                const message = args.join(' ');
                if (shouldSuppressMessage(message)) {
                    return; // Suppress these errors
                }
                originalError.apply(console, args);
            };

            console.warn = function(...args) {
                const message = args.join(' ');
                if (shouldSuppressMessage(message)) {
                    return; // Suppress these warnings
                }
                originalWarn.apply(console, args);
            };

            // Global error suppression with enhanced filtering
            window.addEventListener('error', function(e) {
                const msg = e.error?.message || e.message || e.filename || '';
                if (shouldSuppressMessage(msg) ||
                    e.filename?.includes('extension') ||
                    e.filename?.includes('inspector')) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true);

            // Enhanced promise rejection suppression
            window.addEventListener('unhandledrejection', function(e) {
                const msg = String(e.reason?.message || e.reason || '');
                if (shouldSuppressMessage(msg)) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            });

            // Suppress specific DOM errors
            const originalAddEventListener = EventTarget.prototype.addEventListener;
            EventTarget.prototype.addEventListener = function(type, listener, options) {
                try {
                    return originalAddEventListener.call(this, type, listener, options);
                } catch (error) {
                    if (shouldSuppressMessage(error.message)) {
                        return;
                    }
                    throw error;
                }
            };
        })();
    </script>
    <style>
        :root {
            /* Enhanced Professional Color System */
            --primary: var(--primary-solid);
            --primary-light: var(--primary-light);
            --secondary: var(--success-solid);
            --background: var(--bg-gradient-primary);
            --card-bg: var(--bg-gradient-card);
            --border-radius: var(--radius-lg);
            --shadow: var(--shadow-md);
            --text-main: var(--neutral-900);
            --text-muted: var(--neutral-600);
            --text-secondary: var(--neutral-700);
            --accent: var(--accent-orange);
            --success: var(--success-solid);
            --warning: var(--warning-solid);
            --danger: var(--error-solid);
            --info: var(--info-solid);
            --border-color: var(--neutral-300);
            --separator: var(--neutral-200);
            --input-bg: var(--neutral-50);
            --input-border: var(--neutral-300);
            --hover-bg: var(--neutral-100);
            --active-bg: var(--neutral-200);

            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Spacing - Using enhanced system */
            --spacing-xs: var(--space-xs);
            --spacing-sm: var(--space-sm);
            --spacing-md: var(--space-md);
            --spacing-lg: var(--space-lg);
            --spacing-xl: var(--space-xl);
        }


        
        /* Loader Animation */
        .loader {
            --background: linear-gradient(135deg, var(--primary), var(--primary-light));
            --shadow: rgba(10, 132, 255, 0.28);
            --text: var(--text-muted);
            --page: rgba(240, 246, 252, 0.36);
            --page-fold: rgba(240, 246, 252, 0.52);
            --duration: 3s;
            width: 200px;
            height: 140px;
            position: relative;
        }

        .loader:before, .loader:after {
            --r: -6deg;
            content: "";
            position: absolute;
            bottom: 8px;
            width: 120px;
            top: 80%;
            box-shadow: 0 16px 12px var(--shadow);
            transform: rotate(var(--r));
        }

        .loader:before {
            left: 4px;
        }

        .loader:after {
            --r: 6deg;
            right: 4px;
        }

        .loader div {
            width: 100%;
            height: 100%;
            border-radius: 13px;
            position: relative;
            z-index: 1;
            perspective: 600px;
            box-shadow: 0 4px 6px var(--shadow);
            background-image: var(--background);
        }

        .loader div ul {
            margin: 0;
            padding: 0;
            list-style: none;
            position: relative;
        }

        .loader div ul li {
            --r: 180deg;
            --o: 0;
            --c: var(--page);
            position: absolute;
            top: 10px;
            left: 10px;
            transform-origin: 100% 50%;
            color: var(--c);
            opacity: var(--o);
            transform: rotateY(var(--r));
            -webkit-animation: var(--duration) ease infinite;
            animation: var(--duration) ease infinite;
        }

        .loader div ul li:nth-child(2) {
            --c: var(--page-fold);
            -webkit-animation-name: page-2;
            animation-name: page-2;
        }

        .loader div ul li:nth-child(3) {
            --c: var(--page-fold);
            -webkit-animation-name: page-3;
            animation-name: page-3;
        }

        .loader div ul li:nth-child(4) {
            --c: var(--page-fold);
            -webkit-animation-name: page-4;
            animation-name: page-4;
        }

        .loader div ul li:nth-child(5) {
            --c: var(--page-fold);
            -webkit-animation-name: page-5;
            animation-name: page-5;
        }

        .loader div ul li svg {
            width: 90px;
            height: 120px;
            display: block;
        }

        .loader div ul li:first-child {
            --r: 0deg;
            --o: 1;
        }

        .loader div ul li:last-child {
            --o: 1;
        }

        .loader-text {
            display: block;
            left: 0;
            right: 0;
            margin-top: 20px;
            text-align: center;
            color: var(--text);
            font-weight: 500;
        }
        
        @keyframes page-2 {
            0% { transform: rotateY(180deg); opacity: 0; }
            20% { opacity: 1; }
            35%, 100% { opacity: 0; }
            50%, 100% { transform: rotateY(0deg); }
        }

        @keyframes page-3 {
            15% { transform: rotateY(180deg); opacity: 0; }
            35% { opacity: 1; }
            50%, 100% { opacity: 0; }
            65%, 100% { transform: rotateY(0deg); }
        }

        @keyframes page-4 {
            30% { transform: rotateY(180deg); opacity: 0; }
            50% { opacity: 1; }
            65%, 100% { opacity: 0; }
            80%, 100% { transform: rotateY(0deg); }
        }

        @keyframes page-5 {
            45% { transform: rotateY(180deg); opacity: 0; }
            65% { opacity: 1; }
            80%, 100% { opacity: 0; }
            95%, 100% { transform: rotateY(0deg); }
        }

        body {
            background: var(--bg-gradient-primary);
            font-family: var(--font-family);
            color: var(--text-main);
            font-size: 16px;
            line-height: 1.47;
            font-weight: var(--font-weight-regular);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
        }
        .admin-header {
            background: var(--card-bg);
            color: var(--text-main);
            padding: var(--spacing-lg) 0;
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow);
            border-bottom: 1px solid var(--separator);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
        }
        .admin-header .container-fluid {
            max-width: 1400px;
        }
        .admin-header h2 {
            font-weight: 700;
            letter-spacing: 1px;
        }
        .btn-outline-light {
            border-radius: var(--border-radius);
            font-weight: var(--font-weight-medium);
            padding: var(--spacing-sm) var(--spacing-md);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .nav-pills {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            border: 1px solid var(--separator);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
        }
        .nav-pills .nav-link {
            color: var(--text-muted);
            font-weight: var(--font-weight-medium);
            border-radius: var(--border-radius);
            margin-right: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid transparent;
        }
        .nav-pills .nav-link:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }
        .nav-pills .nav-link.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            border: 1px solid var(--primary);
        }
        .card {
            border: 1px solid var(--separator);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            background: var(--card-bg);
            margin-bottom: var(--spacing-xl);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background: transparent;
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary);
        }
        .stat-card {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md) var(--spacing-lg) var(--spacing-md);
            border-radius: var(--border-radius);
            background: var(--card-bg);
            box-shadow: var(--shadow);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--separator);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        .stat-card .icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
            color: var(--primary);
            opacity: 0.9;
        }
        .stat-card h3 {
            font-size: 2rem;
            font-weight: var(--font-weight-bold);
            color: var(--text-main);
            margin-bottom: var(--spacing-xs);
        }
        .stat-card h5 {
            color: var(--text-muted);
            font-weight: var(--font-weight-medium);
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        .table {
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--separator);
            background: var(--card-bg);
        }
        .table {
            color: var(--text-main);
        }
        .table th {
            background: var(--hover-bg);
            color: var(--text-main);
            font-weight: var(--font-weight-semibold);
            border: none;
            border-bottom: 2px solid var(--border-color);
            padding: var(--spacing-md);
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        .table td {
            vertical-align: middle;
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--separator);
        }
        .table-hover tbody tr:hover {
            background: var(--hover-bg);
            transition: background-color 0.15s ease-in-out;
        }
        .table-striped > tbody > tr:nth-of-type(odd) > td,
        .table-striped > tbody > tr:nth-of-type(odd) > th {
            background-color: rgba(255, 255, 255, 0.02);
        }
        /* Enhanced Button Integration */
        .btn-primary, .btn-info, .btn-success, .btn-warning, .btn-danger {
            border-radius: var(--radius-lg);
            font-weight: 600;
            padding: var(--space-sm) var(--space-lg);
            border: none;
            transition: all var(--duration-normal) var(--easing-smooth);
            font-family: var(--font-family);
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
        }
        
        /* Enhanced Primary Button */
        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-md), 0 0 0 1px var(--primary-alpha-20);
        }
        .btn-primary:hover {
            background: var(--primary-gradient-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            color: white;
        }
        
        /* Enhanced Info Button */
        .btn-info {
            background: var(--info-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-info:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 0 20px var(--info-alpha-30);
            color: white;
        }
        
        /* Enhanced Success Button */
        .btn-success {
            background: var(--success-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 0 20px var(--success-alpha-30);
            color: white;
        }
        
        /* Enhanced Warning Button */
        .btn-warning {
            background: var(--warning-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 0 20px var(--warning-alpha-30);
            color: white;
        }
        
        /* Enhanced Danger Button */
        .btn-danger {
            background: var(--error-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 0 20px var(--error-alpha-30);
            color: white;
        }
        
        /* Shimmer Effect for All Buttons */
        .btn-primary::before, .btn-info::before, .btn-success::before, 
        .btn-warning::before, .btn-danger::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left var(--duration-slow) var(--easing-smooth);
            z-index: 1;
        }
        
        .btn-primary:hover::before, .btn-info:hover::before, .btn-success:hover::before,
        .btn-warning:hover::before, .btn-danger:hover::before {
            left: 100%;
        }
        
        .btn-primary > *, .btn-info > *, .btn-success > *,
        .btn-warning > *, .btn-danger > * {
            position: relative;
            z-index: 2;
      
        .progress {
            background: var(--hover-bg);
            border-radius: 8px;
            height: 20px;
        }
        .progress-bar {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            font-weight: 600;
        }
        .list-group-item {
            border: none;
            border-radius: 8px;
            margin-bottom: 8px;
            background: var(--hover-bg);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }
        .list-group-item:last-child {
            margin-bottom: 0;
        }

        /* Apple-inspired Form Controls */
        .form-control, .form-select {
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-sm) var(--spacing-md);
            font-family: var(--font-family);
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-main);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(10, 132, 255, 0.25);
            outline: none;
            background: var(--input-bg);
        }
        .form-control::placeholder {
            color: var(--text-muted);
        }
        .form-label {
            font-weight: var(--font-weight-medium);
            color: var(--text-main);
            margin-bottom: var(--spacing-xs);
        }
        .modal-header {
            background: var(--primary);
            color: #fff;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-lg);
        }
        .modal-content {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            background: var(--card-bg);
            color: var(--text-main);
        }
        .modal-body {
            padding: var(--spacing-lg);
        }
        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: var(--spacing-lg);
        }
        .toast {
            border-radius: 10px;
            font-weight: 500;
        }

        /* Additional Dark Theme Styles */
        .navbar {
            background-color: var(--card-bg) !important;
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand,
        .navbar-nav .nav-link {
            color: var(--text-main) !important;
        }

        .btn-outline-primary {
            color: var(--primary);
            border-color: var(--primary);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .btn-outline-light {
            color: #e6edf3;
            border-color: var(--border-color);
        }

        .btn-outline-light:hover {
            background-color: var(--hover-bg);
            border-color: var(--border-color);
            color: #fff;
        }

        .nav-tabs .nav-link {
            color: var(--text-muted);
            border-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--text-main);
            background-color: var(--card-bg);
            border-color: var(--border-color) var(--border-color) var(--card-bg);
        }

        .nav-tabs {
            border-bottom: 1px solid var(--border-color);
        }

        .badge {
            color: #fff;
        }

        .badge.bg-primary {
            background-color: var(--primary) !important;
        }

        .badge.bg-success {
            background-color: var(--success) !important;
        }

        .badge.bg-warning {
            background-color: var(--warning) !important;
            color: #000 !important;
        }

        .badge.bg-danger {
            background-color: var(--danger) !important;
        }

        .dropdown-menu {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        .dropdown-item {
            color: var(--text-main);
        }

        .dropdown-item:hover {
            background-color: var(--hover-bg);
            color: var(--text-main);
        }

        .border {
            border-color: var(--border-color) !important;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .alert-info {
            background-color: rgba(31, 111, 235, 0.1);
            border-color: rgba(31, 111, 235, 0.2);
            color: var(--info);
        }

        .alert-success {
            background-color: rgba(35, 134, 54, 0.1);
            border-color: rgba(35, 134, 54, 0.2);
            color: var(--success);
        }

        .alert-warning {
            background-color: rgba(210, 153, 34, 0.1);
            border-color: rgba(210, 153, 34, 0.2);
            color: var(--warning);
        }

        .alert-danger {
            background-color: rgba(218, 54, 51, 0.1);
            border-color: rgba(218, 54, 51, 0.2);
            color: var(--danger);
        }

        /* Enhanced Reports Styling */
        .avatar-sm {
            width: 32px;
            height: 32px;
            font-size: 14px;
        }

        .progress {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .table-hover tbody tr:hover {
            background-color: var(--hover-bg);
        }

        .nav-pills .nav-link {
            color: var(--text-main);
            background-color: transparent;
            border: 1px solid var(--border-color);
            margin-right: 0.25rem;
        }

        .nav-pills .nav-link.active {
            background-color: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .nav-pills .nav-link:hover {
            background-color: var(--hover-bg);
            border-color: var(--border-color);
        }

        .card.bg-primary, .card.bg-success, .card.bg-warning, .card.bg-danger, .card.bg-info {
            border: none;
        }

        .btn-group .btn {
            border-color: var(--border-color);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(31, 111, 235, 0.25);
        }

        .table-dark {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }

        .table-dark th {
            background-color: rgba(0, 0, 0, 0.3);
            border-color: var(--border-color);
            color: var(--text-main);
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        @media (max-width: 991px) {
            .stat-card { margin-bottom: 1rem; }
        }
        @media (max-width: 767px) {
            .admin-header, .admin-container { padding: 0 10px; }
            .stat-card { padding: 1.2rem 0.5rem 1rem 0.5rem; }
        }
    </style>
</head>
<body>
    <script>
        // Ensure we're on the admin page
        if (window.location.pathname !== '/admin.html' && 
            window.location.pathname !== '/admin' && 
            !window.location.pathname.endsWith('/admin.html') && 
            !window.location.pathname.endsWith('/admin')) {
            console.log('Redirecting to admin page...');
            window.location.href = '/admin.html';
        }
    </script>
    <div class="admin-header">
        <div class="container-fluid admin-container">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0"><i class="fas fa-user-shield me-2"></i>Attendly</h2>
                <div class="d-flex align-items-center gap-2">
                    <div id="systemHealthStatus" class="me-2">
                        <span class="badge bg-secondary">
                            <i class="fas fa-heartbeat me-1"></i>System Health: Checking...
                        </span>
                    </div>

                    <button id="logoutBtn" class="btn btn-outline-light"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="d-flex justify-content-center align-items-center" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(13,17,23,0.9); z-index: 1056; display: none !important;">
        <div class="loader">
            <div>
                <ul>
                    <li>
                        <svg fill="currentColor" viewBox="0 0 90 120">
                            <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                        </svg>
                    </li>
                    <li>
                        <svg fill="currentColor" viewBox="0 0 90 120">
                            <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                        </svg>
                    </li>
                    <li>
                        <svg fill="currentColor" viewBox="0 0 90 120">
                            <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                        </svg>
                    </li>
                    <li>
                        <svg fill="currentColor" viewBox="0 0 90 120">
                            <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                        </svg>
                    </li>
                    <li>
                        <svg fill="currentColor" viewBox="0 0 90 120">
                            <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                        </svg>
                    </li>
                    <li>
                        <svg fill="currentColor" viewBox="0 0 90 120">
                            <path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path>
                        </svg>
                    </li>
                </ul>
            </div>
        </div>
        <p class="mt-2 loader-text" id="loadingText">Loading...</p>
    </div>
    
    <div class="container admin-container">
        <!-- Login Form (shown if not authenticated) -->
        <div id="adminLoginContainer" style="display:none;">
            <div class="card mx-auto" style="max-width: 450px; margin-top: 50px;">
                <div class="card-header text-center">
                    <h4 class="mb-0"><i class="fas fa-lock me-2"></i>Admin Login</h4>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-info">
                        <strong>Admin Access Required</strong><br>
                        Only administrators can access this page.<br>
                        <small>Current admin emails: admin@admin.com, admin@example.com, administrator@attendance.com</small>
                    </div>
                    <div class="mb-3">
                        <label for="adminEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="adminEmail" placeholder="admin@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="adminPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="password">
                    </div>
                    <button id="adminLoginBtn" class="btn btn-primary w-100">Login</button>
                    <div id="loginError" class="mt-3 text-danger" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard (shown if authenticated) -->
        <div id="adminDashboard" style="display:none;">
             <ul class="nav nav-pills" id="admin-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-content" type="button" role="tab" aria-controls="dashboard-content" aria-selected="true"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-content" type="button" role="tab" aria-controls="users-content" aria-selected="false"><i class="fas fa-users me-2"></i>Users</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="subjects-tab" data-bs-toggle="tab" data-bs-target="#subjects-content" type="button" role="tab" aria-controls="subjects-content" aria-selected="false"><i class="fas fa-book me-2"></i>Subjects</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="userLogs-tab" data-bs-toggle="tab" data-bs-target="#userLogs" type="button" role="tab" aria-controls="userLogs" aria-selected="false"><i class="fas fa-history me-2"></i>User Logs</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="deleted-tab" data-bs-toggle="tab" data-bs-target="#deleted-content" type="button" role="tab" aria-controls="deleted-content" aria-selected="false"><i class="fas fa-trash-alt me-2"></i>Deleted Reports</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance-content" type="button" role="tab" aria-controls="attendance-content" aria-selected="false"><i class="fas fa-calendar-check me-2"></i>Attendance</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports-content" type="button" role="tab" aria-controls="reports-content" aria-selected="false"><i class="fas fa-chart-bar me-2"></i>Reports</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications-content" type="button" role="tab" aria-controls="notifications-content" aria-selected="false"><i class="fas fa-bell me-2"></i>Notifications</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="functions-tab" data-bs-toggle="tab" data-bs-target="#functions-content" type="button" role="tab" aria-controls="functions-content" aria-selected="false"><i class="fas fa-cogs me-2"></i>Functions</button>
                </li>
                <!-- <li class="nav-item" role="presentation">
                    <button class="nav-link" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors-content" type="button" role="tab" aria-controls="errors-content" aria-selected="false"><i class="fas fa-exclamation-triangle me-2"></i>Error Logs</button>
                </li> -->

                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="email-system-tab" data-bs-toggle="tab" data-bs-target="#email-system-content" type="button" role="tab" aria-controls="email-system-content" aria-selected="false"><i class="fas fa-envelope me-2"></i>Email System</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="contact-submissions-tab" data-bs-toggle="tab" data-bs-target="#contact-submissions-content" type="button" role="tab" aria-controls="contact-submissions-content" aria-selected="false"><i class="fas fa-comments me-2"></i>Contact Submissions</button>
                </li>
            </ul>

            <div class="tab-content" id="admin-tabs-content">
                <!-- Dashboard Content -->
                <div class="tab-pane fade show active" id="dashboard-content" role="tabpanel" aria-labelledby="dashboard-tab">
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="icon"><i class="fas fa-users"></i></div>
                                <h3 id="totalUsersStat">0</h3>
                                <h5>Total Users</h5>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="icon"><i class="fas fa-chart-pie"></i></div>
                                <h3 id="avgAttendanceStat">0%</h3>
                                <h5>Avg. Attendance</h5>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="icon"><i class="fas fa-book"></i></div>
                                <h3 id="totalSubjectsStat">0</h3>
                                <h5>Total Subjects</h5>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title mb-4">Attendance Overview</h5>
                                    <div style="min-height:320px;">
                                        <canvas id="attendanceChart" style="max-height:320px;"></canvas>
                                        <div id="attendanceChartFallback" class="text-center text-muted mt-4" style="display:none;">No attendance data available</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Analytics Charts -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>User Activity Trends
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="userActivityChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Error Frequency
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="errorFrequencyChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-tasks me-2"></i>Project Activity
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="projectActivityChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-globe me-2"></i>User Geographic Distribution
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="geographicChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Content -->
                <div class="tab-pane fade" id="users-content" role="tabpanel" aria-labelledby="users-tab">
                    <!-- Add User Button -->
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="fas fa-user-plus me-2"></i>Add New User
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">All Users</h5>
                            <div>
                                <div class="btn-group me-2">
                                    <button id="exportExcelBtn" class="btn btn-sm btn-success">
                                        <i class="fas fa-file-excel me-1"></i> Excel
                                    </button>
                                    <button id="exportUsersPDFBtn" class="btn btn-sm btn-danger">
                                        <i class="fas fa-file-pdf me-1"></i> PDF
                                    </button>
                                </div>
                                <button id="refreshBtn" class="btn btn-sm btn-outline-light">
                                    <i class="fas fa-sync-alt me-1"></i> Refresh Data
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="spinner" class="spinner-container">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div id="adminTableContainer" class="table-responsive" style="display:none;">
                                <table class="table table-bordered table-hover align-middle" id="adminTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Last Updated</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add User Modal -->
                <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addUserForm">
                                    <div class="mb-3">
                                        <label for="addUserName" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="addUserName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="addUserEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="addUserEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="addUserPassword" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="addUserPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="addUserRole" class="form-label">Role</label>
                                        <select class="form-select" id="addUserRole" required>
                                            <option value="student">Student</option>
                                            <option value="teacher">Teacher</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="addUserSubmitBtn">Add User</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit User Modal -->
                <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editUserForm">
                                    <input type="hidden" id="editUserId">
                                    <div class="mb-3">
                                        <label for="editUserName" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="editUserName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editUserEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="editUserEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editUserRole" class="form-label">Role</label>
                                        <select class="form-select" id="editUserRole" required>
                                            <option value="student">Student</option>
                                            <option value="teacher">Teacher</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editUserStatus" class="form-label">Status</label>
                                        <select class="form-select" id="editUserStatus" required>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="suspended">Suspended</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editUserPassword" class="form-label">New Password (leave blank to keep current)</label>
                                        <input type="password" class="form-control" id="editUserPassword">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="editUserSubmitBtn">Save Changes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete User Confirmation Modal -->
                <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="deleteUserModalLabel">Confirm Deletion</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <input type="hidden" id="deleteUserId">
                                <p class="mb-0">Are you sure you want to delete this user?</p>
                                <p class="text-danger mt-3 mb-0"><strong>This action cannot be undone.</strong></p>
                                <p id="deleteUserName" class="mt-2 mb-0"></p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="deleteUserConfirmBtn">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subjects Content -->
                <div class="tab-pane fade" id="subjects-content" role="tabpanel" aria-labelledby="subjects-tab">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Add New Subject</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="subjectName" class="form-label">Subject Name</label>
                                        <input type="text" id="subjectName" class="form-control" placeholder="e.g., Computer Science">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Class Days</label>
                                        <div class="d-flex flex-wrap gap-2">
                                            <div class="form-check">
                                                <input class="form-check-input class-day-checkbox" type="checkbox" value="Monday" id="monday">
                                                <label class="form-check-label" for="monday">Monday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input class-day-checkbox" type="checkbox" value="Tuesday" id="tuesday">
                                                <label class="form-check-label" for="tuesday">Tuesday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input class-day-checkbox" type="checkbox" value="Wednesday" id="wednesday">
                                                <label class="form-check-label" for="wednesday">Wednesday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input class-day-checkbox" type="checkbox" value="Thursday" id="thursday">
                                                <label class="form-check-label" for="thursday">Thursday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input class-day-checkbox" type="checkbox" value="Friday" id="friday">
                                                <label class="form-check-label" for="friday">Friday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input class-day-checkbox" type="checkbox" value="Saturday" id="saturday">
                                                <label class="form-check-label" for="saturday">Saturday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input class-day-checkbox" type="checkbox" value="Sunday" id="sunday">
                                                <label class="form-check-label" for="sunday">Sunday</label>
                                            </div>
                                        </div>
                                        <small class="text-muted">Select the days this subject will be taught</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="classOrder" class="form-label">Class Order</label>
                                        <input type="number" id="classOrder" class="form-control" min="1" placeholder="e.g., 1 for 1st class">
                                        <small class="text-muted">This determines the display order in the user dashboard</small>
                                    </div>
                                    <button id="addSubjectBtn" class="btn btn-primary w-100">
                                        <i class="fas fa-plus-circle me-2"></i>Add Subject
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Existing Subjects</h5>
                                </div>
                                <div class="card-body">
                                    <div id="subjectsSpinner" class="spinner-container" style="display:none;">
                                        <div class="spinner-border text-primary" role="status"></div>
                                    </div>
                                    <ul class="list-group" id="subjectsList"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Logs Tab Content -->
                <div class="tab-pane fade" id="userLogs" role="tabpanel" aria-labelledby="userLogs-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-history me-2"></i>User Activity Logs</h5>
                            <div class="d-flex">
                                <button id="refreshLogsBtn" class="btn btn-sm btn-outline-primary me-2">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                                <button id="exportLogsBtn" class="btn btn-sm btn-outline-success me-2">
                                    <i class="fas fa-file-excel me-1"></i>Export Logs
                                </button>
                                <button id="clearLogsBtn" class="btn btn-sm btn-outline-danger me-2">
                                    <i class="fas fa-trash me-1"></i>Clear Logs
                                </button>
                                <button id="debugLogsBtn" class="btn btn-sm btn-outline-warning" onclick="debugUserLogs()">
                                    <i class="fas fa-bug me-1"></i>Debug
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="text" id="logSearchInput" class="form-control" placeholder="Search logs by name, email, activity...">
                                        <button class="btn btn-primary" id="searchLogsBtn">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select id="logFilterSelect" class="form-select">
                                        <option value="all">All Activities</option>
                                        <option value="login">Login/Logout</option>
                                        <option value="attendance">Attendance</option>
                                        <option value="view">Page Views</option>
                                        <option value="error">Errors</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select id="logLimitSelect" class="form-select">
                                        <option value="100">Last 100</option>
                                        <option value="500">Last 500</option>
                                        <option value="1000">Last 1000</option>
                                        <option value="all">View All</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Date Range Filter -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="logDateFrom" class="form-label">From Date:</label>
                                    <input type="date" id="logDateFrom" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label for="logDateTo" class="form-label">To Date:</label>
                                    <input type="date" id="logDateTo" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label for="logUserFilter" class="form-label">User Filter:</label>
                                    <input type="text" id="logUserFilter" class="form-control" placeholder="Filter by user email">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-outline-secondary me-2" id="clearLogFiltersBtn">
                                        <i class="fas fa-times me-1"></i>Clear Filters
                                    </button>
                                    <button class="btn btn-outline-info" id="viewFullActivityLogBtn">
                                        <i class="fas fa-expand me-1"></i>Full View
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover" id="userLogsTable">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>Activity</th>
                                            <th>Page</th>
                                            <th>Device Info</th>
                                            <th>Session</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- User logs will be loaded here -->
                                    </tbody>
                                </table>
                                <div id="logsSpinner" class="d-flex justify-content-center align-items-center p-5" style="display: none !important;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Pagination and Stats -->
                            <div class="card-footer">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <small class="text-muted" id="logStatsText">Showing 0 logs</small>
                                    </div>
                                    <div class="col-md-6">
                                        <nav aria-label="Log pagination">
                                            <ul class="pagination pagination-sm justify-content-end mb-0" id="logPagination">
                                                <li class="page-item disabled">
                                                    <button class="page-link" id="prevLogPage">
                                                        <i class="fas fa-chevron-left"></i> Previous
                                                    </button>
                                                </li>
                                                <li class="page-item active">
                                                    <span class="page-link" id="currentLogPage">1</span>
                                                </li>
                                                <li class="page-item disabled">
                                                    <button class="page-link" id="nextLogPage">
                                                        Next <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </li>
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Deleted Reports Content -->
                <div class="tab-pane fade" id="deleted-content" role="tabpanel" aria-labelledby="deleted-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Deleted Records</h5>
                            <div>
                                <button id="exportDeletedBtn" class="btn btn-sm btn-success me-2">
                                    <i class="fas fa-file-excel me-1"></i> Export Data
                                </button>
                                <button id="refreshDeletedBtn" class="btn btn-sm btn-outline-light">
                                    <i class="fas fa-sync-alt me-1"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="deletedSpinner" class="spinner-container" style="display:none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="deletedReportsTable">
                                    <thead>
                                        <tr>
                                            <th>Item Type</th>
                                            <th>Original ID</th>
                                            <th>Details</th>
                                            <th>Deleted By</th>
                                            <th>Deleted At</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Profile Modal -->
                <div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="userProfileModalLabel">User Profile</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center mb-4">
                                            <div class="profile-avatar mb-3">
                                                <i class="fas fa-user-circle fa-5x text-primary"></i>
                                            </div>
                                            <h5 id="profileUserName">Loading...</h5>
                                            <p class="text-muted" id="profileUserEmail">Loading...</p>
                                            <span class="badge bg-primary" id="profileUserRole">User</span>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Basic Information</h6>
                                                <table class="table table-sm">
                                                    <tr>
                                                        <td><strong>User ID:</strong></td>
                                                        <td id="profileUserId">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Registration Date:</strong></td>
                                                        <td id="profileRegDate">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Last Login:</strong></td>
                                                        <td id="profileLastLogin">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Status:</strong></td>
                                                        <td id="profileStatus">-</td>
                                                    </tr>
                                                </table>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Contact Details</h6>
                                                <table class="table table-sm">
                                                    <tr>
                                                        <td><strong>Phone:</strong></td>
                                                        <td id="profilePhone">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Department:</strong></td>
                                                        <td id="profileDepartment">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Student ID:</strong></td>
                                                        <td id="profileStudentId">-</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Year:</strong></td>
                                                        <td id="profileYear">-</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Activity History Section -->
                                <div class="mt-4">
                                    <h6>Recent Activity</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Activity</th>
                                                    <th>Page</th>
                                                    <th>Device</th>
                                                </tr>
                                            </thead>
                                            <tbody id="profileActivityTable">
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted">Loading activity...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Attendance Summary Section -->
                                <div class="mt-4">
                                    <h6>Attendance Summary</h6>
                                    <div id="profileAttendanceSummary">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="card text-center">
                                                    <div class="card-body">
                                                        <h5 class="card-title text-success" id="profileTotalPresent">0</h5>
                                                        <p class="card-text">Present</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card text-center">
                                                    <div class="card-body">
                                                        <h5 class="card-title text-danger" id="profileTotalAbsent">0</h5>
                                                        <p class="card-text">Absent</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card text-center">
                                                    <div class="card-body">
                                                        <h5 class="card-title text-primary" id="profileAttendancePercentage">0%</h5>
                                                        <p class="card-text">Percentage</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card text-center">
                                                    <div class="card-body">
                                                        <h5 class="card-title text-info" id="profileTotalSessions">0</h5>
                                                        <p class="card-text">Total Sessions</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" id="viewFullActivityBtn">View Full Activity Log</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Management Content -->
                <div class="tab-pane fade" id="attendance-content" role="tabpanel" aria-labelledby="attendance-tab">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Manage Attendance</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="attendanceUserSelect" class="form-label">Select User</label>
                                        <select id="attendanceUserSelect" class="form-select">
                                            <option value="">Loading users...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="attendanceSubjectSelect" class="form-label">Select Subject</label>
                                        <select id="attendanceSubjectSelect" class="form-select">
                                            <option value="">Loading subjects...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="attendanceDate" class="form-label">Date</label>
                                        <input type="date" id="attendanceDate" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Status</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="attendanceStatus" id="statusPresent" value="present" checked>
                                            <label class="form-check-label" for="statusPresent">
                                                Present
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="attendanceStatus" id="statusAbsent" value="absent">
                                            <label class="form-check-label" for="statusAbsent">
                                                Absent
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="attendanceNotes" class="form-label">Notes (Optional)</label>
                                        <textarea id="attendanceNotes" class="form-control" rows="3" placeholder="Add any additional notes here"></textarea>
                                    </div>
                                    <button id="addAttendanceBtn" class="btn btn-primary w-100">
                                        <i class="fas fa-plus-circle me-2"></i>Save Attendance
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Attendance Records</h5>
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm" id="attendanceFilterSubject" style="width: 150px;">
                                            <option value="">All Subjects</option>
                                        </select>
                                        <select class="form-select form-select-sm" id="attendanceFilterStatus" style="width: 120px;">
                                            <option value="">All Status</option>
                                            <option value="present">Present</option>
                                            <option value="absent">Absent</option>
                                        </select>
                                        <input type="date" class="form-control form-control-sm" id="attendanceFilterDate" style="width: 150px;">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" id="generateAttendanceReport">
                                                <i class="fas fa-file-csv me-1"></i>CSV
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" id="generateAttendancePDF">
                                                <i class="fas fa-file-pdf me-1"></i>PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="attendanceSpinner" class="spinner-container" style="display:none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover" id="recentAttendanceTable">
                                            <thead>
                                                <tr>
                                                    <th>User</th>
                                                    <th>Subject</th>
                                                    <th>Date</th>
                                                    <th>Status</th>
                                                    <th>Added By</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>

                                    <!-- Attendance Statistics -->
                                    <div class="row mt-4">
                                        <div class="col-md-3">
                                            <div class="card text-center bg-success text-white">
                                                <div class="card-body">
                                                    <h5 id="totalPresentStat">0</h5>
                                                    <p class="mb-0">Total Present</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center bg-danger text-white">
                                                <div class="card-body">
                                                    <h5 id="totalAbsentStat">0</h5>
                                                    <p class="mb-0">Total Absent</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center bg-primary text-white">
                                                <div class="card-body">
                                                    <h5 id="attendanceRateStat">0%</h5>
                                                    <p class="mb-0">Attendance Rate</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center bg-info text-white">
                                                <div class="card-body">
                                                    <h5 id="totalSessionsStat">0</h5>
                                                    <p class="mb-0">Total Sessions</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Management Content -->
                <div class="tab-pane fade" id="notifications-content" role="tabpanel" aria-labelledby="notifications-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Send Notification</h5>
                                </div>
                                <div class="card-body">
                                    <form id="notificationForm">
                                        <div class="mb-3">
                                            <label for="authorName" class="form-label">Author Name</label>
                                            <input type="text" class="form-control" id="authorName" placeholder="Enter your name as it will appear to users" required>
                                            <div class="form-text">This name will be displayed to users as the sender of the message.</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="notificationTitle" class="form-label">Title</label>
                                            <input type="text" class="form-control" id="notificationTitle" placeholder="Enter notification title" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="notificationMessage" class="form-label">Message</label>
                                            <textarea class="form-control" id="notificationMessage" rows="4" placeholder="Enter your message here..." required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="notificationRecipient" class="form-label">Send To</label>
                                            <select class="form-select" id="notificationRecipient" required>
                                                <option value="">Select recipient</option>
                                                <option value="all">All Users</option>
                                                <option value="specific">Specific User</option>
                                            </select>
                                        </div>
                                        <div class="mb-3" id="specificUserDiv" style="display: none;">
                                            <label for="specificUser" class="form-label">Select User</label>
                                            <select class="form-select" id="specificUser">
                                                <option value="">Loading users...</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="notificationUrgent">
                                                <label class="form-check-label" for="notificationUrgent">
                                                    Mark as urgent
                                                </label>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-send me-2"></i>Send Notification
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Notifications</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Recipient</th>
                                                    <th>Date</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentNotificationsTable">
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted">No notifications sent yet</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>All Notifications</h5>
                                    <button class="btn btn-sm btn-outline-danger" id="deleteAllNotificationsBtn" title="Delete all notifications">
                                        <i class="fas fa-trash-alt me-1"></i>Delete All
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="allNotificationsTable">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Message</th>
                                                    <th>Recipient</th>
                                                    <th>Sent Date</th>
                                                    <th>Read Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted">Loading notifications...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Content -->
                <div class="tab-pane fade" id="reports-content" role="tabpanel" aria-labelledby="reports-tab">
                    <!-- Reports Navigation -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Attendance Reports</h5>
                                    <small class="text-muted">Comprehensive attendance reporting and analytics</small>
                                </div>
                                <div class="card-body">
                                    <ul class="nav nav-pills nav-fill" id="reports-nav" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="user-reports-tab" data-bs-toggle="pill" data-bs-target="#user-reports" type="button" role="tab" aria-controls="user-reports" aria-selected="true">
                                                <i class="fas fa-users me-2"></i>User Reports
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="subject-reports-tab" data-bs-toggle="pill" data-bs-target="#subject-reports" type="button" role="tab" aria-controls="subject-reports" aria-selected="false">
                                                <i class="fas fa-book me-2"></i>Subject Reports
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="analytics-reports-tab" data-bs-toggle="pill" data-bs-target="#analytics-reports" type="button" role="tab" aria-controls="analytics-reports" aria-selected="false">
                                                <i class="fas fa-chart-line me-2"></i>Analytics
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="reports-tab-content">
                        <!-- User Reports Tab -->
                        <div class="tab-pane fade show active" id="user-reports" role="tabpanel" aria-labelledby="user-reports-tab">
                            <!-- Filters and Controls -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filters & Export</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3 align-items-end">
                                                <div class="col-md-3">
                                                    <label for="userReportDateFrom" class="form-label">From Date</label>
                                                    <input type="date" class="form-control form-control-sm" id="userReportDateFrom">
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="userReportDateTo" class="form-label">To Date</label>
                                                    <input type="date" class="form-control form-control-sm" id="userReportDateTo">
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="userReportMinAttendance" class="form-label">Min Attendance %</label>
                                                    <input type="number" class="form-control form-control-sm" id="userReportMinAttendance" min="0" max="100" placeholder="0">
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="userReportRole" class="form-label">Role</label>
                                                    <select class="form-select form-select-sm" id="userReportRole">
                                                        <option value="">All Roles</option>
                                                        <option value="student">Students</option>
                                                        <option value="admin">Admins</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-2">
                                                    <div class="btn-group w-100">
                                                        <button class="btn btn-primary btn-sm" id="applyUserFilters">
                                                            <i class="fas fa-search me-1"></i>Apply
                                                        </button>
                                                        <button class="btn btn-outline-secondary btn-sm" id="clearUserFilters">
                                                            <i class="fas fa-times me-1"></i>Clear
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-12">
                                                    <div class="btn-group">
                                                        <button class="btn btn-success btn-sm" id="exportUserReportPDF">
                                                            <i class="fas fa-file-pdf me-1"></i>Export PDF
                                                        </button>
                                                        <button class="btn btn-info btn-sm" id="exportUserReportExcel">
                                                            <i class="fas fa-file-excel me-1"></i>Export Excel
                                                        </button>
                                                        <button class="btn btn-warning btn-sm" id="refreshUserReport">
                                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- User Statistics Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-users fa-2x mb-2"></i>
                                            <h4 id="totalUsersCount">0</h4>
                                            <small>Total Users</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                                            <h4 id="highAttendanceCount">0</h4>
                                            <small>High Attendance (80%)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                            <h4 id="mediumAttendanceCount">0</h4>
                                            <small>Medium Attendance (60-79%)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-times-circle fa-2x mb-2"></i>
                                            <h4 id="lowAttendanceCount">0</h4>
                                            <small>Low Attendance (<60%)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- User Reports Table -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="fas fa-table me-2"></i>User Attendance Details</h6>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-info me-2" id="userReportCount">0 users</span>
                                                <div class="spinner-border spinner-border-sm text-primary" role="status" id="userReportSpinner" style="display: none;">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover table-striped" id="userReportsTable">
                                                    <thead class="table-dark">
                                                        <tr>
                                                            <th>User</th>
                                                            <th>Email</th>
                                                            <th>Role</th>
                                                            <th>Total Sessions</th>
                                                            <th>Present</th>
                                                            <th>Absent</th>
                                                            <th>Attendance %</th>
                                                            <th>Last Activity</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="userReportsTableBody">
                                                        <tr>
                                                            <td colspan="9" class="text-center text-muted">Loading user reports...</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Subject Reports Tab -->
                        <div class="tab-pane fade" id="subject-reports" role="tabpanel" aria-labelledby="subject-reports-tab">
                            <!-- Subject Filters and Controls -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Subject Filters & Export</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3 align-items-end">
                                                <div class="col-md-3">
                                                    <label for="subjectReportSelect" class="form-label">Select Subject</label>
                                                    <select class="form-select form-select-sm" id="subjectReportSelect">
                                                        <option value="">All Subjects</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="subjectReportDateFrom" class="form-label">From Date</label>
                                                    <input type="date" class="form-control form-control-sm" id="subjectReportDateFrom">
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="subjectReportDateTo" class="form-label">To Date</label>
                                                    <input type="date" class="form-control form-control-sm" id="subjectReportDateTo">
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="btn-group w-100">
                                                        <button class="btn btn-primary btn-sm" id="applySubjectFilters">
                                                            <i class="fas fa-search me-1"></i>Apply
                                                        </button>
                                                        <button class="btn btn-outline-secondary btn-sm" id="clearSubjectFilters">
                                                            <i class="fas fa-times me-1"></i>Clear
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-12">
                                                    <div class="btn-group">
                                                        <button class="btn btn-success btn-sm" id="exportSubjectReportPDF">
                                                            <i class="fas fa-file-pdf me-1"></i>Export PDF
                                                        </button>
                                                        <button class="btn btn-info btn-sm" id="exportSubjectReportExcel">
                                                            <i class="fas fa-file-excel me-1"></i>Export Excel
                                                        </button>
                                                        <button class="btn btn-warning btn-sm" id="refreshSubjectReport">
                                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Subject Statistics -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-book fa-2x mb-2"></i>
                                            <h4 id="totalSubjectsCount">0</h4>
                                            <small>Total Subjects</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-calendar-check fa-2x mb-2"></i>
                                            <h4 id="totalSessionsCount">0</h4>
                                            <small>Total Sessions</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-percentage fa-2x mb-2"></i>
                                            <h4 id="overallAttendanceRate">0%</h4>
                                            <small>Overall Attendance Rate</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Subject Reports Table -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="fas fa-table me-2"></i>Subject-wise Attendance</h6>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-info me-2" id="subjectReportCount">0 subjects</span>
                                                <div class="spinner-border spinner-border-sm text-primary" role="status" id="subjectReportSpinner" style="display: none;">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover table-striped" id="subjectReportsTable">
                                                    <thead class="table-dark">
                                                        <tr>
                                                            <th>Subject</th>
                                                            <th>Total Students</th>
                                                            <th>Total Sessions</th>
                                                            <th>Present Count</th>
                                                            <th>Absent Count</th>
                                                            <th>Attendance Rate</th>
                                                            <th>Last Session</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="subjectReportsTableBody">
                                                        <tr>
                                                            <td colspan="8" class="text-center text-muted">Loading subject reports...</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics Tab -->
                        <div class="tab-pane fade" id="analytics-reports" role="tabpanel" aria-labelledby="analytics-reports-tab">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Attendance Distribution</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="attendanceDistributionChart" style="max-height: 300px;"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Attendance Trends</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="attendanceTrendsChart" style="max-height: 300px;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Subject Performance</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="subjectPerformanceChart" style="max-height: 300px;"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Daily Attendance Pattern</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="dailyAttendanceChart" style="max-height: 300px;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Functions Management Content -->
                <div class="tab-pane fade" id="functions-content" role="tabpanel" aria-labelledby="functions-tab">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Function Management</h5>
                                    <small class="text-muted">Manage and execute administrative functions</small>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <!-- Database Functions -->
                                        <div class="col-md-6">
                                            <div class="card border-primary">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="mb-0"><i class="fas fa-database me-2"></i>Database Functions</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="d-grid gap-2">
                                                        <button class="btn btn-outline-primary" id="createInitialDataBtn">
                                                            <i class="fas fa-plus me-2"></i>Create Initial User Data
                                                        </button>
                                                        <button class="btn btn-outline-primary" id="createSampleDataBtn">
                                                            <i class="fas fa-users me-2"></i>Create Sample Users
                                                        </button>
                                                        <button class="btn btn-outline-primary" id="createUserLogsBtn">
                                                            <i class="fas fa-history me-2"></i>Initialize User Logs
                                                        </button>
                                                        <button class="btn btn-outline-danger" id="clearUserLogsBtn">
                                                            <i class="fas fa-trash me-2"></i>Clear All User Logs
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- System Functions -->
                                        <div class="col-md-6">
                                            <div class="card border-success">
                                                <div class="card-header bg-success text-white">
                                                    <h6 class="mb-0"><i class="fas fa-tools me-2"></i>System Functions</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="d-grid gap-2">
                                                        <button class="btn btn-outline-success" id="testFirebaseConnectionBtn">
                                                            <i class="fas fa-plug me-2"></i>Test Firebase Connection
                                                        </button>
                                                        <button class="btn btn-outline-success" id="validateDataIntegrityBtn">
                                                            <i class="fas fa-check-circle me-2"></i>Validate Data Integrity
                                                        </button>
                                                        <button class="btn btn-outline-success" id="exportSystemLogsBtn">
                                                            <i class="fas fa-download me-2"></i>Export System Logs
                                                        </button>
                                                        <button class="btn btn-outline-warning" id="resetCacheBtn">
                                                            <i class="fas fa-sync me-2"></i>Reset Application Cache
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- User Management Functions -->
                                        <div class="col-md-6">
                                            <div class="card border-info">
                                                <div class="card-header bg-info text-white">
                                                    <h6 class="mb-0"><i class="fas fa-user-cog me-2"></i>User Management</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="d-grid gap-2">
                                                        <button class="btn btn-outline-info" id="syncUserDataBtn">
                                                            <i class="fas fa-sync-alt me-2"></i>Sync User Data
                                                        </button>
                                                        <button class="btn btn-outline-info" id="validateUserAccountsBtn">
                                                            <i class="fas fa-user-check me-2"></i>Validate User Accounts
                                                        </button>
                                                        <button class="btn btn-outline-info" id="generateUserReportBtn">
                                                            <i class="fas fa-chart-bar me-2"></i>Generate User Report
                                                        </button>
                                                        <button class="btn btn-outline-danger" id="cleanupInactiveUsersBtn">
                                                            <i class="fas fa-user-times me-2"></i>Cleanup Inactive Users
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Maintenance Functions -->
                                        <div class="col-md-6">
                                            <div class="card border-warning">
                                                <div class="card-header bg-warning text-dark">
                                                    <h6 class="mb-0"><i class="fas fa-wrench me-2"></i>Maintenance</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="d-grid gap-2">
                                                        <button class="btn btn-outline-warning" id="optimizeDatabaseBtn">
                                                            <i class="fas fa-tachometer-alt me-2"></i>Optimize Database
                                                        </button>
                                                        <button class="btn btn-outline-warning" id="backupDataBtn">
                                                            <i class="fas fa-save me-2"></i>Backup Data
                                                        </button>
                                                        <button class="btn btn-outline-warning" id="runHealthCheckBtn">
                                                            <i class="fas fa-heartbeat me-2"></i>Run Health Check
                                                        </button>
                                                        <button class="btn btn-outline-danger" id="emergencyResetBtn">
                                                            <i class="fas fa-exclamation-triangle me-2"></i>Emergency Reset
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Function Execution Log -->
                                    <div class="row mt-4">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0"><i class="fas fa-terminal me-2"></i>Function Execution Log</h6>
                                                    <button class="btn btn-sm btn-outline-secondary" id="clearFunctionLogBtn">
                                                        <i class="fas fa-trash me-1"></i>Clear Log
                                                    </button>
                                                </div>
                                                <div class="card-body">
                                                    <div id="functionExecutionLog" class="bg-dark text-light p-3 rounded" style="height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                                                        <div class="text-success">Function Management System Ready</div>
                                                        <div class="text-muted">Execute functions using the buttons above. Results will appear here.</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Error Logs Section -->
                                    <div class="row mt-4">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Error Logs</h6>
                                                    <div class="d-flex gap-2 flex-wrap">
                                                        <input type="text" id="errorSearchInput" class="form-control form-control-sm" placeholder="Search errors..." style="width: 150px;">
                                                        <select id="errorTypeFilter" class="form-select form-select-sm" style="width: 120px;">
                                                            <option value="">All Types</option>
                                                            <option value="javascript">JavaScript</option>
                                                            <option value="network">Network</option>
                                                            <option value="firebase">Firebase</option>
                                                            <option value="validation">Validation</option>
                                                            <option value="authentication">Auth</option>
                                                        </select>
                                                        <input type="date" id="errorDateFrom" class="form-control form-control-sm" style="width: 140px;" title="From Date">
                                                        <input type="date" id="errorDateTo" class="form-control form-control-sm" style="width: 140px;" title="To Date">
                                                        <button class="btn btn-sm btn-outline-secondary" id="clearErrorFiltersBtn">
                                                            <i class="fas fa-times me-1"></i>Clear
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-primary" id="refreshErrorLogsBtn">
                                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-warning" id="generateTestErrorsBtn" title="Generate test error logs for demonstration">
                                                            <i class="fas fa-flask me-1"></i>Test Data
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" id="clearErrorLogsBtn" title="Clear all error logs (Admin only)">
                                                            <i class="fas fa-trash me-1"></i>Clear All
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-info" id="toggleErrorChartsBtn" title="Toggle error analytics charts">
                                                            <i class="fas fa-chart-bar me-1"></i>Analytics
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div id="errorLogsSpinner" class="text-center" style="display: none;">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <p class="mt-2">Loading error logs...</p>
                                                    </div>
                                                    <div class="table-responsive">
                                                        <table class="table table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Error ID</th>
                                                                    <th>Timestamp</th>
                                                                    <th>Type</th>
                                                                    <th>Message</th>
                                                                    <th>User</th>
                                                                    <th>Page</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="errorLogsTableBody">
                                                                <tr>
                                                                    <td colspan="7" class="text-center text-muted">No error logs found</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Error Analytics Charts (Initially Hidden) -->
                                    <div id="errorAnalyticsSection" class="mt-4" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="mb-0">
                                                            <i class="fas fa-chart-line me-2"></i>Error Trends (Last 7 Days)
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="errorTrendsChart" height="300"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="mb-0">
                                                            <i class="fas fa-pie-chart me-2"></i>Error Types Distribution
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="errorTypesChart" height="300"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-4">
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="mb-0">
                                                            <i class="fas fa-users me-2"></i>Errors by User
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="errorsByUserChart" height="300"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="mb-0">
                                                            <i class="fas fa-globe me-2"></i>Errors by Page
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="errorsByPageChart" height="300"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>

        <!-- Resend Email System Content -->
        <div class="tab-pane fade" id="email-system-content" role="tabpanel" aria-labelledby="email-system-tab">
            <div class="row">
                <!-- Resend Status and Controls -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Resend Email System</h5>
                            <small class="text-muted">Manage email templates and delivery with Resend API</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-dark border-secondary">
                                        <div class="card-body text-center">
                                            <i class="fas fa-server fa-2x text-primary mb-2"></i>
                                            <h6>Resend Service Status</h6>
                                            <div id="resendServiceStatus" class="badge bg-secondary">Checking...</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-dark border-secondary">
                                        <div class="card-body text-center">
                                            <i class="fas fa-paper-plane fa-2x text-success mb-2"></i>
                                            <h6>Test Emails Sent</h6>
                                            <div class="h4 text-success" id="testEmailsCount">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <h6>Quick Actions</h6>
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-primary" id="testResendEmailBtn">
                                        <i class="fas fa-paper-plane me-1"></i>Send Test Email
                                    </button>
                                    <button class="btn btn-outline-info" id="checkResendStatusBtn">
                                        <i class="fas fa-sync me-1"></i>Check Service Status
                                    </button>
                                    <button class="btn btn-outline-success" id="testWelcomeEmailBtn">
                                        <i class="fas fa-user-plus me-1"></i>Test Welcome Email
                                    </button>
                                    <button class="btn btn-outline-warning" id="viewEmailTemplatesBtn">
                                        <i class="fas fa-list me-1"></i>View Templates
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Test Results -->
                    <div class="card mt-3" id="emailTestResults" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Test Results</h6>
                        </div>
                        <div class="card-body">
                            <div id="testResultsContent">
                                <!-- Test results will be displayed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Available Email Templates -->
                    <div class="card mt-3" id="emailTemplatesCard" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Available Email Templates</h6>
                        </div>
                        <div class="card-body">
                            <div id="emailTemplatesList">
                                <!-- Templates will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Testing Panel -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-flask me-2"></i>Email Testing Panel</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="testEmailAddress" class="form-label">Test Email Address</label>
                                <input type="email" class="form-control" id="testEmailAddress"
                                       placeholder="Enter email address" value="rahulhitwo@gmail.com">
                            </div>
                            <div class="mb-3">
                                <label for="testEmailType" class="form-label">Email Type</label>
                                <select class="form-select" id="testEmailType">
                                    <option value="hello">Hello Email</option>
                                    <option value="welcome">Welcome Email</option>
                                    <option value="contact">Contact Email</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="testUserName" class="form-label">User Name (Optional)</label>
                                <input type="text" class="form-control" id="testUserName"
                                       placeholder="Enter user name" value="Test User">
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" id="sendTestEmailBtn">
                                    <i class="fas fa-paper-plane me-1"></i>Send Test Email
                                </button>
                                <button class="btn btn-outline-success" id="sendWelcomeTestBtn">
                                    <i class="fas fa-user-plus me-1"></i>Send Welcome Test
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Email Statistics</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border rounded p-2 bg-dark">
                                        <div class="h6 mb-0 text-success" id="emailsSuccessCount">0</div>
                                        <small class="text-muted">Successful</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded p-2 bg-dark">
                                        <div class="h6 mb-0 text-danger" id="emailsFailedCount">0</div>
                                        <small class="text-muted">Failed</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">Current session</small>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Resend Configuration</h6>
                        </div>
                        <div class="card-body">
                            <div class="small">
                                <div class="mb-2">
                                    <strong>Service:</strong> Resend API
                                </div>
                                <div class="mb-2">
                                    <strong>From Address:</strong> onboarding@resend.dev
                                </div>
                                <div class="mb-2">
                                    <strong>Server Port:</strong> 3001
                                </div>
                                <div class="mb-2">
                                    <strong>Health Endpoint:</strong> /health
                                </div>
                                <div class="mb-2">
                                    <strong>Test Endpoint:</strong> /test-email
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Submissions Content -->
        <div class="tab-pane fade" id="contact-submissions-content" role="tabpanel" aria-labelledby="contact-submissions-tab">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Contact Form Submissions</h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" id="refreshContactSubmissions">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                                <button class="btn btn-sm btn-outline-success" id="exportContactSubmissions">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filters and Search -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Status Filter</label>
                                    <select class="form-select form-select-sm" id="statusFilter">
                                        <option value="">All Status</option>
                                        <option value="unread">Unread</option>
                                        <option value="read">Read</option>
                                        <option value="resolved">Resolved</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Subject Filter</label>
                                    <select class="form-select form-select-sm" id="subjectFilter">
                                        <option value="">All Subjects</option>
                                        <option value="technical-support">Technical Support</option>
                                        <option value="feature-request">Feature Request</option>
                                        <option value="bug-report">Bug Report</option>
                                        <option value="partnership">Partnership</option>
                                        <option value="general">General Inquiry</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Search</label>
                                    <input type="text" class="form-control form-control-sm" id="contactSearch" placeholder="Search by name, email, or message...">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-sm btn-outline-secondary w-100" id="clearContactFilters">
                                        <i class="fas fa-times me-1"></i>Clear
                                    </button>
                                </div>
                            </div>

                            <!-- Statistics Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <h4 id="totalSubmissions">0</h4>
                                            <small>Total Submissions</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body text-center">
                                            <h4 id="unreadSubmissions">0</h4>
                                            <small>Unread</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center">
                                            <h4 id="pendingSubmissions">0</h4>
                                            <small>Pending</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <h4 id="resolvedSubmissions">0</h4>
                                            <small>Resolved</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Submissions Table -->
                            <div class="table-responsive">
                                <table class="table table-hover" id="contactSubmissionsTable">
                                    <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Subject</th>
                                            <th>Message Preview</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="contactSubmissionsTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Loading contact submissions...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <nav aria-label="Contact submissions pagination">
                                <ul class="pagination justify-content-center" id="contactSubmissionsPagination">
                                    <!-- Pagination will be generated dynamically -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>









    <!-- Toast -->
    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1050">
        <div id="adminToast" class="toast align-items-center text-bg-success border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastBody">Notification</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Admin Error Container -->
    <div id="adminErrorContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

    <!-- Contact Submission Details Modal -->
    <div class="modal fade" id="contactSubmissionModal" tabindex="-1" aria-labelledby="contactSubmissionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactSubmissionModalLabel">
                        <i class="fas fa-envelope me-2"></i>Contact Submission Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Submission Details -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-user me-2"></i>Contact Information</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Name:</strong> <span id="modalContactName"></span></p>
                                    <p><strong>Email:</strong> <span id="modalContactEmail"></span></p>
                                    <p><strong>Subject:</strong> <span id="modalContactSubject"></span></p>
                                    <p><strong>Submitted:</strong> <span id="modalContactDate"></span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Status & Actions</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" id="modalContactStatus">
                                            <option value="unread">Unread</option>
                                            <option value="read">Read</option>
                                            <option value="pending">Pending</option>
                                            <option value="resolved">Resolved</option>
                                        </select>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" id="respondToContact">
                                            <i class="fas fa-reply me-1"></i>Respond
                                        </button>
                                        <button class="btn btn-outline-success" id="markAsResolved">
                                            <i class="fas fa-check me-1"></i>Mark as Resolved
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Message Content -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-comment me-2"></i>Message</h6>
                        </div>
                        <div class="card-body">
                            <div id="modalContactMessage" class="border rounded p-3" style="background-color: #f8f9fa; white-space: pre-wrap;"></div>
                        </div>
                    </div>

                    <!-- Technical Details -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-cog me-2"></i>Technical Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Submission ID:</strong> <span id="modalContactId" class="text-muted"></span></p>
                                    <p><strong>User Agent:</strong> <span id="modalContactUserAgent" class="text-muted small"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>IP Address:</strong> <span id="modalContactIP" class="text-muted"></span></p>
                                    <p><strong>Last Updated:</strong> <span id="modalContactUpdated" class="text-muted"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveContactChanges">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Response Modal -->
    <div class="modal fade" id="contactResponseModal" tabindex="-1" aria-labelledby="contactResponseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactResponseModalLabel">
                        <i class="fas fa-reply me-2"></i>Respond to Contact Submission
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="contactResponseForm">
                        <div class="mb-3">
                            <label class="form-label">To:</label>
                            <div class="form-control-plaintext" id="responseToEmail"></div>
                        </div>
                        <div class="mb-3">
                            <label for="responseSubject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="responseSubject" required>
                        </div>
                        <div class="mb-3">
                            <label for="responseMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="responseMessage" rows="8" required placeholder="Type your response here..."></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="markResolvedAfterResponse" checked>
                                <label class="form-check-label" for="markResolvedAfterResponse">
                                    Mark as resolved after sending response
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendContactResponse">
                        <i class="fas fa-paper-plane me-1"></i>Send Response
                    </button>
                </div>
            </div>
        </div>
    </div>

     <!-- Enhanced User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userDetailsModalLabel">
                        <i class="fas fa-user me-2"></i>User Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading Spinner -->
                    <div id="userDetailsSpinner" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading user details...</p>
                    </div>

                    <!-- User Details Content -->
                    <div id="userDetailsContent" style="display: none;">
                        <!-- User Basic Info -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Name:</strong> <span id="modalUserName"></span></p>
                                                <p><strong>Email:</strong> <span id="modalUserEmail"></span></p>
                                                <p><strong>Role:</strong> <span id="modalUserRole" class="badge"></span></p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>User ID:</strong> <span id="modalUserId" class="text-muted"></span></p>
                                                <p><strong>Created:</strong> <span id="modalUserCreated"></span></p>
                                                <p><strong>Last Login:</strong> <span id="modalUserLastLogin"></span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Attendance Overview</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <canvas id="userAttendanceChart" style="max-height: 200px;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Attendance Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-calendar-check fa-2x mb-2"></i>
                                        <h4 id="modalTotalSessions">0</h4>
                                        <small>Total Sessions</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                                        <h4 id="modalPresentCount">0</h4>
                                        <small>Present</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-times-circle fa-2x mb-2"></i>
                                        <h4 id="modalAbsentCount">0</h4>
                                        <small>Absent</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-percentage fa-2x mb-2"></i>
                                        <h4 id="modalAttendanceRate">0%</h4>
                                        <small>Attendance Rate</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Subject-wise Attendance -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-book me-2"></i>Subject-wise Attendance</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Subject</th>
                                                        <th>Present</th>
                                                        <th>Absent</th>
                                                        <th>Total</th>
                                                        <th>Attendance %</th>
                                                        <th>Progress</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="modalUserSubjects">
                                                    <tr>
                                                        <td colspan="6" class="text-center text-muted">Loading subjects...</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Attendance History -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-history me-2"></i>Recent Attendance History</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Subject</th>
                                                        <th>Status</th>
                                                        <th>Added By</th>
                                                        <th>Notes</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="modalUserHistory">
                                                    <tr>
                                                        <td colspan="5" class="text-center text-muted">Loading history...</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="exportUserDetailsReport">
                        <i class="fas fa-file-pdf me-2"></i>Export Report
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Subject Edit Modal -->
    <div class="modal fade" id="editSubjectModal" tabindex="-1" aria-labelledby="editSubjectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSubjectModalLabel">Edit Subject</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editSubjectId">
                    <div class="mb-3">
                        <label for="editSubjectName" class="form-label">Subject Name</label>
                        <input type="text" id="editSubjectName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Class Days</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input class="form-check-input edit-class-day-checkbox" type="checkbox" value="Monday" id="editMonday">
                                <label class="form-check-label" for="editMonday">Monday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input edit-class-day-checkbox" type="checkbox" value="Tuesday" id="editTuesday">
                                <label class="form-check-label" for="editTuesday">Tuesday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input edit-class-day-checkbox" type="checkbox" value="Wednesday" id="editWednesday">
                                <label class="form-check-label" for="editWednesday">Wednesday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input edit-class-day-checkbox" type="checkbox" value="Thursday" id="editThursday">
                                <label class="form-check-label" for="editThursday">Thursday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input edit-class-day-checkbox" type="checkbox" value="Friday" id="editFriday">
                                <label class="form-check-label" for="editFriday">Friday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input edit-class-day-checkbox" type="checkbox" value="Saturday" id="editSaturday">
                                <label class="form-check-label" for="editSaturday">Saturday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input edit-class-day-checkbox" type="checkbox" value="Sunday" id="editSunday">
                                <label class="form-check-label" for="editSunday">Sunday</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editClassOrder" class="form-label">Class Order</label>
                        <input type="number" id="editClassOrder" class="form-control" min="1" placeholder="e.g., 1 for 1st class">
                        <small class="text-muted">This determines the display order in the user dashboard</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSubjectChanges">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Attendance Modal -->
    <div class="modal fade" id="editAttendanceModal" tabindex="-1" aria-labelledby="editAttendanceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAttendanceModalLabel">Edit Attendance Record</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editAttendanceId">
                    <div class="mb-3">
                        <label class="form-label">User</label>
                        <input type="text" id="editAttendanceUser" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <input type="text" id="editAttendanceSubject" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editAttendanceDate" class="form-label">Date</label>
                        <input type="date" id="editAttendanceDate" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="editAttendanceStatus" id="editStatusPresent" value="present">
                            <label class="form-check-label" for="editStatusPresent">
                                Present
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="editAttendanceStatus" id="editStatusAbsent" value="absent">
                            <label class="form-check-label" for="editStatusAbsent">
                                Absent
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editAttendanceNotes" class="form-label">Notes</label>
                        <textarea id="editAttendanceNotes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAttendanceChanges">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Deleted Item Details Modal -->
    <div class="modal fade" id="deletedDetailsModal" tabindex="-1" aria-labelledby="deletedDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deletedDetailsTitle">Deleted Item Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="deletedDetailsContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activity Details Modal -->
    <div class="modal fade" id="activityDetailsModal" tabindex="-1" aria-labelledby="activityDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activityDetailsTitle">User Activity Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="activityDetailsContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Activity Log Modal -->
    <div class="modal fade" id="fullActivityLogModal" tabindex="-1" aria-labelledby="fullActivityLogModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fullActivityLogModalTitle">
                        <i class="fas fa-expand me-2"></i>Full Activity Log View
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Advanced Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <input type="text" id="fullLogSearch" class="form-control" placeholder="Search all fields...">
                        </div>
                        <div class="col-md-2">
                            <select id="fullLogFilter" class="form-select">
                                <option value="all">All Activities</option>
                                <option value="login">Login/Logout</option>
                                <option value="attendance">Attendance</option>
                                <option value="view">Page Views</option>
                                <option value="error">Errors</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="date" id="fullLogDateFrom" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <input type="date" id="fullLogDateTo" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <div class="btn-group w-100">
                                <button class="btn btn-primary" id="applyFullLogFilters">
                                    <i class="fas fa-filter me-1"></i>Apply
                                </button>
                                <button class="btn btn-outline-secondary" id="clearFullLogFilters">
                                    <i class="fas fa-times me-1"></i>Clear
                                </button>
                                <button class="btn btn-outline-success" id="exportFullLogs">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Full Activity Table -->
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-sm table-hover" id="fullActivityTable">
                            <thead class="sticky-top">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Activity</th>
                                    <th>Page</th>
                                    <th>Device</th>
                                    <th>IP Address</th>
                                    <th>Session</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fullActivityTableBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">Loading full activity log...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination for Full Log -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <small class="text-muted" id="fullLogStats">Loading...</small>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="Full log pagination">
                                <ul class="pagination pagination-sm justify-content-end mb-0" id="fullLogPagination">
                                    <li class="page-item disabled">
                                        <button class="page-link" id="fullLogPrevPage">Previous</button>
                                    </li>
                                    <li class="page-item active">
                                        <span class="page-link" id="fullLogCurrentPage">1</span>
                                    </li>
                                    <li class="page-item disabled">
                                        <button class="page-link" id="fullLogNextPage">Next</button>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error Suppressor (Load First) -->
    <script src="../utils/error-suppressor.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="../components/theme.js"></script>
    <script src="../utils/logger.js"></script>
    <script src="../components/emailjs-error-handler.js"></script>
    <script src="../components/emailjs-service.js"></script>

    <script src="../components/admin-auth.js"></script>
    <script src="../components/mcp-integration.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
    //  COMPREHENSIVE ADMIN PANEL DIAGNOSTIC AND FIX SCRIPT
    console.log(' Starting Admin Panel Initialization...');

    // Global error tracking
    window.adminPanelErrors = [];
    window.adminPanelStatus = {
        firebase: false,
        firestore: false,
        auth: false,
        dependencies: false,
        ui: false
    };

    // Enhanced error logging
    function logAdminError(error, context = 'Unknown') {
        const errorInfo = {
            timestamp: new Date().toISOString(),
            context: context,
            message: error.message || error,
            stack: error.stack || 'No stack trace',
            url: window.location.href
        };

        window.adminPanelErrors.push(errorInfo);
        console.error(` Admin Panel Error [${context}]:`, errorInfo);

        // Try to display error in UI if possible
        try {
            const errorContainer = document.getElementById('adminErrorContainer');
            if (errorContainer) {
                errorContainer.innerHTML += `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>Error in ${context}:</strong> ${errorInfo.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }
        } catch (displayError) {
            console.warn('Could not display error in UI:', displayError);
        }

        return errorInfo;
    }

    // Dependency checker
    function checkDependencies() {
        console.log(' Checking dependencies...');
        const dependencies = {
            firebase: typeof firebase !== 'undefined',
            bootstrap: typeof bootstrap !== 'undefined',
            chart: typeof Chart !== 'undefined',
            exceljs: typeof ExcelJS !== 'undefined',
            fileSaver: typeof saveAs !== 'undefined'
        };

        console.log(' Dependency Status:', dependencies);

        const missing = Object.entries(dependencies)
            .filter(([name, loaded]) => !loaded)
            .map(([name]) => name);

        if (missing.length > 0) {
            logAdminError(new Error(`Missing dependencies: ${missing.join(', ')}`), 'Dependency Check');
            return false;
        }

        window.adminPanelStatus.dependencies = true;
        return true;
    }

    // Firebase configuration with enhanced error handling
    const firebaseConfig = {
        apiKey: "AIzaSyBl4gC04HoBGzttBrNtVYu0-xWCzI9qYc0",
        authDomain: "attendance-a9a19.firebaseapp.com",
        databaseURL: "https://attendance-a9a19-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "attendance-a9a19",
        storageBucket: "attendance-a9a19.appspot.com",
        messagingSenderId: "1055787262218",
        appId: "1:1055787262218:web:c0c9c33d771456888d5af3",
        measurementId: "G-3XPB4VLFYH"
    };

    // Enhanced Firebase initialization
    let auth, db, rtdb;

    function initializeFirebase() {
        try {
            console.log(' Initializing Firebase...');

            // Check if Firebase is available
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }

            // Initialize Firebase app if not already initialized
            let app;
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
                console.log(' Firebase app initialized');
            } else {
                app = firebase.app();
                console.log(' Using existing Firebase app');
            }

            // Initialize services
            auth = firebase.auth();
            db = firebase.firestore();
            rtdb = firebase.database();

            console.log(' Firebase services initialized');
            window.adminPanelStatus.firebase = true;
            window.adminPanelStatus.auth = true;

            // Enable offline persistence with better error handling
            db.enablePersistence({ synchronizeTabs: true })
                .then(() => {
                    console.log(' Firestore offline persistence enabled');
                    window.adminPanelStatus.firestore = true;
                })
                .catch((err) => {
                    console.warn(' Persistence error:', err.code);
                    if (err.code === 'failed-precondition') {
                        console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code === 'unimplemented') {
                        console.warn('The current browser does not support all features required to enable persistence');
                    }
                    // Still mark as working even without persistence
                    window.adminPanelStatus.firestore = true;
                });

            return { auth, db, rtdb };

        } catch (error) {
            logAdminError(error, 'Firebase Initialization');

            // Create fallback objects to prevent null reference errors
            auth = {
                onAuthStateChanged: (callback) => {
                    console.warn('Firebase auth not available, using fallback');
                    callback(null);
                },
                signInWithEmailAndPassword: () => Promise.reject(new Error('Firebase not initialized')),
                signOut: () => Promise.reject(new Error('Firebase not initialized'))
            };

            db = {
                collection: () => ({
                    get: () => Promise.reject(new Error('Firestore not initialized')),
                    add: () => Promise.reject(new Error('Firestore not initialized')),
                    doc: () => ({
                        get: () => Promise.reject(new Error('Firestore not initialized')),
                        set: () => Promise.reject(new Error('Firestore not initialized')),
                        update: () => Promise.reject(new Error('Firestore not initialized')),
                        delete: () => Promise.reject(new Error('Firestore not initialized'))
                    })
                })
            };

            rtdb = {
                ref: () => ({
                    on: () => {},
                    off: () => {},
                    set: () => Promise.reject(new Error('Realtime Database not initialized'))
                })
            };

            return { auth, db, rtdb };
        }
    }

    // Initialize Firebase immediately
    const firebaseServices = initializeFirebase();
    
    // UI Validation and Error Container Setup
    function setupErrorContainer() {
        // Add error container to the page if it doesn't exist
        if (!document.getElementById('adminErrorContainer')) {
            const errorContainer = document.createElement('div');
            errorContainer.id = 'adminErrorContainer';
            errorContainer.className = 'position-fixed top-0 end-0 p-3';
            errorContainer.style.zIndex = '9999';
            document.body.appendChild(errorContainer);
        }
    }

    // UI Element Validation
    function validateUIElements() {
        console.log(' Validating UI elements...');

        const criticalElements = [
            'adminLoginContainer',
            'adminDashboard',
            'adminTable',
            'userLogsTable',
            'errorLogsTableBody',
            'logsSpinner',
            'errorLogsSpinner',
            'adminToast'
        ];

        const missingElements = [];

        criticalElements.forEach(elementId => {
            const element = document.getElementById(elementId);
            if (!element) {
                missingElements.push(elementId);
                console.warn(` Missing UI element: ${elementId}`);

                // Create placeholder elements to prevent null reference errors
                const placeholder = document.createElement('div');
                placeholder.id = elementId;
                placeholder.style.display = 'none';
                placeholder.setAttribute('data-placeholder', 'true');
                document.body.appendChild(placeholder);
            }
        });

        if (missingElements.length > 0) {
            logAdminError(new Error(`Missing UI elements: ${missingElements.join(', ')}`), 'UI Validation');
            return false;
        }

        console.log(' All critical UI elements found');
        window.adminPanelStatus.ui = true;
        return true;
    }

    // Admin emails configuration
    const adminEmails = [
        "admin@admin.com",
        "admin@example.com",
        "administrator@attendance.com"
    ];

    // Global variables with null safety
    let attendanceChartInstance = null;
    let userAttendanceChartInstance = null;
    let currentUser = null;

    // Enhanced status tracking
    window.adminPanelInitialized = false;

    //  SAFE ELEMENT ACCESS FUNCTIONS
    // These functions prevent null reference errors that cause console errors

    function safeGetElement(id, context = 'Unknown') {
        try {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(` Element not found: ${id} (Context: ${context})`);
                return null;
            }
            return element;
        } catch (error) {
            console.error(` Error accessing element ${id}:`, error);
            logAdminError(error, `Element Access: ${id}`);
            return null;
        }
    }

    function safeQuerySelector(selector, context = 'Unknown') {
        try {
            const element = document.querySelector(selector);
            if (!element) {
                console.warn(` Element not found with selector: ${selector} (Context: ${context})`);
                return null;
            }
            return element;
        } catch (error) {
            console.error(` Error querying selector ${selector}:`, error);
            logAdminError(error, `Query Selector: ${selector}`);
            return null;
        }
    }

    function safeSetContent(elementId, content, context = 'Unknown') {
        try {
            const element = safeGetElement(elementId, context);
            if (element) {
                if (typeof content === 'string') {
                    element.textContent = content;
                } else {
                    element.innerHTML = content;
                }
                return true;
            }
            return false;
        } catch (error) {
            console.error(` Error setting content for ${elementId}:`, error);
            logAdminError(error, `Set Content: ${elementId}`);
            return false;
        }
    }

    function safeSetStyle(elementId, property, value, context = 'Unknown') {
        try {
            const element = safeGetElement(elementId, context);
            if (element) {
                element.style[property] = value;
                return true;
            }
            return false;
        } catch (error) {
            console.error(` Error setting style for ${elementId}:`, error);
            logAdminError(error, `Set Style: ${elementId}`);
            return false;
        }
    }

    function safeAddEventListener(elementId, event, handler, context = 'Unknown') {
        try {
            const element = safeGetElement(elementId, context);
            if (element) {
                element.addEventListener(event, handler);
                return true;
            }
            return false;
        } catch (error) {
            console.error(` Error adding event listener to ${elementId}:`, error);
            logAdminError(error, `Add Event Listener: ${elementId}`);
            return false;
        }
    }

    function safeGetValue(elementId, defaultValue = '', context = 'Unknown') {
        try {
            const element = safeGetElement(elementId, context);
            if (element) {
                return element.value || defaultValue;
            }
            return defaultValue;
        } catch (error) {
            console.error(` Error getting value from ${elementId}:`, error);
            logAdminError(error, `Get Value: ${elementId}`);
            return defaultValue;
        }
    }

    // Comprehensive Admin Panel Initialization
    async function initializeAdminPanel() {
        try {
            console.log(' Starting comprehensive admin panel initialization...');

            // Step 1: Setup error container
            setupErrorContainer();

            // Step 2: Check dependencies
            if (!checkDependencies()) {
                throw new Error('Critical dependencies missing');
            }

            // Step 3: Validate UI elements (after DOM is ready)
            if (document.readyState === 'loading') {
                await new Promise(resolve => {
                    document.addEventListener('DOMContentLoaded', resolve);
                });
            }

            validateUIElements();

            // Step 4: Test Firebase connectivity
            await testFirebaseConnectivity();

            // Step 5: Initialize admin-specific features
            initializeAdminFeatures();

            // Step 6: Setup global error handlers
            setupGlobalErrorHandlers();

            window.adminPanelInitialized = true;
            console.log(' Admin panel initialization completed successfully');

            // Display success message
            showToast('Admin panel initialized successfully', 'success');

        } catch (error) {
            logAdminError(error, 'Admin Panel Initialization');
            console.error(' Admin panel initialization failed:', error);

            // Show fallback UI
            showFallbackUI(error);
        }
    }

    // Test Firebase connectivity
    async function testFirebaseConnectivity() {
        console.log(' Testing Firebase connectivity...');

        try {
            // Test Firestore connection
            await db.collection('_test_connection').limit(1).get();
            console.log(' Firestore connectivity test passed');

            // Test Auth service
            if (auth && typeof auth.onAuthStateChanged === 'function') {
                console.log(' Firebase Auth service available');
            } else {
                throw new Error('Firebase Auth service not available');
            }

            return true;

        } catch (error) {
            console.warn(' Firebase connectivity test failed:', error);
            logAdminError(error, 'Firebase Connectivity Test');
            return false;
        }
    }

    // Initialize admin-specific features
    function initializeAdminFeatures() {
        console.log(' Initializing admin features...');

        try {
            // Initialize notification management
            if (typeof initializeNotificationManagement === 'function') {
                initializeNotificationManagement();
            }

            // Initialize function management
            if (typeof initializeFunctionManagement === 'function') {
                initializeFunctionManagement();
            }



            console.log(' Admin features initialized');

        } catch (error) {
            logAdminError(error, 'Admin Features Initialization');
        }
    }

    // Setup global error handlers
    function setupGlobalErrorHandlers() {
        console.log(' Setting up global error handlers...');

        // Global error handler with filtering
        window.addEventListener('error', function(event) {
            const errorMessage = event.error?.message || event.message || 'Unknown error';

            // Filter out browser extension and React errors that aren't relevant
            if (errorMessage.includes('chrome-extension://') ||
                errorMessage.includes('moz-extension://') ||
                errorMessage.includes('safari-extension://') ||
                errorMessage.includes('Minified React error') ||
                errorMessage.includes('inspector') ||
                errorMessage.includes('contentScript') ||
                errorMessage.includes('Extension context invalidated')) {
                console.warn(' Filtered browser extension/React error:', errorMessage);
                return;
            }

            // Only log actual application errors
            logAdminError(event.error || new Error(errorMessage), 'Global Error Handler');
        });

        // Unhandled promise rejection handler with filtering
        window.addEventListener('unhandledrejection', function(event) {
            const reason = event.reason?.message || event.reason || 'Unknown rejection';

            // Filter out extension-related promise rejections
            if (typeof reason === 'string' && (
                reason.includes('chrome-extension://') ||
                reason.includes('moz-extension://') ||
                reason.includes('safari-extension://') ||
                reason.includes('inspector') ||
                reason.includes('Extension context invalidated'))) {
                console.warn(' Filtered extension promise rejection:', reason);
                event.preventDefault(); // Prevent console error
                return;
            }

            logAdminError(event.reason, 'Unhandled Promise Rejection');
        });

        // Enhanced console error suppression with specific patterns from screenshot
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');

            // Comprehensive filter for known irrelevant errors including those from screenshot
            const errorPatterns = [
                'Minified React error',
                'chrome-extension://',
                'moz-extension://',
                'safari-extension://',
                'inspector',
                'contentScript',
                'Extension context invalidated',
                'inspector.js',
                'Uncaught Error: Minified React error',
                'Cannot access contents of',
                'Script error',
                'Non-Error promise rejection captured',
                'ResizeObserver loop limit exceeded',
                'Failed to execute \'postMessage\'',
                'SecurityError: Blocked a frame',
                'The operation was aborted',
                'NetworkError when attempting to fetch resource',
                'Failed to fetch',
                'Load failed',
                'net::ERR_',
                'DevTools',
                '__REACT_DEVTOOLS_GLOBAL_HOOK__'
            ];

            const shouldFilter = errorPatterns.some(pattern =>
                message.toLowerCase().includes(pattern.toLowerCase())
            );

            if (shouldFilter) {
                // Silently suppress these errors - don't even log them as warnings
                return;
            }

            // Log actual application errors
            originalConsoleError.apply(console, args);
        };

        // Also override console.warn for similar patterns
        const originalConsoleWarn = console.warn;
        console.warn = function(...args) {
            const message = args.join(' ');

            const warnPatterns = [
                'chrome-extension://',
                'moz-extension://',
                'inspector',
                'contentScript',
                'Extension context invalidated',
                'DevTools'
            ];

            const shouldFilter = warnPatterns.some(pattern =>
                message.toLowerCase().includes(pattern.toLowerCase())
            );

            if (shouldFilter) {
                return; // Silently suppress
            }

            originalConsoleWarn.apply(console, args);
        };

        console.log(' Enhanced global error handlers setup complete');
    }

    // Show fallback UI when initialization fails
    function showFallbackUI(error) {
        const fallbackHTML = `
            <div class="container mt-5">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Admin Panel Initialization Failed
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-3">The admin panel failed to initialize properly. This could be due to:</p>
                                <ul class="mb-3">
                                    <li>Network connectivity issues</li>
                                    <li>Firebase configuration problems</li>
                                    <li>Missing dependencies</li>
                                    <li>Browser compatibility issues</li>
                                </ul>
                                <div class="alert alert-warning">
                                    <strong>Error Details:</strong><br>
                                    <code>${error.message}</code>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" onclick="location.reload()">
                                        <i class="fas fa-sync-alt me-1"></i>Retry
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="showDiagnostics()">
                                        <i class="fas fa-stethoscope me-1"></i>Show Diagnostics
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Try to show fallback UI
        try {
            const mainContent = document.querySelector('main') || document.body;
            mainContent.innerHTML = fallbackHTML;
        } catch (uiError) {
            console.error('Failed to show fallback UI:', uiError);
        }
    }

    // Show diagnostics information
    function showDiagnostics() {
        const diagnostics = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            adminPanelStatus: window.adminPanelStatus,
            errors: window.adminPanelErrors,
            dependencies: {
                firebase: typeof firebase !== 'undefined',
                bootstrap: typeof bootstrap !== 'undefined',
                chart: typeof Chart !== 'undefined',
                exceljs: typeof ExcelJS !== 'undefined'
            }
        };

        console.log(' Admin Panel Diagnostics:', diagnostics);

        // Show diagnostics in a modal or new window
        const diagnosticsWindow = window.open('', '_blank', 'width=800,height=600');
        diagnosticsWindow.document.write(`
            <html>
                <head>
                    <title>Admin Panel Diagnostics</title>
                    <style>
                        body { font-family: monospace; padding: 20px; }
                        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto; }
                        .error { color: red; }
                        .success { color: green; }
                        .warning { color: orange; }
                    </style>
                </head>
                <body>
                    <h1>Admin Panel Diagnostics</h1>
                    <pre>${JSON.stringify(diagnostics, null, 2)}</pre>
                </body>
            </html>
        `);
    }

    // Enhanced Toast Notification System
    function showToast(message, type = 'primary', duration = 5000) {
        try {
            // Try to use Bootstrap toast if available
            const toastElement = document.getElementById('adminToast');
            const toastBody = document.getElementById('toastBody');

            if (toastElement && toastBody && typeof bootstrap !== 'undefined') {
                toastElement.className = `toast align-items-center text-bg-${type} border-0`;
                toastBody.textContent = message;

                const bsToast = new bootstrap.Toast(toastElement, { delay: duration });
                bsToast.show();
                return;
            }

            // Fallback to custom toast
            createCustomToast(message, type, duration);

        } catch (error) {
            console.error('Toast error:', error);
            // Ultimate fallback to console and alert
            console.log(`${type.toUpperCase()}: ${message}`);
            if (type === 'danger' || type === 'error') {
                alert(`Error: ${message}`);
            }
        }
    }

    // Custom toast implementation
    function createCustomToast(message, type, duration) {
        const toastContainer = document.getElementById('adminErrorContainer') || document.body;

        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'danger' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show`;
        toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';

        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;

        toastContainer.appendChild(toast);

        // Auto-remove after duration
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, duration);
    }
    
    // Excel export function
    function exportToExcel(data, filename, sheetName) {
        if (!data || data.length === 0) {
            showToast('No data to export', 'warning');
            return;
        }
        
        try {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet(sheetName);
            
            // Add column headers
            if (data.length > 0) {
                worksheet.columns = Object.keys(data[0]).map(key => {
                    return { header: key, key: key, width: 20 };
                });
            }
            
            // Add row data
            worksheet.addRows(data);
            
            // Apply styles to header row
            worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFF' } };
            worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '4A154B' } };
            
            // Save workbook
            workbook.xlsx.writeBuffer()
                .then(buffer => {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    saveAs(blob, filename);
                })
                .catch(error => {
                    console.error("Error generating Excel file:", error);
                    showToast('Error generating Excel file: ' + error.message, 'danger');
                });
        } catch (error) {
            console.error("Error creating Excel workbook:", error);
            showToast('Error creating Excel workbook: ' + error.message, 'danger');
        }
    }
    
    // Enhanced Load user logs with comprehensive filtering capabilities
    function loadUserLogs(searchTerm = '', filterType = 'all') {
        console.log(' Loading user logs with filters...', { searchTerm, filterType });

        const spinner = safeGetElement('logsSpinner', 'Load User Logs');
        const tbody = safeQuerySelector('#userLogsTable tbody', 'Load User Logs');
        const statsText = safeGetElement('logStatsText', 'Load User Logs');

        if (!tbody) {
            console.error(' User logs table body not found');
            return;
        }

        if (spinner) {
            spinner.style.display = 'flex';
        }
        tbody.innerHTML = '';

        // Check Firebase connection
        if (!firebase || !firebase.firestore) {
            console.error(' Firebase not initialized properly');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        <div class="py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p class="mb-2"><strong>Firebase Connection Error</strong></p>
                            <small class="text-muted">Unable to connect to Firebase. Please check your configuration.</small>
                        </div>
                    </td>
                </tr>
            `;
            if (spinner) spinner.style.display = 'none';
            return;
        }

        const db = firebase.firestore();

        // Get filter values
        const limitSelect = document.getElementById('logLimitSelect')?.value || '100';
        const dateFrom = document.getElementById('logDateFrom')?.value;
        const dateTo = document.getElementById('logDateTo')?.value;
        const userFilter = document.getElementById('logUserFilter')?.value || '';

        // Create base query
        let query = db.collection('userLogs');

        // Apply date filters if provided
        if (dateFrom) {
            const fromDate = new Date(dateFrom);
            fromDate.setHours(0, 0, 0, 0);
            query = query.where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(fromDate));
            console.log(' Date from filter applied:', fromDate);
        }

        if (dateTo) {
            const toDate = new Date(dateTo);
            toDate.setHours(23, 59, 59, 999);
            query = query.where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(toDate));
            console.log(' Date to filter applied:', toDate);
        }

        // Order by timestamp and apply limit
        query = query.orderBy('timestamp', 'desc');

        if (limitSelect !== 'all') {
            query = query.limit(parseInt(limitSelect));
        }

        query.get()
            .then(snapshot => {
                console.log(` Query completed. Found ${snapshot.size} user log documents`);

                if (snapshot.empty) {
                    console.log(' No user logs found in database');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="fas fa-inbox fa-2x mb-3 text-muted"></i>
                                    <p class="mb-2">No user activity logs found</p>
                                    <small class="text-muted">User activity logs will appear here when users interact with the application</small>
                                </div>
                            </td>
                        </tr>
                    `;
                    if (spinner) spinner.style.display = 'none';
                    return;
                }

                // Filter results client-side based on search term and filter type
                let filteredLogs = [];
                let processedCount = 0;

                snapshot.forEach(doc => {
                    try {
                        const logData = doc.data();
                        console.log(` Processing log ${processedCount + 1}:`, doc.id, logData);

                        // Apply search filter if provided
                        if (searchTerm) {
                            const searchFields = [
                                logData.userName || '',
                                logData.userEmail || '',
                                logData.activity || '',
                                logData.page || '',
                                logData.device || '',
                                logData.browser || '',
                                logData.os || '',
                                logData.ipAddress || ''
                            ].map(field => field.toLowerCase());

                            const termFound = searchFields.some(field => field.includes(searchTerm.toLowerCase()));
                            if (!termFound) return;
                        }

                        // Apply user filter if provided
                        if (userFilter) {
                            const userEmail = (logData.userEmail || '').toLowerCase();
                            const userName = (logData.userName || '').toLowerCase();
                            const filterLower = userFilter.toLowerCase();

                            if (!userEmail.includes(filterLower) && !userName.includes(filterLower)) {
                                return;
                            }
                        }

                        // Apply activity type filter if not 'all'
                        if (filterType !== 'all') {
                            const activity = (logData.activity || '').toLowerCase();

                            if (filterType === 'login' && !activity.includes('login') && !activity.includes('logout')) {
                                return;
                            } else if (filterType === 'attendance' && !activity.includes('attendance') && !activity.includes('marked')) {
                                return;
                            } else if (filterType === 'view' && !activity.includes('viewed') && !activity.includes('view')) {
                                return;
                            } else if (filterType === 'error' && !activity.includes('error')) {
                                return;
                            }
                        }

                        filteredLogs.push({ id: doc.id, ...logData });
                        processedCount++;
                    } catch (rowError) {
                        console.error(' Error processing log row:', rowError, doc.id);
                    }
                });

                if (filteredLogs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No matching user logs found</td></tr>';
                    if (spinner) spinner.style.display = 'none';
                    if (statsText) statsText.textContent = 'No matching logs found';
                    return;
                }

                // Populate table
                console.log(` Populating table with ${filteredLogs.length} user logs`);
                filteredLogs.forEach((logData, index) => {
                    try {
                        // Handle different timestamp formats
                        let timestamp = 'Unknown';
                        if (logData.timestamp) {
                            if (logData.timestamp.toDate) {
                                // Firestore Timestamp
                                timestamp = logData.timestamp.toDate().toLocaleString();
                            } else if (logData.timestamp.seconds) {
                                // Firestore Timestamp object
                                timestamp = new Date(logData.timestamp.seconds * 1000).toLocaleString();
                            } else if (typeof logData.timestamp === 'string' || typeof logData.timestamp === 'number') {
                                // String or number timestamp
                                timestamp = new Date(logData.timestamp).toLocaleString();
                            }
                        }

                        // Format activity with icon based on type
                        let activityIcon = '';
                        let activityText = logData.activity || 'Unknown Activity';

                        if (activityText.includes('login') || activityText.includes('Login')) {
                            activityIcon = '<i class="fas fa-sign-in-alt text-success me-2"></i>';
                        } else if (activityText.includes('attendance') || activityText.includes('Marked')) {
                            activityIcon = '<i class="fas fa-check-circle text-primary me-2"></i>';
                        } else if (activityText.includes('Viewed')) {
                            activityIcon = '<i class="fas fa-eye text-info me-2"></i>';
                        } else if (activityText.includes('logout') || activityText.includes('Logout')) {
                            activityIcon = '<i class="fas fa-sign-out-alt text-warning me-2"></i>';
                        } else if (activityText.includes('Error')) {
                            activityIcon = '<i class="fas fa-exclamation-triangle text-danger me-2"></i>';
                        } else {
                            activityIcon = '<i class="fas fa-history text-secondary me-2"></i>';
                        }

                        // Format additional data for display
                        const pageInfo = logData.page ? `${logData.page}` : 'Unknown';
                        const urlInfo = logData.url ? `<small class="text-muted d-block">${logData.url.substring(0, 40)}${logData.url.length > 40 ? '...' : ''}</small>` : '';

                        // Format device info
                        const deviceInfo = [];
                        if (logData.device) deviceInfo.push(logData.device);
                        if (logData.browser) deviceInfo.push(logData.browser);
                        if (logData.os) deviceInfo.push(logData.os);
                        const deviceDisplay = deviceInfo.length > 0 ? deviceInfo.join(' / ') : 'Unknown';

                        // Format session info
                        const sessionInfo = logData.sessionId ?
                            `<span class="badge bg-info">${logData.sessionId.substring(0, 8)}...</span>` :
                            '<span class="badge bg-secondary">No session</span>';

                        // Format additional data for details button
                        const hasDetails = logData.additionalData || logData.ipAddress || logData.url;
                        const additionalData = hasDetails ?
                            `<button class="btn btn-sm btn-outline-primary view-details-btn" data-log-id="${logData.id}">
                                <i class="fas fa-info-circle"></i> Details
                             </button>` :
                            '<span class="badge bg-secondary">No details</span>';

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><small>${timestamp}</small></td>
                            <td>
                                <strong>${logData.userName || 'Unknown User'}</strong>
                                <small class="text-muted d-block">${logData.userEmail || 'No email'}</small>
                            </td>
                            <td>
                                ${activityIcon}${activityText}
                            </td>
                            <td>
                                ${pageInfo}
                                ${urlInfo}
                            </td>
                            <td>
                                ${deviceDisplay}
                                ${logData.screenResolution ? `<small class="text-muted d-block">Screen: ${logData.screenResolution}</small>` : ''}
                            </td>
                            <td>${sessionInfo}</td>
                            <td>${additionalData}</td>
                        `;

                        try {
                            tr.addEventListener('click', () => showActivityDetails(logData.id, logData));
                            tr.style.cursor = 'pointer';
                        } catch (error) {
                            console.error("Error adding click event to log row:", error);
                        }
                        tbody.appendChild(tr);
                    } catch (rowError) {
                        console.error(' Error creating table row:', rowError, logData);
                    }
                });

                if (spinner) spinner.style.display = 'none';
                if (statsText) statsText.textContent = `Showing ${filteredLogs.length} of ${snapshot.size} logs`;

                // Show success message only for initial load, not for searches
                if (!searchTerm && filterType === 'all') {
                    showToast(` Loaded ${filteredLogs.length} user logs successfully!`, 'success');
                }

                console.log(' User logs loaded successfully');
            })
            .catch(error => {
                console.error(" Error loading user logs:", error);

                let errorMessage = error.message;
                if (error.code) {
                    errorMessage += ` (Code: ${error.code})`;
                }

                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <div class="py-4">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <p class="mb-2"><strong>Error loading activity logs</strong></p>
                                <small class="text-muted">${errorMessage}</small>
                                <br>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadUserLogs()">
                                    <i class="fas fa-sync-alt me-1"></i>Retry
                                </button>
                                ${error.code === 'permission-denied' ?
                                    '<button class="btn btn-sm btn-outline-warning mt-2 ms-2" onclick="createUserLogsCollection()"><i class="fas fa-plus me-1"></i>Create Collection</button>' :
                                    ''
                                }
                            </div>
                        </td>
                    </tr>
                `;

                if (spinner) spinner.style.display = 'none';
                showToast(' Error loading user logs: ' + errorMessage, 'danger');
            });
    }
    
    // Clear all user logs
    function clearUserLogs() {
        if (!confirm('Are you sure you want to clear all user logs? This action cannot be undone.')) {
            return;
        }
        
        const clearBtn = document.getElementById('clearLogsBtn');
        if (clearBtn) {
            clearBtn.disabled = true;
            clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Clearing...';
        }
        
        // Get all user logs
        db.collection('userLogs').get()
            .then(snapshot => {
                if (snapshot.empty) {
                    showToast('No logs to clear.', 'info');
                    return Promise.resolve();
                }
                
                // Create a batch to delete logs in batches (Firestore has a limit of 500 operations per batch)
                const batchSize = 450; // Leave some room for other operations
                let batches = [];
                let currentBatch = db.batch();
                let operationCount = 0;
                
                // Process each log
                snapshot.forEach(doc => {
                    // Skip the initial log document
                    if (doc.id === 'initial') return;
                    
                    currentBatch.delete(doc.ref);
                    operationCount++;
                    
                    // If we reach batch limit, create a new batch
                    if (operationCount >= batchSize) {
                        batches.push(currentBatch.commit());
                        currentBatch = db.batch();
                        operationCount = 0;
                    }
                });
                
                // Commit any remaining operations
                if (operationCount > 0) {
                    batches.push(currentBatch.commit());
                }
                
                // Execute all batches
                return Promise.all(batches);
            })
            .then(() => {
                // Create a new initial log entry
                return db.collection('userLogs').doc('initial').set({
                    userId: currentUser.uid,
                    userName: 'Admin',
                    userEmail: currentUser.email,
                    activity: 'Cleared all user logs',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    ipAddress: '127.0.0.1',
                    device: 'Admin Panel',
                    browser: 'Admin Browser',
                    os: 'Admin OS'
                });
            })
            .then(() => {
                showToast('User logs cleared successfully!', 'success');
                loadUserLogs(); // Reload the logs
            })
            .catch(error => {
                console.error("Error clearing user logs:", error);
                showToast('Error clearing logs: ' + error.message, 'danger');
            })
            .finally(() => {
                if (clearBtn) {
                    clearBtn.disabled = false;
                    clearBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Clear Logs';
                }
            });
    }
    
    // Export user logs to Excel
    function exportUserLogs() {
        const exportBtn = document.getElementById('exportLogsBtn');
        if (exportBtn) {
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Exporting...';
        }
        
        // Get search and filter values
        const searchTerm = document.getElementById('logSearchInput')?.value || '';
        const filterType = document.getElementById('logFilterSelect')?.value || 'all';
        
        // Create base query
        let query = db.collection('userLogs').orderBy('timestamp', 'desc');
        
        query.get()
            .then(snapshot => {
                const logsData = [];
                
                // Filter results client-side based on search term and filter type
                snapshot.forEach(doc => {
                    const logData = doc.data();
                    
                    // Apply search filter if provided
                    if (searchTerm) {
                        const searchFields = [
                            logData.userName || '',
                            logData.userEmail || '',
                            logData.activity || '',
                            logData.page || '',
                            logData.device || '',
                            logData.browser || '',
                            logData.os || '',
                            logData.ipAddress || ''
                        ].map(field => field.toLowerCase());
                        
                        const termFound = searchFields.some(field => field.includes(searchTerm.toLowerCase()));
                        if (!termFound) return;
                    }
                    
                    // Apply activity type filter if not 'all'
                    if (filterType !== 'all') {
                        const activity = (logData.activity || '').toLowerCase();
                        
                        if (filterType === 'login' && !activity.includes('login') && !activity.includes('logout')) {
                            return;
                        } else if (filterType === 'attendance' && !activity.includes('attendance') && !activity.includes('marked')) {
                            return;
                        } else if (filterType === 'view' && !activity.includes('viewed')) {
                            return;
                        }
                    }
                    
                    let timestamp = 'Unknown';
                    if (logData.timestamp) {
                        const date = logData.timestamp.toDate();
                        timestamp = date.toLocaleString();
                    }
                    
                    // Format log data for Excel with more details
                    const logExcelData = {
                        'Log ID': doc.id,
                        'User ID': logData.userId || 'Unknown',
                        'Name': logData.userName || 'Unknown',
                        'Email': logData.userEmail || 'No email',
                        'Activity': logData.activity || 'Unknown',
                        'Timestamp': timestamp,
                        'Date': logData.timestamp ? logData.timestamp.toDate().toLocaleDateString() : 'Unknown',
                        'Time': logData.timestamp ? logData.timestamp.toDate().toLocaleTimeString() : 'Unknown',
                        'IP Address': logData.ipAddress || 'Unknown',
                        'Page': logData.page || 'Unknown',
                        'Browser': logData.browser || 'Unknown',
                        'OS': logData.os || 'Unknown',
                        'Device': logData.device || 'Unknown'
                    };
                    
                    // Add any additional data if available
                    if (logData.additionalData) {
                        if (typeof logData.additionalData === 'object') {
                            Object.entries(logData.additionalData).forEach(([key, value]) => {
                                logExcelData[`Additional_${key}`] = typeof value === 'object' ? JSON.stringify(value) : value;
                            });
                        } else {
                            logExcelData['Additional Data'] = String(logData.additionalData);
                        }
                    }
                    
                    logsData.push(logExcelData);
                });
                
                // Sort by timestamp (newest first)
                logsData.sort((a, b) => {
                    const dateA = new Date(a['Timestamp'] !== 'Unknown' ? a['Timestamp'] : 0);
                    const dateB = new Date(b['Timestamp'] !== 'Unknown' ? b['Timestamp'] : 0);
                    return dateB - dateA;
                });
                
                if (logsData.length === 0) {
                    throw new Error('No logs match your search criteria');
                }
                
                // Export to Excel
                const now = new Date();
                const dateString = now.toISOString().split('T')[0];
                const filename = `user_logs_${dateString}.xlsx`;
                
                // Use try-catch to handle potential Excel export errors
                try {
                    exportToExcel(logsData, filename, 'User Logs');
                    showToast('User logs exported successfully!', 'success');
                } catch (error) {
                    console.error("Error in Excel export:", error);
                    showToast('Error exporting to Excel: ' + error.message, 'danger');
                }
            })
            .catch(error => {
                console.error("Error exporting user logs:", error);
                showToast('Failed to export user logs: ' + error.message, 'danger');
            })
            .finally(() => {
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = '<i class="fas fa-file-excel me-1"></i>Export Logs';
                }
            });
    }

    
    // Create user logs collection if it doesn't exist
    function createUserLogsCollection() {
        if (!currentUser) {
            showToast('Authentication error. Please reload the page.', 'danger');
            return;
        }
        
        showToast('Creating user logs collection...', 'info');
        db.collection('userLogs').doc('initial').set({
            userId: currentUser.uid,
            userName: 'Admin',
            userEmail: currentUser.email,
            activity: 'Created user logs collection',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            ipAddress: '127.0.0.1',
            device: 'Admin Panel',
            browser: 'Admin Browser',
            os: 'Admin OS'
        })
        .then(() => {
            showToast('User logs collection created successfully!', 'success');
            loadUserLogs();
        })
        .catch(error => {
            showToast('Error creating user logs collection: ' + error.message, 'danger');
            console.error("Error creating user logs collection:", error);
        });
    }
    
    // Load deleted reports
    function loadDeletedReports() {
        document.getElementById('deletedSpinner').style.display = 'flex';
        const tbody = document.querySelector('#deletedReportsTable tbody');
        tbody.innerHTML = '';
        
        db.collection('deletedRecords').orderBy('deletedAt', 'desc').get()
            .then(snapshot => {
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No deleted records found</td></tr>';
                    document.getElementById('deletedSpinner').style.display = 'none';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const recordData = doc.data();
                    
                    let deletedAt = 'Unknown';
                    if (recordData.deletedAt) {
                        const date = recordData.deletedAt.toDate();
                        deletedAt = date.toLocaleString();
                    }
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${recordData.itemType || 'Unknown'}</td>
                        <td>${recordData.originalId || 'Unknown'}</td>
                        <td>${JSON.stringify(recordData.itemData || {}).substring(0, 50)}...</td>
                        <td>${recordData.deletedByName || 'Unknown'}</td>
                        <td>${deletedAt}</td>
                        <td>
                            <button class="btn btn-sm btn-info view-deleted-btn">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tr.querySelector('.view-deleted-btn').addEventListener('click', () => showDeletedItemDetails(doc.id, recordData));
                    tbody.appendChild(tr);
                });
                
                document.getElementById('deletedSpinner').style.display = 'none';
                showToast('Deleted records loaded successfully!', 'success');
            })
            .catch(error => {
                console.error("Error loading deleted records:", error);
                document.getElementById('deletedSpinner').style.display = 'none';
                
                // If permission denied, try to create the collection
                if (error.code === 'permission-denied') {
                    createDeletedRecordsCollection();
                } else {
                    showToast('Error loading deleted records: ' + error.message, 'danger');
                }
            });
    }
    
    // Create deleted records collection if it doesn't exist
    function createDeletedRecordsCollection() {
        if (!currentUser) {
            showToast('Authentication error. Please reload the page.', 'danger');
            return;
        }
        
        showToast('Creating deleted records collection...', 'info');
        db.collection('deletedRecords').doc('initial').set({
            itemType: 'initialRecord',
            originalId: 'initial',
            itemData: { message: 'Initial record to establish collection' },
            deletedById: currentUser.uid,
            deletedByName: 'Admin',
            deletedByEmail: currentUser.email,
            deletedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            showToast('Deleted records collection created successfully!', 'success');
            loadDeletedReports();
        })
        .catch(error => {
            showToast('Error creating deleted records collection: ' + error.message, 'danger');
            console.error("Error creating deleted records collection:", error);
        });
    }
    
    // Load user and subject data for attendance form
    function loadAttendanceFormData() {
        // Load users for the dropdown
        const userSelect = document.getElementById('attendanceUserSelect');
        if (!userSelect) {
            console.error("Cannot find attendanceUserSelect element");
            return;
        }
        userSelect.innerHTML = '<option value="">Select a user...</option>';
        
        db.collection('users').orderBy('name').get()
            .then(snapshot => {
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = userData.name || userData.email || 'Unknown User';
                    userSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error loading users for attendance:", error);
                showToast('Error loading users: ' + error.message, 'danger');
            });
        
        // Load subjects for the dropdown
        const subjectSelect = document.getElementById('attendanceSubjectSelect');
        if (!subjectSelect) {
            console.error("Cannot find attendanceSubjectSelect element");
            return;
        }
        subjectSelect.innerHTML = '<option value="">Select a subject...</option>';
        
        db.collection('subjects').orderBy('name').get()
            .then(snapshot => {
                snapshot.forEach(doc => {
                    const subjectData = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.setAttribute('data-name', subjectData.name);
                    option.textContent = subjectData.name;
                    subjectSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error loading subjects for attendance:", error);
                showToast('Error loading subjects: ' + error.message, 'danger');
            });
        
        // Set today's date as default
        const dateInput = document.getElementById('attendanceDate');
        if (dateInput) {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0]; // Format as YYYY-MM-DD
            dateInput.value = dateString;
        }
    }
    
    // Load recent attendance records with filtering
    function loadRecentAttendance() {
        const spinner = document.getElementById('attendanceSpinner');
        if (!spinner) {
            console.error("Cannot find attendanceSpinner element");
            return;
        }
        spinner.style.display = 'flex';

        const tbody = document.querySelector('#recentAttendanceTable tbody');
        if (!tbody) {
            console.error("Cannot find recentAttendanceTable tbody element");
            if (spinner) spinner.style.display = 'none';
            return;
        }
        tbody.innerHTML = '';

        // Get filter values
        const subjectFilter = document.getElementById('attendanceFilterSubject')?.value || '';
        const statusFilter = document.getElementById('attendanceFilterStatus')?.value || '';
        const dateFilter = document.getElementById('attendanceFilterDate')?.value || '';

        // Build query with filters
        let query = db.collection('manualAttendance').orderBy('date', 'desc').limit(100);

        // Apply filters
        if (subjectFilter) {
            query = query.where('subjectName', '==', subjectFilter);
        }
        if (statusFilter) {
            query = query.where('status', '==', statusFilter);
        }
        if (dateFilter) {
            query = query.where('date', '==', dateFilter);
        }

        query.get()
            .then(snapshot => {
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No attendance records found</td></tr>';
                    updateAttendanceStatistics(0, 0, 0);
                    spinner.style.display = 'none';
                    return;
                }

                let totalPresent = 0;
                let totalAbsent = 0;
                let totalSessions = 0;

                snapshot.forEach(doc => {
                    const recordData = doc.data();
                    totalSessions++;

                    if (recordData.status === 'present') {
                        totalPresent++;
                    } else {
                        totalAbsent++;
                    }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${recordData.userName || 'Unknown'}</td>
                        <td>${recordData.subjectName || 'Unknown'}</td>
                        <td>${recordData.date || 'Unknown'}</td>
                        <td><span class="badge ${recordData.status === 'present' ? 'bg-success' : 'bg-danger'}">${recordData.status}</span></td>
                        <td>${recordData.addedByName || 'Unknown'}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary edit-attendance-btn">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-attendance-btn ms-1">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    try {
                        const editBtn = tr.querySelector('.edit-attendance-btn');
                        if (editBtn) {
                            editBtn.addEventListener('click', () => editAttendanceRecord(doc.id, recordData));
                        }
                        
                        const deleteBtn = tr.querySelector('.delete-attendance-btn');
                        if (deleteBtn) {
                            deleteBtn.addEventListener('click', () => deleteAttendanceRecord(doc.id, recordData));
                        }
                    } catch (error) {
                        console.error("Error adding event listeners to attendance buttons:", error);
                    }
                    
                    tbody.appendChild(tr);
                });

                // Update statistics
                updateAttendanceStatistics(totalPresent, totalAbsent, totalSessions);

                spinner.style.display = 'none';
            })
            .catch(error => {
                console.error("Error loading attendance records:", error);
                spinner.style.display = 'none';
                
                // If permission denied, try to create the collection
                if (error.code === 'permission-denied') {
                    createManualAttendanceCollection();
                } else {
                    showToast('Error loading attendance records: ' + error.message, 'danger');
                }
            });
    }

    // Update attendance statistics display
    function updateAttendanceStatistics(totalPresent, totalAbsent, totalSessions) {
        const attendanceRate = totalSessions > 0 ? Math.round((totalPresent / totalSessions) * 100) : 0;

        document.getElementById('totalPresentStat').textContent = totalPresent;
        document.getElementById('totalAbsentStat').textContent = totalAbsent;
        document.getElementById('totalSessionsStat').textContent = totalSessions;
        document.getElementById('attendanceRateStat').textContent = `${attendanceRate}%`;
    }

    // Generate attendance report data
    async function generateAttendanceReportData() {
        try {
            const subjectFilter = document.getElementById('attendanceFilterSubject')?.value || '';
            const statusFilter = document.getElementById('attendanceFilterStatus')?.value || '';
            const dateFilter = document.getElementById('attendanceFilterDate')?.value || '';

            // Build query with filters
            let query = db.collection('manualAttendance').orderBy('date', 'desc');

            if (subjectFilter) {
                query = query.where('subjectName', '==', subjectFilter);
            }
            if (statusFilter) {
                query = query.where('status', '==', statusFilter);
            }
            if (dateFilter) {
                query = query.where('date', '==', dateFilter);
            }

            const snapshot = await query.get();

            if (snapshot.empty) {
                showToast('No data found for the selected filters', 'warning');
                return;
            }

            // Process data for report
            const reportData = [];
            const subjectStats = {};
            const userStats = {};

            snapshot.forEach(doc => {
                const record = doc.data();
                reportData.push(record);

                // Subject statistics
                if (!subjectStats[record.subjectName]) {
                    subjectStats[record.subjectName] = { present: 0, absent: 0, total: 0 };
                }
                subjectStats[record.subjectName].total++;
                if (record.status === 'present') {
                    subjectStats[record.subjectName].present++;
                } else {
                    subjectStats[record.subjectName].absent++;
                }

                // User statistics
                if (!userStats[record.userName]) {
                    userStats[record.userName] = { present: 0, absent: 0, total: 0 };
                }
                userStats[record.userName].total++;
                if (record.status === 'present') {
                    userStats[record.userName].present++;
                } else {
                    userStats[record.userName].absent++;
                }
            });

            // Generate and download report
            generateCSVReport(reportData, subjectStats, userStats);

        } catch (error) {
            console.error('Error generating attendance report:', error);
            showToast('Error generating report: ' + error.message, 'danger');
        }
    }

    // Generate CSV report
    function generateCSVReport(reportData, subjectStats, userStats) {
        let csvContent = "data:text/csv;charset=utf-8,";

        // Add header
        csvContent += "Attendance Report Generated on " + new Date().toLocaleString() + "\n\n";

        // Individual records
        csvContent += "Individual Records\n";
        csvContent += "Student,Subject,Date,Status,Added By\n";

        reportData.forEach(record => {
            csvContent += `"${record.userName}","${record.subjectName}","${record.date}","${record.status}","${record.addedByName}"\n`;
        });

        csvContent += "\n\nSubject Statistics\n";
        csvContent += "Subject,Total Sessions,Present,Absent,Attendance Rate\n";

        Object.entries(subjectStats).forEach(([subject, stats]) => {
            const rate = Math.round((stats.present / stats.total) * 100);
            csvContent += `"${subject}",${stats.total},${stats.present},${stats.absent},${rate}%\n`;
        });

        csvContent += "\n\nStudent Statistics\n";
        csvContent += "Student,Total Sessions,Present,Absent,Attendance Rate\n";

        Object.entries(userStats).forEach(([user, stats]) => {
            const rate = Math.round((stats.present / stats.total) * 100);
            csvContent += `"${user}",${stats.total},${stats.present},${stats.absent},${rate}%\n`;
        });

        // Download the file
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `attendance_report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast('Attendance report downloaded successfully!', 'success');
    }

    // Generate PDF attendance report
    async function generateAttendancePDFReport() {
        try {
            const subjectFilter = document.getElementById('attendanceFilterSubject')?.value || '';
            const statusFilter = document.getElementById('attendanceFilterStatus')?.value || '';
            const dateFilter = document.getElementById('attendanceFilterDate')?.value || '';

            // Build query with filters
            let query = db.collection('manualAttendance').orderBy('date', 'desc');

            if (subjectFilter) {
                query = query.where('subjectName', '==', subjectFilter);
            }
            if (statusFilter) {
                query = query.where('status', '==', statusFilter);
            }
            if (dateFilter) {
                query = query.where('date', '==', dateFilter);
            }

            const snapshot = await query.get();

            if (snapshot.empty) {
                showToast('No data found for the selected filters', 'warning');
                return;
            }

            // Process data for report
            const reportData = [];
            const subjectStats = {};
            const userStats = {};

            snapshot.forEach(doc => {
                const record = doc.data();
                reportData.push(record);

                // Subject statistics
                if (!subjectStats[record.subjectName]) {
                    subjectStats[record.subjectName] = { present: 0, absent: 0, total: 0 };
                }
                subjectStats[record.subjectName].total++;
                if (record.status === 'present') {
                    subjectStats[record.subjectName].present++;
                } else {
                    subjectStats[record.subjectName].absent++;
                }

                // User statistics
                if (!userStats[record.userName]) {
                    userStats[record.userName] = { present: 0, absent: 0, total: 0 };
                }
                userStats[record.userName].total++;
                if (record.status === 'present') {
                    userStats[record.userName].present++;
                } else {
                    userStats[record.userName].absent++;
                }
            });

            // Generate PDF
            generatePDFReport(reportData, subjectStats, userStats);

        } catch (error) {
            console.error('Error generating PDF attendance report:', error);
            showToast('Error generating PDF report: ' + error.message, 'danger');
        }
    }

    // Generate PDF report using jsPDF
    function generatePDFReport(reportData, subjectStats, userStats) {
        try {
            if (!window.jspdf) {
                throw new Error('jsPDF library not loaded');
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

        // Set up the document
        doc.setFontSize(20);
        doc.text('Attendance Report', 20, 20);

        doc.setFontSize(12);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);

        // Add filters information
        let filterText = 'Filters: ';
        const subjectFilter = document.getElementById('attendanceFilterSubject')?.value;
        const statusFilter = document.getElementById('attendanceFilterStatus')?.value;
        const dateFilter = document.getElementById('attendanceFilterDate')?.value;

        if (subjectFilter) filterText += `Subject: ${subjectFilter}, `;
        if (statusFilter) filterText += `Status: ${statusFilter}, `;
        if (dateFilter) filterText += `Date: ${dateFilter}, `;
        if (filterText === 'Filters: ') filterText += 'None';

        doc.text(filterText, 20, 40);

        let yPosition = 60;

        // Individual Records Table
        doc.setFontSize(16);
        doc.text('Individual Records', 20, yPosition);
        yPosition += 10;

        const recordsTableData = reportData.map(record => [
            record.userName || 'Unknown',
            record.subjectName || 'Unknown',
            record.date || 'Unknown',
            record.status || 'Unknown',
            record.addedByName || 'Unknown'
        ]);

        doc.autoTable({
            head: [['Student', 'Subject', 'Date', 'Status', 'Added By']],
            body: recordsTableData,
            startY: yPosition,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [41, 128, 185] },
            alternateRowStyles: { fillColor: [245, 245, 245] }
        });

        yPosition = doc.lastAutoTable.finalY + 20;

        // Subject Statistics Table
        doc.setFontSize(16);
        doc.text('Subject Statistics', 20, yPosition);
        yPosition += 10;

        const subjectTableData = Object.entries(subjectStats).map(([subject, stats]) => [
            subject,
            stats.total.toString(),
            stats.present.toString(),
            stats.absent.toString(),
            `${Math.round((stats.present / stats.total) * 100)}%`
        ]);

        doc.autoTable({
            head: [['Subject', 'Total Sessions', 'Present', 'Absent', 'Attendance Rate']],
            body: subjectTableData,
            startY: yPosition,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [39, 174, 96] },
            alternateRowStyles: { fillColor: [245, 245, 245] }
        });

        yPosition = doc.lastAutoTable.finalY + 20;

        // Student Statistics Table
        if (yPosition > 250) {
            doc.addPage();
            yPosition = 20;
        }

        doc.setFontSize(16);
        doc.text('Student Statistics', 20, yPosition);
        yPosition += 10;

        const studentTableData = Object.entries(userStats).map(([user, stats]) => [
            user,
            stats.total.toString(),
            stats.present.toString(),
            stats.absent.toString(),
            `${Math.round((stats.present / stats.total) * 100)}%`
        ]);

        doc.autoTable({
            head: [['Student', 'Total Sessions', 'Present', 'Absent', 'Attendance Rate']],
            body: studentTableData,
            startY: yPosition,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [231, 76, 60] },
            alternateRowStyles: { fillColor: [245, 245, 245] }
        });

            // Save the PDF
            const fileName = `attendance_report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);

            showToast('PDF attendance report downloaded successfully!', 'success');
        } catch (error) {
            console.error('Error generating PDF report:', error);
            showToast('Error generating PDF report: ' + error.message, 'danger');

            // Report error to error manager
            if (window.errorManager) {
                window.errorManager.reportError('PDF generation failed', {
                    operation: 'generatePDFReport',
                    error: error.message
                });
            }
        }
    }

    // Export user data to PDF
    async function exportUserDataToPDF() {
        const exportBtn = document.getElementById('exportUsersPDFBtn');
        if (exportBtn) {
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Exporting...';
        }

        try {
            const snapshot = await db.collection('users').get();

            if (snapshot.empty) {
                showToast('No user data to export', 'warning');
                return;
            }

            const userData = [];
            snapshot.forEach(doc => {
                try {
                    const processedData = processUserForPDFExport(doc);
                    if (processedData) userData.push(processedData);
                } catch (err) {
                    console.error("Error processing user:", err);
                }
            });

            if (userData.length === 0) {
                showToast('No valid user data to export', 'warning');
                return;
            }

            // Generate PDF
            generateUserDataPDF(userData);
            showToast('User data PDF exported successfully!', 'success');

        } catch (error) {
            console.error('Error exporting user data to PDF:', error);
            showToast('Error exporting user data: ' + error.message, 'danger');
        } finally {
            if (exportBtn) {
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i> PDF';
            }
        }
    }

    // Process user data for PDF export
    function processUserForPDFExport(doc) {
        try {
            const data = doc.data();
            const attendanceData = data.attendanceData?.subjects || {};

            let totalPresent = 0;
            let totalAbsent = 0;
            let subjectCount = 0;

            Object.values(attendanceData).forEach(subject => {
                totalPresent += subject.present || 0;
                totalAbsent += subject.absent || 0;
                subjectCount++;
            });

            const total = totalPresent + totalAbsent;
            const attendancePercentage = total > 0 ? Math.round((totalPresent / total) * 100) : 0;

            return {
                name: data.name || 'Unknown',
                email: data.email || 'No email',
                role: data.isAdmin ? 'Admin' : 'Student',
                totalPresent: totalPresent,
                totalAbsent: totalAbsent,
                attendancePercentage: attendancePercentage,
                subjectCount: subjectCount,
                lastLogin: data.lastLogin ? new Date(data.lastLogin.toDate()).toLocaleDateString() : 'Never',
                registrationDate: data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : 'Unknown'
            };
        } catch (error) {
            console.error(`Error processing user ${doc.id}:`, error);
            return null;
        }
    }

    // Generate PDF for user data
    function generateUserDataPDF(userData) {
        try {
            if (!window.jspdf) {
                throw new Error('jsPDF library not loaded');
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

        // Set up the document
        doc.setFontSize(20);
        doc.text('User Data Report', 20, 20);

        doc.setFontSize(12);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);
        doc.text(`Total Users: ${userData.length}`, 20, 40);

        let yPosition = 60;

        // User Data Table
        doc.setFontSize(16);
        doc.text('User Information', 20, yPosition);
        yPosition += 10;

        const userTableData = userData.map(user => [
            user.name,
            user.email,
            user.role,
            user.totalPresent.toString(),
            user.totalAbsent.toString(),
            `${user.attendancePercentage}%`,
            user.lastLogin
        ]);

        doc.autoTable({
            head: [['Name', 'Email', 'Role', 'Present', 'Absent', 'Attendance %', 'Last Login']],
            body: userTableData,
            startY: yPosition,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [52, 73, 94] },
            alternateRowStyles: { fillColor: [245, 245, 245] },
            columnStyles: {
                1: { cellWidth: 40 }, // Email column
                6: { cellWidth: 25 }   // Last Login column
            }
        });

        yPosition = doc.lastAutoTable.finalY + 20;

        // Summary Statistics
        if (yPosition > 250) {
            doc.addPage();
            yPosition = 20;
        }

        doc.setFontSize(16);
        doc.text('Summary Statistics', 20, yPosition);
        yPosition += 15;

        const totalUsers = userData.length;
        const adminUsers = userData.filter(user => user.role === 'Admin').length;
        const studentUsers = totalUsers - adminUsers;
        const avgAttendance = Math.round(userData.reduce((sum, user) => sum + user.attendancePercentage, 0) / totalUsers);

        doc.setFontSize(12);
        doc.text(`Total Users: ${totalUsers}`, 20, yPosition);
        doc.text(`Admin Users: ${adminUsers}`, 20, yPosition + 10);
        doc.text(`Student Users: ${studentUsers}`, 20, yPosition + 20);
        doc.text(`Average Attendance: ${avgAttendance}%`, 20, yPosition + 30);

            // Save the PDF
            const fileName = `user_data_report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        } catch (error) {
            console.error('Error generating user data PDF:', error);
            showToast('Error generating PDF: ' + error.message, 'danger');

            // Report error to error manager
            if (window.errorManager) {
                window.errorManager.reportError('User data PDF generation failed', {
                    operation: 'generateUserDataPDF',
                    error: error.message
                });
            }
        }
    }

    // System health check function
    async function performSystemHealthCheck() {
        const healthStatus = {
            firebase: false,
            firestore: false,
            auth: false,
            errorManager: false,
            logger: false,
            activityTracker: false,
            pdfExport: false
        };

        try {
            // Check Firebase
            healthStatus.firebase = typeof firebase !== 'undefined' && firebase.apps.length > 0;

            // Check Firestore
            if (healthStatus.firebase) {
                try {
                    await firebase.firestore().collection('test').limit(1).get();
                    healthStatus.firestore = true;
                } catch (error) {
                    console.warn('Firestore health check failed:', error);
                }
            }

            // Check Auth
            healthStatus.auth = typeof firebase.auth === 'function';

            // Check Error Manager
            healthStatus.errorManager = typeof window.errorManager !== 'undefined';

            // Check Logger
            healthStatus.logger = typeof window.logger !== 'undefined';

            // Check Activity Tracker
            healthStatus.activityTracker = typeof window.activityTracker !== 'undefined';

            // Check PDF Export
            healthStatus.pdfExport = typeof window.jspdf !== 'undefined';

        } catch (error) {
            console.error('System health check error:', error);
        }

        // Log health status
        console.log('System Health Check:', healthStatus);

        // Calculate overall health score
        const totalChecks = Object.keys(healthStatus).length;
        const passedChecks = Object.values(healthStatus).filter(status => status).length;
        const healthScore = Math.round((passedChecks / totalChecks) * 100);

        console.log(`System Health Score: ${healthScore}% (${passedChecks}/${totalChecks} checks passed)`);

        // Show health status in UI if element exists
        const healthElement = document.getElementById('systemHealthStatus');
        if (healthElement) {
            const healthClass = healthScore >= 90 ? 'success' : healthScore >= 70 ? 'warning' : 'danger';
            healthElement.innerHTML = `
                <span class="badge bg-${healthClass}">
                    System Health: ${healthScore}%
                </span>
            `;
        }

        return healthStatus;
    }

    // Comprehensive integration verification
    async function verifyIntegration() {
        console.log(' Starting comprehensive integration verification...');

        const integrationChecks = {
            userManagement: false,
            attendanceTracking: false,
            notificationSystem: false,
            errorLogging: false,
            dataExport: false,
            mobileNavigation: false,
            themeSystem: false,
            activityTracking: false
        };

        try {
            // Check user management functionality
            const userTable = document.getElementById('adminTable');
            integrationChecks.userManagement = userTable !== null;

            // Check attendance tracking
            const attendanceTable = document.getElementById('recentAttendanceTable');
            integrationChecks.attendanceTracking = attendanceTable !== null;

            // Check notification system
            const notificationForm = document.getElementById('notificationForm');
            integrationChecks.notificationSystem = notificationForm !== null;

            // Check error logging
            const errorLogsTable = document.getElementById('errorLogsTableBody');
            integrationChecks.errorLogging = errorLogsTable !== null;

            // Check data export functionality
            const exportButtons = document.querySelectorAll('[id*="export"], [id*="PDF"]');
            integrationChecks.dataExport = exportButtons.length > 0;

            // Check mobile navigation
            const bottomNav = document.querySelector('.bottom-nav');
            integrationChecks.mobileNavigation = bottomNav !== null;



            // Check activity tracking
            integrationChecks.activityTracking = typeof window.activityTracker !== 'undefined';

            // Calculate integration score
            const totalChecks = Object.keys(integrationChecks).length;
            const passedChecks = Object.values(integrationChecks).filter(check => check).length;
            const integrationScore = Math.round((passedChecks / totalChecks) * 100);

            console.log('Integration Verification Results:', integrationChecks);
            console.log(`Integration Score: ${integrationScore}% (${passedChecks}/${totalChecks} features verified)`);

            // Update system health with integration status
            const healthElement = document.getElementById('systemHealthStatus');
            if (healthElement && integrationScore >= 90) {
                healthElement.innerHTML = `
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>System Healthy: ${integrationScore}%
                    </span>
                `;
            } else if (healthElement && integrationScore >= 70) {
                healthElement.innerHTML = `
                    <span class="badge bg-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>System Warning: ${integrationScore}%
                    </span>
                `;
            } else if (healthElement) {
                healthElement.innerHTML = `
                    <span class="badge bg-danger">
                        <i class="fas fa-times-circle me-1"></i>System Issues: ${integrationScore}%
                    </span>
                `;
            }

            return integrationChecks;
        } catch (error) {
            console.error('Integration verification error:', error);
            return integrationChecks;
        }
    }

    // Comprehensive Bug Fixes and Error Handling
    function initializeBugFixes() {
        console.log(' Initializing comprehensive bug fixes...');

        // Fix potential null reference errors
        const criticalElements = [
            'adminLoginContainer',
            'adminDashboard',
            'userLogsTable',
            'errorLogsTableBody',
            'logsSpinner',
            'errorLogsSpinner'
        ];

        criticalElements.forEach(elementId => {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(` Critical element missing: ${elementId}`);
                // Create placeholder element to prevent null reference errors
                const placeholder = document.createElement('div');
                placeholder.id = elementId;
                placeholder.style.display = 'none';
                document.body.appendChild(placeholder);
            }
        });

        // Fix potential Firebase initialization issues
        if (typeof firebase === 'undefined') {
            console.error(' Firebase not loaded. Adding fallback handling.');
            window.firebase = {
                firestore: () => ({
                    collection: () => ({
                        get: () => Promise.reject(new Error('Firebase not initialized')),
                        orderBy: () => ({ get: () => Promise.reject(new Error('Firebase not initialized')) })
                    })
                }),
                auth: () => ({
                    onAuthStateChanged: () => {},
                    signInWithEmailAndPassword: () => Promise.reject(new Error('Firebase not initialized')),
                    signOut: () => Promise.reject(new Error('Firebase not initialized'))
                })
            };
        }

        // Fix potential Bootstrap modal issues
        if (typeof bootstrap === 'undefined') {
            console.warn(' Bootstrap not loaded. Adding fallback modal handling.');
            window.bootstrap = {
                Modal: function(element) {
                    return {
                        show: () => console.warn('Bootstrap Modal not available'),
                        hide: () => console.warn('Bootstrap Modal not available'),
                        getInstance: () => ({ hide: () => console.warn('Bootstrap Modal not available') })
                    };
                },
                Toast: function(element) {
                    return {
                        show: () => console.warn('Bootstrap Toast not available')
                    };
                }
            };
        }

        // Fix potential Chart.js issues
        if (typeof Chart === 'undefined') {
            console.warn(' Chart.js not loaded. Adding fallback chart handling.');
            window.Chart = function() {
                return {
                    destroy: () => {},
                    update: () => {},
                    data: { datasets: [] }
                };
            };
        }

        console.log(' Bug fixes initialized successfully');
    }

    // Enhanced error logging function
    function logError(error, context = 'Unknown', additionalData = {}) {
        const errorData = {
            errorId: `ERR-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            timestamp: firebase?.firestore?.FieldValue?.serverTimestamp() || new Date(),
            type: error.name || 'Error',
            message: error.message || 'Unknown error',
            stack: error.stack || 'No stack trace',
            context: context,
            page: window.location.pathname,
            url: window.location.href,
            userAgent: navigator.userAgent,
            userName: currentUser?.displayName || 'Unknown',
            userEmail: currentUser?.email || 'Unknown',
            additionalData: additionalData
        };

        console.error(' Error logged:', errorData);

        // Try to save to Firebase if available
        if (firebase?.firestore && currentUser) {
            try {
                firebase.firestore().collection('errorLogs').add(errorData)
                    .catch(saveError => {
                        console.error('Failed to save error to Firebase:', saveError);
                    });
            } catch (saveError) {
                console.error('Failed to save error to Firebase:', saveError);
            }
        }

        return errorData;
    }

    // Fix common issues and improve stability
    function fixCommonIssues() {
        console.log(' Applying common issue fixes...');

        // Fix table click events that might fail
        document.addEventListener('click', function(event) {
            const target = event.target;

            // Handle view details buttons safely
            if (target.classList.contains('view-details-btn')) {
                event.preventDefault();
                const logId = target.getAttribute('data-log-id');
                if (logId) {
                    try {
                        // Find the log data from the table row
                        const row = target.closest('tr');
                        if (row) {
                            // Extract data from the row or use a fallback
                            showActivityDetails(logId, { id: logId, activity: 'Details requested' });
                        }
                    } catch (error) {
                        console.error('Error showing activity details:', error);
                        showToast('Error showing details. Please try again.', 'warning');
                    }
                }
            }
        });

        // Fix potential memory leaks from chart instances
        window.addEventListener('beforeunload', function() {
            // Destroy chart instances if they exist
            if (window.userAttendanceChartInstance) {
                try {
                    window.userAttendanceChartInstance.destroy();
                } catch (error) {
                    console.warn('Error destroying user attendance chart:', error);
                }
            }

            if (window.subjectAttendanceChartInstance) {
                try {
                    window.subjectAttendanceChartInstance.destroy();
                } catch (error) {
                    console.warn('Error destroying subject attendance chart:', error);
                }
            }
        });

        // Fix potential issues with form submissions
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(event) {
                // Prevent double submissions
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn && submitBtn.disabled) {
                    event.preventDefault();
                    return false;
                }

                // Disable submit button temporarily
                if (submitBtn) {
                    submitBtn.disabled = true;
                    setTimeout(() => {
                        submitBtn.disabled = false;
                    }, 2000);
                }
            });
        });

        // Fix potential issues with modal dialogs
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('hidden.bs.modal', function() {
                // Clear any form data when modal is closed
                const forms = modal.querySelectorAll('form');
                forms.forEach(form => {
                    try {
                        form.reset();
                    } catch (error) {
                        console.warn('Error resetting form:', error);
                    }
                });
            });
        });

        // Fix potential issues with date inputs
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach(input => {
            input.addEventListener('change', function() {
                // Validate date is not in the future for attendance records
                if (this.id.includes('attendance') || this.id.includes('Date')) {
                    const selectedDate = new Date(this.value);
                    const today = new Date();
                    today.setHours(23, 59, 59, 999);

                    if (selectedDate > today) {
                        showToast('Cannot select future dates for attendance records', 'warning');
                        this.value = today.toISOString().split('T')[0];
                    }
                }
            });
        });

        // Fix potential issues with search inputs
        const searchInputs = document.querySelectorAll('input[type="search"], input[placeholder*="search"], input[placeholder*="Search"]');
        searchInputs.forEach(input => {
            let searchTimeout;
            input.addEventListener('input', function() {
                // Debounce search to prevent excessive API calls
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    // Trigger search only if input has meaningful content
                    if (this.value.length >= 2 || this.value.length === 0) {
                        const event = new KeyboardEvent('keyup', { key: 'Enter' });
                        this.dispatchEvent(event);
                    }
                }, 500);
            });
        });

        // Fix potential issues with number inputs
        const numberInputs = document.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            input.addEventListener('input', function() {
                // Ensure number inputs have valid values
                if (this.value && isNaN(this.value)) {
                    this.value = '';
                    showToast('Please enter a valid number', 'warning');
                }
            });
        });

        console.log(' Common issue fixes applied successfully');
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize bug fixes first
        initializeBugFixes();

        // Add global error handling
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            logError(event.error, 'Global Error Handler', {
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
            showToast('An error occurred. Check console for details.', 'danger');
        });

        // Add Promise rejection handling
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            logError(event.reason, 'Unhandled Promise Rejection');
            showToast('A promise error occurred. Check console for details.', 'danger');
        });
        
        // Check if running on Netlify
        checkNetlifyEnvironment();

        // Additional bug fixes and improvements
        fixCommonIssues();
        
        // Auth state change listener
        auth.onAuthStateChanged(function(user) {
            const adminLoginContainer = safeGetElement('adminLoginContainer', 'Auth State Change');
            const adminDashboard = safeGetElement('adminDashboard', 'Auth State Change');
            
            if (user) {
                currentUser = user;
                // Check if user is admin
                if (checkAdmin(user.email)) {
                    console.log("Admin authenticated:", user.email);
                    adminLoginContainer.style.display = 'none';
                    adminDashboard.style.display = 'block';
                    
                    // Load data for the dashboard
                    loadUserData();
                    loadSubjects();
                    loadUserLogs();
                    loadErrorLogs();
                    loadDeletedReports();
                    loadAttendanceFormData();
                    loadRecentAttendance();

                    // Perform system health check and integration verification
                    setTimeout(async () => {
                        await performSystemHealthCheck();
                        await verifyIntegration();
                        console.log(' Admin panel initialization complete');
                    }, 2000);

                    // Notification management will be initialized by initializeAdminFeatures()

                    // Add listener for save subject changes button
                    const saveSubjectBtn = document.getElementById('saveSubjectChanges');
                    if (saveSubjectBtn) {
                        saveSubjectBtn.addEventListener('click', updateSubject);
                    }
                    
                    // Add listener for save attendance changes button
                    const saveAttendanceBtn = document.getElementById('saveAttendanceChanges');
                    if (saveAttendanceBtn) {
                        saveAttendanceBtn.addEventListener('click', updateAttendanceRecord);
                    }
                    
                    // Add listener for add attendance button
                    const addAttendanceBtn = document.getElementById('addAttendanceBtn');
                    if (addAttendanceBtn) {
                        addAttendanceBtn.addEventListener('click', addManualAttendance);
                    }
                    
                    // Add listener for Excel export buttons
                    const exportExcelBtn = document.getElementById('exportExcelBtn');
                    if (exportExcelBtn) {
                        exportExcelBtn.addEventListener('click', exportUserData);
                    }

                    const exportUsersPDFBtn = document.getElementById('exportUsersPDFBtn');
                    if (exportUsersPDFBtn) {
                        exportUsersPDFBtn.addEventListener('click', exportUserDataToPDF);
                    }
                    
                    const exportLogsBtn = document.getElementById('exportLogsBtn');
                    if (exportLogsBtn) {
                        exportLogsBtn.addEventListener('click', exportUserLogs);
                    }
                    
                    const exportDeletedBtn = document.getElementById('exportDeletedBtn');
                    if (exportDeletedBtn) {
                        exportDeletedBtn.addEventListener('click', exportDeletedReports);
                    }
                    
                    // Add listeners for refresh buttons
                    const refreshLogsBtn = document.getElementById('refreshLogsBtn');
                    if (refreshLogsBtn) {
                        refreshLogsBtn.addEventListener('click', () => loadUserLogs());
                    }
                    
                    const refreshDeletedBtn = document.getElementById('refreshDeletedBtn');
                    if (refreshDeletedBtn) {
                        refreshDeletedBtn.addEventListener('click', loadDeletedReports);
                    }
                    
                    // Add listener for clear logs button
                    const clearLogsBtn = document.getElementById('clearLogsBtn');
                    if (clearLogsBtn) {
                        clearLogsBtn.addEventListener('click', clearUserLogs);
                    }
                    
                    // Add listener for search logs button
                    const searchLogsBtn = document.getElementById('searchLogsBtn');
                    if (searchLogsBtn) {
                        searchLogsBtn.addEventListener('click', () => {
                            const searchTerm = document.getElementById('logSearchInput').value;
                            const filterType = document.getElementById('logFilterSelect').value;
                            loadUserLogs(searchTerm, filterType);
                        });
                    }
                    
                    // Add listener for log search input (search on Enter key)
                    const logSearchInput = document.getElementById('logSearchInput');
                    if (logSearchInput) {
                        logSearchInput.addEventListener('keyup', (event) => {
                            if (event.key === 'Enter') {
                                const searchTerm = logSearchInput.value;
                                const filterType = document.getElementById('logFilterSelect').value;
                                loadUserLogs(searchTerm, filterType);
                            }
                        });
                    }

                    // Add listeners for new filter controls
                    const logLimitSelect = document.getElementById('logLimitSelect');
                    if (logLimitSelect) {
                        logLimitSelect.addEventListener('change', () => {
                            const searchTerm = document.getElementById('logSearchInput').value;
                            const filterType = document.getElementById('logFilterSelect').value;
                            loadUserLogs(searchTerm, filterType);
                        });
                    }

                    const logDateFrom = document.getElementById('logDateFrom');
                    if (logDateFrom) {
                        logDateFrom.addEventListener('change', () => {
                            const searchTerm = document.getElementById('logSearchInput').value;
                            const filterType = document.getElementById('logFilterSelect').value;
                            loadUserLogs(searchTerm, filterType);
                        });
                    }

                    const logDateTo = document.getElementById('logDateTo');
                    if (logDateTo) {
                        logDateTo.addEventListener('change', () => {
                            const searchTerm = document.getElementById('logSearchInput').value;
                            const filterType = document.getElementById('logFilterSelect').value;
                            loadUserLogs(searchTerm, filterType);
                        });
                    }

                    const logUserFilter = document.getElementById('logUserFilter');
                    if (logUserFilter) {
                        logUserFilter.addEventListener('keyup', (event) => {
                            if (event.key === 'Enter') {
                                const searchTerm = document.getElementById('logSearchInput').value;
                                const filterType = document.getElementById('logFilterSelect').value;
                                loadUserLogs(searchTerm, filterType);
                            }
                        });
                    }

                    const clearLogFiltersBtn = document.getElementById('clearLogFiltersBtn');
                    if (clearLogFiltersBtn) {
                        clearLogFiltersBtn.addEventListener('click', () => {
                            document.getElementById('logSearchInput').value = '';
                            document.getElementById('logFilterSelect').value = 'all';
                            document.getElementById('logLimitSelect').value = '100';
                            document.getElementById('logDateFrom').value = '';
                            document.getElementById('logDateTo').value = '';
                            document.getElementById('logUserFilter').value = '';
                            loadUserLogs();
                        });
                    }

                    const viewFullActivityLogBtn = document.getElementById('viewFullActivityLogBtn');
                    if (viewFullActivityLogBtn) {
                        viewFullActivityLogBtn.addEventListener('click', () => {
                            openFullActivityLogModal();
                        });
                    }
                    
                    // Add listener for log filter select (filter changes)
                    const logFilterSelect = document.getElementById('logFilterSelect');
                    if (logFilterSelect) {
                        logFilterSelect.addEventListener('change', () => {
                            const searchTerm = document.getElementById('logSearchInput').value;
                            const filterType = logFilterSelect.value;
                            loadUserLogs(searchTerm, filterType);
                        });
                    }

                    // Add listeners for error logs
                    const refreshErrorLogsBtn = document.getElementById('refreshErrorLogsBtn');
                    if (refreshErrorLogsBtn) {
                        refreshErrorLogsBtn.addEventListener('click', () => {
                            loadErrorLogs();
                        });
                    }

                    const errorSearchInput = document.getElementById('errorSearchInput');
                    if (errorSearchInput) {
                        errorSearchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value;
                            loadErrorLogs(searchTerm);
                        });
                    }

                    // Add listeners for error log filters
                    const errorTypeFilter = document.getElementById('errorTypeFilter');
                    if (errorTypeFilter) {
                        errorTypeFilter.addEventListener('change', () => {
                            const searchTerm = document.getElementById('errorSearchInput')?.value || '';
                            loadErrorLogs(searchTerm);
                        });
                    }

                    const errorDateFrom = document.getElementById('errorDateFrom');
                    if (errorDateFrom) {
                        errorDateFrom.addEventListener('change', () => {
                            const searchTerm = document.getElementById('errorSearchInput')?.value || '';
                            loadErrorLogs(searchTerm);
                        });
                    }

                    const errorDateTo = document.getElementById('errorDateTo');
                    if (errorDateTo) {
                        errorDateTo.addEventListener('change', () => {
                            const searchTerm = document.getElementById('errorSearchInput')?.value || '';
                            loadErrorLogs(searchTerm);
                        });
                    }

                    const clearErrorFiltersBtn = document.getElementById('clearErrorFiltersBtn');
                    if (clearErrorFiltersBtn) {
                        clearErrorFiltersBtn.addEventListener('click', () => {
                            document.getElementById('errorSearchInput').value = '';
                            document.getElementById('errorTypeFilter').value = '';
                            document.getElementById('errorDateFrom').value = '';
                            document.getElementById('errorDateTo').value = '';
                            loadErrorLogs();
                        });
                    }

                    const generateTestErrorsBtn = document.getElementById('generateTestErrorsBtn');
                    if (generateTestErrorsBtn) {
                        generateTestErrorsBtn.addEventListener('click', generateTestErrorLogs);
                    }

                    const clearErrorLogsBtn = document.getElementById('clearErrorLogsBtn');
                    if (clearErrorLogsBtn) {
                        clearErrorLogsBtn.addEventListener('click', clearAllErrorLogs);
                    }

                    const toggleErrorChartsBtn = document.getElementById('toggleErrorChartsBtn');
                    if (toggleErrorChartsBtn) {
                        toggleErrorChartsBtn.addEventListener('click', toggleErrorAnalytics);
                    }

                    // Add listeners for attendance filtering
                    const attendanceFilterSubject = document.getElementById('attendanceFilterSubject');
                    const attendanceFilterStatus = document.getElementById('attendanceFilterStatus');
                    const attendanceFilterDate = document.getElementById('attendanceFilterDate');
                    const generateAttendanceReport = document.getElementById('generateAttendanceReport');

                    if (attendanceFilterSubject) {
                        attendanceFilterSubject.addEventListener('change', () => {
                            loadRecentAttendance();
                        });
                    }

                    if (attendanceFilterStatus) {
                        attendanceFilterStatus.addEventListener('change', () => {
                            loadRecentAttendance();
                        });
                    }

                    if (attendanceFilterDate) {
                        attendanceFilterDate.addEventListener('change', () => {
                            loadRecentAttendance();
                        });
                    }

                    if (generateAttendanceReport) {
                        generateAttendanceReport.addEventListener('click', () => {
                            generateAttendanceReportData();
                        });
                    }

                    const generateAttendancePDF = document.getElementById('generateAttendancePDF');
                    if (generateAttendancePDF) {
                        generateAttendancePDF.addEventListener('click', () => {
                            generateAttendancePDFReport();
                        });
                    }
                } else {
                    console.log("Non-admin user:", user.email);
                    adminLoginContainer.style.display = 'block';
                    adminDashboard.style.display = 'none';
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('loginError').textContent = 'You do not have admin privileges.';
                }
            } else {
                console.log("No user authenticated");
                adminLoginContainer.style.display = 'block';
                adminDashboard.style.display = 'none';
            }
        });
        
        // Admin login button
        const adminLoginBtn = safeGetElement('adminLoginBtn', 'Admin Login Setup');
        if (adminLoginBtn) {
            adminLoginBtn.addEventListener('click', async () => {
                const email = safeGetValue('adminEmail', '', 'Admin Login');
                const password = safeGetValue('adminPassword', '', 'Admin Login');

                console.log("Admin login attempt for email:", email);

                if (!email || !password) {
                    document.getElementById('loginError').textContent = 'Please enter email and password';
                    document.getElementById('loginError').style.display = 'block';
                    return;
                }

                // Hide previous errors
                document.getElementById('loginError').style.display = 'none';

                adminLoginBtn.disabled = true;
                adminLoginBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Logging in...';

                try {
                    // Use the new admin authentication module
                    if (window.adminAuth && window.adminAuth.signIn) {
                        await window.adminAuth.signIn(email, password);
                        console.log(" Admin login successful");

                        // Clear form
                        document.getElementById('adminEmail').value = '';
                        document.getElementById('adminPassword').value = '';
                    } else {
                        // Fallback to original authentication if new module not available
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        console.log("Firebase authentication successful for:", userCredential.user.email);

                        if (!checkAdmin(userCredential.user.email)) {
                            console.log("User is not an admin, signing out");
                            auth.signOut();
                            throw new Error('Access denied. You need admin privileges.');
                        } else {
                            console.log("Admin login successful");
                        }
                    }

                } catch (error) {
                    console.error(" Admin login error:", error);
                    let errorMessage = error.message;

                    // Provide more user-friendly error messages
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'No account found with this email address.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password. Please try again.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email address format.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Too many failed login attempts. Please try again later.';
                    }

                    document.getElementById('loginError').textContent = errorMessage;
                    document.getElementById('loginError').style.display = 'block';
                } finally {
                    adminLoginBtn.disabled = false;
                    adminLoginBtn.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Sign In';
                }
            });
        }

        // Add Enter key support for admin login
        document.getElementById('adminEmail').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('adminLoginBtn').click();
            }
        });

        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('adminLoginBtn').click();
            }
        });

        // Logout button
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                // Show loading if available
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }

                // Log logout activity before signing out
                if (window.logUserActivity) {
                    window.logUserActivity('Admin logout initiated', {
                        logoutTime: new Date().toISOString(),
                        userType: 'admin'
                    });
                }

                try {
                    // Use the new admin authentication module
                    if (window.adminAuth && window.adminAuth.signOut) {
                        await window.adminAuth.signOut();
                    } else {
                        // Fallback to original authentication
                        await auth.signOut();
                    }

                    console.log(' Admin logged out successfully');
                    showToast('Logged out successfully', 'info');

                    // Log successful logout
                    if (window.logUserActivity) {
                        window.logUserActivity('Admin logout successful', {
                            logoutTime: new Date().toISOString(),
                            userType: 'admin',
                            logoutSuccess: true
                        });
                    }

                    // Clear any cached data
                    if (typeof localStorage !== 'undefined') {
                        localStorage.clear();
                    }
                    if (typeof sessionStorage !== 'undefined') {
                        sessionStorage.clear();
                    }

                    // Redirect to login page
                    setTimeout(() => {
                        window.location.replace('login.html');
                    }, 1000);

                } catch (error) {
                    console.error(' Admin logout error:', error);
                    showToast('Logout failed, redirecting anyway', 'warning');

                    // Log failed logout
                    if (window.logUserActivity) {
                        window.logUserActivity('Admin logout failed', {
                            logoutTime: new Date().toISOString(),
                            userType: 'admin',
                            errorCode: error.code,
                            errorMessage: error.message,
                            logoutSuccess: false
                        });
                    }

                    // Force logout even if signOut fails
                    setTimeout(() => {
                        window.location.replace('login.html');
                    }, 1500);
                } finally {
                    // Hide loading overlay
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                }
            });
        }



        // Refresh button
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                loadUserData();
            });
        }

        // Add subject button
        const addSubjectBtn = document.getElementById('addSubjectBtn');
        if (addSubjectBtn) {
            addSubjectBtn.addEventListener('click', addSubject);
        }

        // Function Management Event Listeners
        initializeFunctionManagement();
    });

    // Function Management System
    function initializeFunctionManagement() {
        const functionLog = document.getElementById('functionExecutionLog');

        function logToFunctionConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'info': 'text-info',
                'success': 'text-success',
                'warning': 'text-warning',
                'error': 'text-danger'
            }[type] || 'text-light';

            const logEntry = document.createElement('div');
            logEntry.className = colorClass;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
        }

        // Clear function log
        document.getElementById('clearFunctionLogBtn')?.addEventListener('click', () => {
            functionLog.innerHTML = '<div class="text-success">Function Management System Ready</div><div class="text-muted">Execute functions using the buttons above. Results will appear here.</div>';
        });

        // Database Functions
        document.getElementById('createInitialDataBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Create Initial User Data...', 'info');
            createInitialUserData();
        });

        document.getElementById('createSampleDataBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Create Sample Users...', 'info');
            createSampleUsers();
        });

        document.getElementById('createUserLogsBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Initialize User Logs...', 'info');
            createUserLogsCollection();
        });

        document.getElementById('clearUserLogsBtn')?.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all user logs? This action cannot be undone.')) {
                logToFunctionConsole('Executing: Clear All User Logs...', 'warning');
                clearAllUserLogs();
            }
        });

        // System Functions
        document.getElementById('testFirebaseConnectionBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Test Firebase Connection...', 'info');
            testFirebaseConnection();
        });

        document.getElementById('validateDataIntegrityBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Validate Data Integrity...', 'info');
            validateDataIntegrity();
        });

        document.getElementById('exportSystemLogsBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Export System Logs...', 'info');
            exportSystemLogs();
        });

        document.getElementById('resetCacheBtn')?.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset the application cache?')) {
                logToFunctionConsole('Executing: Reset Application Cache...', 'warning');
                resetApplicationCache();
            }
        });

        // User Management Functions
        document.getElementById('syncUserDataBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Sync User Data...', 'info');
            syncUserData();
        });

        document.getElementById('validateUserAccountsBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Validate User Accounts...', 'info');
            validateUserAccounts();
        });

        document.getElementById('generateUserReportBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Generate User Report...', 'info');
            generateUserReport();
        });

        document.getElementById('cleanupInactiveUsersBtn')?.addEventListener('click', () => {
            if (confirm('Are you sure you want to cleanup inactive users? This will remove users who haven\'t logged in for 90+ days.')) {
                logToFunctionConsole('Executing: Cleanup Inactive Users...', 'warning');
                cleanupInactiveUsers();
            }
        });

        // Maintenance Functions
        document.getElementById('optimizeDatabaseBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Optimize Database...', 'info');
            optimizeDatabase();
        });

        document.getElementById('backupDataBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Backup Data...', 'info');
            backupData();
        });

        document.getElementById('runHealthCheckBtn')?.addEventListener('click', () => {
            logToFunctionConsole('Executing: Run Health Check...', 'info');
            runHealthCheck();
        });

        document.getElementById('emergencyResetBtn')?.addEventListener('click', () => {
            if (confirm('EMERGENCY RESET: This will reset critical system components. Are you absolutely sure?')) {
                if (confirm('This is your final warning. Emergency reset cannot be undone. Continue?')) {
                    logToFunctionConsole('Executing: Emergency Reset...', 'error');
                    emergencyReset();
                }
            }
        });
    }

    // Function Management Implementation
    async function createInitialUserData() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Creating initial user data structure...', 'info');

            // Create initial collections if they don't exist
            const collections = ['users', 'attendance', 'subjects', 'notifications'];
            for (const collection of collections) {
                const docRef = firebase.firestore().collection(collection).doc('_init');
                await docRef.set({
                    created: firebase.firestore.FieldValue.serverTimestamp(),
                    purpose: 'Initial collection creation'
                });
                logToConsole(` Collection '${collection}' initialized`, 'success');
            }

            logToConsole('Initial user data structure created successfully!', 'success');
            showToast('Initial user data created successfully', 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Error: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Error creating initial data: ' + error.message, 'error');
        }
    }

    async function createSampleUsers() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Creating sample users...', 'info');

            const sampleUsers = [
                { name: 'John Doe', email: 'john.doe@example.com', role: 'student', usn: 'STU001' },
                { name: 'Jane Smith', email: 'jane.smith@example.com', role: 'student', usn: 'STU002' },
                { name: 'Bob Johnson', email: 'bob.johnson@example.com', role: 'teacher', usn: 'TCH001' },
                { name: 'Alice Brown', email: 'alice.brown@example.com', role: 'student', usn: 'STU003' }
            ];

            for (const user of sampleUsers) {
                const userDoc = {
                    ...user,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: null,
                    isActive: true
                };

                await firebase.firestore().collection('users').doc(user.usn).set(userDoc);
                logToConsole(` Created user: ${user.name} (${user.usn})`, 'success');
            }

            logToConsole(`Sample users created successfully! Total: ${sampleUsers.length}`, 'success');
            showToast('Sample users created successfully', 'success');
            loadUserData(); // Refresh the user list
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Error: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Error creating sample users: ' + error.message, 'error');
        }
    }

    async function createUserLogsCollection() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Initializing user logs collection...', 'info');

            // Create user logs collection with initial structure
            const logDoc = {
                initialized: firebase.firestore.FieldValue.serverTimestamp(),
                purpose: 'User activity logging system',
                version: '1.0'
            };

            await firebase.firestore().collection('userLogs').doc('_system').set(logDoc);
            logToConsole(' User logs collection initialized', 'success');

            logToConsole('User logs collection ready for activity tracking', 'success');
            showToast('User logs collection initialized successfully', 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Error: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Error initializing user logs: ' + error.message, 'error');
        }
    }

    async function clearAllUserLogs() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Clearing all user logs...', 'warning');

            const logsSnapshot = await firebase.firestore().collection('userLogs').get();
            const batch = firebase.firestore().batch();
            let deleteCount = 0;

            logsSnapshot.forEach((doc) => {
                if (doc.id !== '_system') { // Keep system initialization doc
                    batch.delete(doc.ref);
                    deleteCount++;
                }
            });

            await batch.commit();
            logToConsole(` Cleared ${deleteCount} user log entries`, 'success');

            logToConsole('All user logs cleared successfully', 'success');
            showToast(`Cleared ${deleteCount} user log entries`, 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Error: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Error clearing user logs: ' + error.message, 'error');
        }
    }

    // System Functions Implementation
    async function testFirebaseConnection() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Testing Firebase connection...', 'info');

            // Test Firestore connection
            const testDoc = await firebase.firestore().collection('_test').doc('connection').get();
            logToConsole(' Firestore connection successful', 'success');

            // Test Authentication
            const user = firebase.auth().currentUser;
            if (user) {
                logToConsole(` Authentication active (User: ${user.email})`, 'success');
            } else {
                logToConsole(' No authenticated user', 'warning');
            }

            logToConsole('Firebase connection test completed successfully', 'success');
            showToast('Firebase connection test passed', 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Connection test failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Firebase connection test failed: ' + error.message, 'error');
        }
    }

    async function validateDataIntegrity() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Validating data integrity...', 'info');

            // Check users collection
            const usersSnapshot = await firebase.firestore().collection('users').get();
            logToConsole(` Users collection: ${usersSnapshot.size} documents`, 'success');

            // Check attendance collection
            const attendanceSnapshot = await firebase.firestore().collection('attendance').get();
            logToConsole(` Attendance collection: ${attendanceSnapshot.size} documents`, 'success');

            // Check subjects collection
            const subjectsSnapshot = await firebase.firestore().collection('subjects').get();
            logToConsole(` Subjects collection: ${subjectsSnapshot.size} documents`, 'success');

            // Check notifications collection
            const notificationsSnapshot = await firebase.firestore().collection('notifications').get();
            logToConsole(` Notifications collection: ${notificationsSnapshot.size} documents`, 'success');

            logToConsole('Data integrity validation completed successfully', 'success');
            showToast('Data integrity validation passed', 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Validation failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Data integrity validation failed: ' + error.message, 'error');
        }
    }

    async function exportSystemLogs() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Exporting system logs...', 'info');

            // Get current log content
            const logContent = functionLog.innerText;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `system-logs-${timestamp}.txt`;

            // Create and download file
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            logToConsole(` System logs exported as ${filename}`, 'success');
            showToast('System logs exported successfully', 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Export failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('System logs export failed: ' + error.message, 'error');
        }
    }

    function resetApplicationCache() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Resetting application cache...', 'warning');

            // Clear localStorage
            const localStorageKeys = Object.keys(localStorage);
            localStorageKeys.forEach(key => {
                if (key.startsWith('attendance_') || key.includes('theme') || key.includes('user')) {
                    localStorage.removeItem(key);
                }
            });
            logToConsole(' LocalStorage cache cleared', 'success');

            // Clear sessionStorage
            sessionStorage.clear();
            logToConsole(' SessionStorage cache cleared', 'success');

            logToConsole('Application cache reset completed', 'success');
            showToast('Application cache reset successfully', 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Cache reset failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Cache reset failed: ' + error.message, 'error');
        }
    }

    // User Management Functions Implementation
    async function syncUserData() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Syncing user data...', 'info');

            // Refresh user data from Firestore
            await loadUserData();
            logToConsole(' User data refreshed from database', 'success');

            // Update user statistics
            const usersSnapshot = await firebase.firestore().collection('users').get();
            logToConsole(` Total users in system: ${usersSnapshot.size}`, 'info');

            logToConsole('User data synchronization completed', 'success');
            showToast('User data synchronized successfully', 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Sync failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('User data sync failed: ' + error.message, 'error');
        }
    }

    async function validateUserAccounts() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Validating user accounts...', 'info');

            const usersSnapshot = await firebase.firestore().collection('users').get();
            let validCount = 0;
            let invalidCount = 0;

            usersSnapshot.forEach((doc) => {
                const userData = doc.data();
                const requiredFields = ['name', 'email', 'role'];
                const hasAllFields = requiredFields.every(field => userData[field]);

                if (hasAllFields) {
                    validCount++;
                } else {
                    invalidCount++;
                    logToConsole(` Invalid user account: ${doc.id} - missing required fields`, 'warning');
                }
            });

            logToConsole(` Valid accounts: ${validCount}`, 'success');
            if (invalidCount > 0) {
                logToConsole(` Invalid accounts: ${invalidCount}`, 'warning');
            }

            logToConsole('User account validation completed', 'success');
            showToast(`Validation complete: ${validCount} valid, ${invalidCount} invalid accounts`, 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Validation failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('User account validation failed: ' + error.message, 'error');
        }
    }

    async function generateUserReport() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Generating user report...', 'info');

            const usersSnapshot = await firebase.firestore().collection('users').get();
            let reportData = 'User Report\n';
            reportData += '='.repeat(50) + '\n';
            reportData += `Generated: ${new Date().toLocaleString()}\n`;
            reportData += `Total Users: ${usersSnapshot.size}\n\n`;

            const roleStats = {};
            usersSnapshot.forEach((doc) => {
                const userData = doc.data();
                const role = userData.role || 'unknown';
                roleStats[role] = (roleStats[role] || 0) + 1;

                reportData += `ID: ${doc.id}\n`;
                reportData += `Name: ${userData.name || 'N/A'}\n`;
                reportData += `Email: ${userData.email || 'N/A'}\n`;
                reportData += `Role: ${userData.role || 'N/A'}\n`;
                reportData += `Active: ${userData.isActive ? 'Yes' : 'No'}\n`;
                reportData += '-'.repeat(30) + '\n';
            });

            reportData += '\nRole Statistics:\n';
            Object.entries(roleStats).forEach(([role, count]) => {
                reportData += `${role}: ${count}\n`;
            });

            // Download report
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `user-report-${timestamp}.txt`;
            const blob = new Blob([reportData], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            logToConsole(` User report generated: ${filename}`, 'success');
            showToast('User report generated and downloaded', 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Report generation failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('User report generation failed: ' + error.message, 'error');
        }
    }

    async function cleanupInactiveUsers() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Cleaning up inactive users...', 'warning');

            const ninetyDaysAgo = new Date();
            ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

            const usersSnapshot = await firebase.firestore().collection('users').get();
            const batch = firebase.firestore().batch();
            let cleanupCount = 0;

            usersSnapshot.forEach((doc) => {
                const userData = doc.data();
                const lastLogin = userData.lastLogin ? userData.lastLogin.toDate() : null;

                if (!lastLogin || lastLogin < ninetyDaysAgo) {
                    // Mark as inactive instead of deleting
                    batch.update(doc.ref, { isActive: false, inactivatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    cleanupCount++;
                    logToConsole(` Marked inactive: ${userData.name || doc.id}`, 'warning');
                }
            });

            if (cleanupCount > 0) {
                await batch.commit();
                logToConsole(` Marked ${cleanupCount} users as inactive`, 'success');
            } else {
                logToConsole('No inactive users found', 'info');
            }

            logToConsole('Inactive user cleanup completed', 'success');
            showToast(`Cleanup complete: ${cleanupCount} users marked inactive`, 'success');
            loadUserData(); // Refresh user list
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Cleanup failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Inactive user cleanup failed: ' + error.message, 'error');
        }
    }

    // Maintenance Functions Implementation
    async function optimizeDatabase() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Optimizing database...', 'info');

            // Clean up old temporary documents
            const collections = ['users', 'attendance', 'notifications'];
            let cleanupCount = 0;

            for (const collectionName of collections) {
                const snapshot = await firebase.firestore().collection(collectionName).where('temporary', '==', true).get();
                if (!snapshot.empty) {
                    const batch = firebase.firestore().batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                        cleanupCount++;
                    });
                    await batch.commit();
                }
            }

            logToConsole(` Cleaned up ${cleanupCount} temporary documents`, 'success');
            logToConsole('Database optimization completed', 'success');
            showToast('Database optimization completed successfully', 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Optimization failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Database optimization failed: ' + error.message, 'error');
        }
    }

    async function backupData() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Creating data backup...', 'info');

            const backupData = {
                timestamp: new Date().toISOString(),
                users: [],
                attendance: [],
                subjects: [],
                notifications: []
            };

            // Backup users
            const usersSnapshot = await firebase.firestore().collection('users').get();
            usersSnapshot.forEach(doc => {
                backupData.users.push({ id: doc.id, data: doc.data() });
            });
            logToConsole(` Backed up ${backupData.users.length} users`, 'success');

            // Backup attendance
            const attendanceSnapshot = await firebase.firestore().collection('attendance').get();
            attendanceSnapshot.forEach(doc => {
                backupData.attendance.push({ id: doc.id, data: doc.data() });
            });
            logToConsole(` Backed up ${backupData.attendance.length} attendance records`, 'success');

            // Create and download backup file
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `attendance-backup-${timestamp}.json`;
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            logToConsole(` Backup created: ${filename}`, 'success');
            showToast('Data backup created and downloaded', 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Backup failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Data backup failed: ' + error.message, 'error');
        }
    }

    async function runHealthCheck() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('Running system health check...', 'info');

            let healthScore = 0;
            let totalChecks = 0;

            // Check Firebase connection
            try {
                await firebase.firestore().collection('_health').doc('test').get();
                logToConsole(' Firebase connection: OK', 'success');
                healthScore++;
            } catch (e) {
                logToConsole(' Firebase connection: FAILED', 'error');
            }
            totalChecks++;

            // Check authentication
            if (firebase.auth().currentUser) {
                logToConsole(' Authentication: OK', 'success');
                healthScore++;
            } else {
                logToConsole(' Authentication: No user logged in', 'warning');
            }
            totalChecks++;

            // Check data collections
            const collections = ['users', 'attendance', 'subjects', 'notifications'];
            for (const collection of collections) {
                try {
                    const snapshot = await firebase.firestore().collection(collection).limit(1).get();
                    logToConsole(` Collection '${collection}': OK`, 'success');
                    healthScore++;
                } catch (e) {
                    logToConsole(` Collection '${collection}': FAILED`, 'error');
                }
                totalChecks++;
            }

            const healthPercentage = Math.round((healthScore / totalChecks) * 100);
            const healthStatus = healthPercentage >= 80 ? 'HEALTHY' : healthPercentage >= 60 ? 'WARNING' : 'CRITICAL';
            const statusColor = healthPercentage >= 80 ? 'success' : healthPercentage >= 60 ? 'warning' : 'error';

            logToConsole(`System Health: ${healthStatus} (${healthPercentage}%)`, statusColor);
            showToast(`Health Check Complete: ${healthStatus} (${healthPercentage}%)`, statusColor === 'error' ? 'error' : 'success');
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Health check failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Health check failed: ' + error.message, 'error');
        }
    }

    async function emergencyReset() {
        try {
            const functionLog = document.getElementById('functionExecutionLog');
            const logToConsole = (msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = {'info': 'text-info', 'success': 'text-success', 'warning': 'text-warning', 'error': 'text-danger'}[type] || 'text-light';
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `[${timestamp}] ${msg}`;
                functionLog.appendChild(logEntry);
                functionLog.scrollTop = functionLog.scrollHeight;
            };

            logToConsole('EMERGENCY RESET INITIATED', 'error');
            logToConsole('This will reset critical system components...', 'warning');

            // Clear all caches
            localStorage.clear();
            sessionStorage.clear();
            logToConsole(' All browser storage cleared', 'warning');

            // Reset UI state
            document.querySelectorAll('.nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });

            // Activate first tab
            const firstTab = document.querySelector('.nav-link');
            const firstPane = document.querySelector('.tab-pane');
            if (firstTab && firstPane) {
                firstTab.classList.add('active');
                firstPane.classList.add('show', 'active');
            }

            logToConsole(' UI state reset', 'warning');
            logToConsole('EMERGENCY RESET COMPLETED', 'error');
            logToConsole('Please refresh the page to complete the reset', 'warning');

            showToast('Emergency reset completed. Please refresh the page.', 'warning');

            // Auto-refresh after 3 seconds
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } catch (error) {
            const functionLog = document.getElementById('functionExecutionLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-danger';
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}]  Emergency reset failed: ${error.message}`;
            functionLog.appendChild(logEntry);
            functionLog.scrollTop = functionLog.scrollHeight;
            showToast('Emergency reset failed: ' + error.message, 'error');
        }
    }

    // Export user data to Excel - simplified version
    function exportUserData(userId = null) {
        const exportBtn = document.getElementById('exportExcelBtn');
        if (exportBtn) {
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Exporting...';
        }
        
        try {
            // Simple approach - get users directly
            if (userId) {
                // Single user export
                db.collection('users').doc(userId).get()
                    .then(doc => {
                        if (!doc.exists) {
                            showToast('User not found', 'danger');
                            return;
                        }
                        
                        const userData = [];
                        try {
                            const processedData = processUserForExport(doc);
                            if (processedData) userData.push(processedData);
                        } catch (err) {
                            console.error("Error processing user:", err);
                        }
                        
                        if (userData.length === 0) {
                            showToast('No data to export for this user', 'warning');
                            return;
                        }
                        
                        const now = new Date();
                        const dateString = now.toISOString().split('T')[0];
                        const filename = `user_attendance_${userId}_${dateString}.xlsx`;
                        
                        try {
                            exportToExcel(userData, filename, 'User Attendance');
                            showToast('Export successful!', 'success');
                        } catch (err) {
                            console.error("Excel export error:", err);
                            showToast('Excel export failed: ' + err.message, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error("Error getting user:", error);
                        showToast('Failed to get user data: ' + error.message, 'danger');
                    })
                    .finally(() => {
                        if (exportBtn) {
                            exportBtn.disabled = false;
                            exportBtn.innerHTML = '<i class="fas fa-file-excel me-1"></i> Export to Excel';
                        }
                    });
            } else {
                // All users export
                db.collection('users').get()
                    .then(snapshot => {
                        if (snapshot.empty) {
                            showToast('No users found', 'warning');
                            return;
                        }
                        
                        const userData = [];
                        snapshot.forEach(doc => {
                            try {
                                const processedData = processUserForExport(doc);
                                if (processedData) userData.push(processedData);
                            } catch (err) {
                                console.error(`Error processing user ${doc.id}:`, err);
                                // Continue with other users
                            }
                        });
                        
                        if (userData.length === 0) {
                            showToast('No valid user data to export', 'warning');
                            return;
                        }
                        
                        const now = new Date();
                        const dateString = now.toISOString().split('T')[0];
                        const filename = `users_attendance_${dateString}.xlsx`;
                        
                        try {
                            exportToExcel(userData, filename, 'User Attendance');
                            showToast('Export successful!', 'success');
                        } catch (err) {
                            console.error("Excel export error:", err);
                            showToast('Excel export failed: ' + err.message, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error("Error getting users:", error);
                        showToast('Failed to get user data: ' + error.message, 'danger');
                    })
                    .finally(() => {
                        if (exportBtn) {
                            exportBtn.disabled = false;
                            exportBtn.innerHTML = '<i class="fas fa-file-excel me-1"></i> Export to Excel';
                        }
                    });
            }
        } catch (error) {
            console.error("Unexpected error:", error);
            showToast('An unexpected error occurred: ' + error.message, 'danger');
            if (exportBtn) {
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<i class="fas fa-file-excel me-1"></i> Export to Excel';
            }
        }
    }
    
    // Helper function to process user data for export
    function processUserForExport(doc) {
        try {
            const userData = doc.data() || {};
            
            // Basic user info
            const result = {
                'User ID': doc.id,
                'Name': userData.name || 'Unknown',
                'Email': userData.email || 'No email',
                'Total Present': 0,
                'Total Absent': 0,
                'Attendance (%)': 0,
                'Last Updated': 'Never'
            };
            
            // Process last updated
            if (userData.lastUpdated) {
                try {
                    if (typeof userData.lastUpdated.toDate === 'function') {
                        result['Last Updated'] = userData.lastUpdated.toDate().toLocaleString();
                    } else {
                        result['Last Updated'] = String(userData.lastUpdated);
                    }
                } catch (e) {
                    console.error("Error formatting date:", e);
                }
            }
            
            // Process attendance data
            let totalPresent = 0;
            let totalAbsent = 0;
            
            if (userData.attendanceData && userData.attendanceData.subjects) {
                const subjects = userData.attendanceData.subjects;
                
                // Process each subject
                for (const subjectName in subjects) {
                    if (!subjects.hasOwnProperty(subjectName)) continue;
                    
                    const subject = subjects[subjectName];
                    if (!subject) continue;
                    
                    const present = subject.present || 0;
                    const absent = subject.absent || 0;
                    
                    totalPresent += present;
                    totalAbsent += absent;
                    
                    // Add subject details
                    result[`${subjectName} (Present)`] = present;
                    result[`${subjectName} (Absent)`] = absent;
                    
                    // Calculate percentage
                    const total = present + absent;
                    result[`${subjectName} (%)`] = total > 0 ? Math.round((present / total) * 100) : 0;
                    
                    // Add last session info if available
                    if (subject.sessions && Array.isArray(subject.sessions) && subject.sessions.length > 0) {
                        try {
                            const lastSession = subject.sessions[subject.sessions.length - 1];
                            if (lastSession && lastSession.date) {
                                result[`${subjectName} (Last Session)`] = new Date(lastSession.date).toLocaleString();
                            } else {
                                result[`${subjectName} (Last Session)`] = 'None';
                            }
                        } catch (e) {
                            result[`${subjectName} (Last Session)`] = 'Error';
                        }
                    } else {
                        result[`${subjectName} (Last Session)`] = 'None';
                    }
                }
            }
            
            // Update totals
            result['Total Present'] = totalPresent;
            result['Total Absent'] = totalAbsent;
            
            // Calculate overall percentage
            const total = totalPresent + totalAbsent;
            result['Attendance (%)'] = total > 0 ? Math.round((totalPresent / total) * 100) : 0;
            
            return result;
        } catch (error) {
            console.error(`Error processing user ${doc.id}:`, error);
            return null;
        }
    }
    
    // Export user logs to Excel
    function exportUserLogs() {
        const exportBtn = document.getElementById('exportLogsBtn');
        if (exportBtn) {
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Exporting...';
        }
        
        db.collection('userLogs').orderBy('timestamp', 'desc').get()
            .then(snapshot => {
                const logsData = [];
                
                snapshot.forEach(doc => {
                    const logData = doc.data();
                    
                    let timestamp = 'Unknown';
                    if (logData.timestamp) {
                        const date = logData.timestamp.toDate();
                        timestamp = date.toLocaleString();
                    }
                    
                    // Format log data for Excel with more details
                    const logExcelData = {
                        'Log ID': doc.id,
                        'User ID': logData.userId || 'Unknown',
                        'Name': logData.userName || 'Unknown',
                        'Email': logData.userEmail || 'No email',
                        'Activity': logData.activity || 'Unknown',
                        'Timestamp': timestamp,
                        'Date': logData.timestamp ? logData.timestamp.toDate().toLocaleDateString() : 'Unknown',
                        'Time': logData.timestamp ? logData.timestamp.toDate().toLocaleTimeString() : 'Unknown',
                        'IP Address': logData.ipAddress || 'Unknown',
                        'Page': logData.page || 'Unknown',
                        'Browser': logData.browser || 'Unknown',
                        'OS': logData.os || 'Unknown',
                        'Device': logData.device || 'Unknown'
                    };
                    
                    // Add any additional data if available
                    if (logData.additionalData) {
                        if (typeof logData.additionalData === 'object') {
                            Object.entries(logData.additionalData).forEach(([key, value]) => {
                                logExcelData[`Additional_${key}`] = typeof value === 'object' ? JSON.stringify(value) : value;
                            });
                        } else {
                            logExcelData['Additional Data'] = String(logData.additionalData);
                        }
                    }
                    
                    logsData.push(logExcelData);
                });
                
                // Export to Excel
                const now = new Date();
                const dateString = now.toISOString().split('T')[0];
                exportToExcel(logsData, `user_logs_${dateString}.xlsx`, 'User Logs');
                
                showToast('User logs exported successfully!', 'success');
            })
            .catch(error => {
                console.error("Error exporting user logs:", error);
                showToast('Failed to export user logs: ' + error.message, 'danger');
            })
            .finally(() => {
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = '<i class="fas fa-file-excel me-1"></i> Export Logs';
                }
            });
    }
    
    // Export deleted reports to Excel
    function exportDeletedReports() {
        const exportBtn = document.getElementById('exportDeletedBtn');
        if (exportBtn) {
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Exporting...';
        }
        
        db.collection('deletedRecords').orderBy('deletedAt', 'desc').get()
            .then(snapshot => {
                const deletedData = [];
                
                if (snapshot.empty) {
                    throw new Error('No deleted records found');
                }
                
                snapshot.forEach(doc => {
                    const recordData = doc.data();
                    
                    let deletedAt = 'Unknown';
                    if (recordData.deletedAt) {
                        try {
                            const date = recordData.deletedAt.toDate();
                            deletedAt = date.toLocaleString();
                        } catch (error) {
                            console.error("Error formatting deletedAt date:", error);
                            deletedAt = 'Invalid Date';
                        }
                    }
                    
                    // Format deleted record data for Excel with more details
                    const deletedExcelData = {
                        'Record ID': doc.id,
                        'Item Type': recordData.itemType || 'Unknown',
                        'Original ID': recordData.originalId || 'Unknown',
                        'Deleted By': recordData.deletedByName || 'Unknown',
                        'Deleted By Email': recordData.deletedByEmail || 'Unknown',
                        'Deleted At': deletedAt,
                        'Date': recordData.deletedAt ? recordData.deletedAt.toDate().toLocaleDateString() : 'Unknown',
                        'Time': recordData.deletedAt ? recordData.deletedAt.toDate().toLocaleTimeString() : 'Unknown'
                    };
                    
                    // Add item data details
                    if (recordData.itemData) {
                        if (typeof recordData.itemData === 'object') {
                            // For each property in itemData, add it as a column
                            Object.entries(recordData.itemData).forEach(([key, value]) => {
                                // Skip complex objects and arrays, or stringify them
                                if (typeof value !== 'object' || value === null) {
                                    deletedExcelData[`Item_${key}`] = value;
                                } else {
                                    deletedExcelData[`Item_${key}`] = JSON.stringify(value);
                                }
                            });
                        } else {
                            deletedExcelData['Item Data'] = String(recordData.itemData);
                        }
                    }
                    
                    deletedData.push(deletedExcelData);
                });
                
                if (deletedData.length === 0) {
                    throw new Error('No deleted records to export');
                }
                
                // Export to Excel
                const now = new Date();
                const dateString = now.toISOString().split('T')[0];
                
                try {
                    exportToExcel(deletedData, `deleted_records_${dateString}.xlsx`, 'Deleted Records');
                    showToast('Deleted records exported successfully!', 'success');
                } catch (error) {
                    console.error("Error in Excel export:", error);
                    showToast('Error exporting to Excel: ' + error.message, 'danger');
                }
            })
            .catch(error => {
                console.error("Error exporting deleted records:", error);
                showToast('Failed to export deleted records: ' + error.message, 'danger');
            })
            .finally(() => {
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = '<i class="fas fa-file-excel me-1"></i> Export Data';
                }
            });
    }
    
    // Load user data from Firestore
    function loadUserData() {
        document.getElementById('spinner').style.display = 'flex';
        document.getElementById('adminTableContainer').style.display = 'none';
        
        console.log("Fetching users data from Firestore...");
        
        db.collection('users').get()
            .then(snapshot => {
                console.log("Users data received, count:", snapshot.size);
                const users = [];
                let totalAttendanceSum = 0;

                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const attendance = userData.attendanceData?.subjects || {};
                    
                    let totalPresent = 0;
                    let totalAbsent = 0;
                    
                    Object.values(attendance).forEach(subject => {
                        totalPresent += subject.present || 0;
                        totalAbsent += subject.absent || 0;
                    });
                    
                    const total = totalPresent + totalAbsent;
                    const percent = total > 0 ? Math.round((totalPresent / total) * 100) : 0;
                    totalAttendanceSum += percent;

                    let lastUpdated = 'Never';
                    if (userData.lastUpdated) {
                        try {
                            const date = userData.lastUpdated.toDate();
                            lastUpdated = date.toLocaleString();
                        } catch (e) {
                            console.warn("Error formatting date for user:", doc.id, e);
                            lastUpdated = 'Invalid date';
                        }
                    }
                    
                    users.push({
                        id: doc.id,
                        name: userData.name || 'Unknown',
                        email: userData.email || 'No email',
                        attendancePercent: percent,
                        lastUpdated: lastUpdated,
                        attendanceData: userData.attendanceData
                    });
                });
                
                // Populate table
                const tbody = document.querySelector('#adminTable tbody');
                tbody.innerHTML = '';
                
                if (users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center">No users found</td></tr>`;
                    console.warn("No users found in the database");
                    
                    // Check if we need to create sample data
                    if (currentUser && confirm("No user data found. Would you like to create sample user data?")) {
                        createSampleUserData();
                    }
                } else {
                    users.forEach((user, idx) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${idx+1}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                        style="width: ${user.attendancePercent}%;" 
                                        aria-valuenow="${user.attendancePercent}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="100">
                                        ${user.attendancePercent}%
                                    </div>
                                </div>
                            </td>
                            <td>${user.lastUpdated}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-details-btn">
                                    <i class="fas fa-user"></i> Profile
                                </button>
                            </td>
                        `;
                        try {
                            const viewBtn = tr.querySelector('.view-details-btn');
                            if (viewBtn) {
                                viewBtn.addEventListener('click', () => showUserDetails(user));
                            }
                        } catch (e) {
                            console.error("Error adding event listener to view button:", e);
                        }
                        tbody.appendChild(tr);
                    });
                }
                
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('adminTableContainer').style.display = '';
                
                // Update stats
                document.getElementById('totalUsersStat').textContent = users.length;
                const avgAttendance = users.length > 0 ? Math.round(totalAttendanceSum / users.length) : 0;
                document.getElementById('avgAttendanceStat').textContent = `${avgAttendance}%`;
                
                try {
                    updateDashboardChart(users);
                    // Load advanced charts
                    createUserActivityChart();
                    createErrorFrequencyChart();
                    createProjectActivityChart();
                    createGeographicChart();
                } catch (e) {
                    console.error("Error updating dashboard charts:", e);
                }

                showToast('User data loaded successfully!', 'success');
            })
            .catch(error => {
                console.error("Error loading users:", error);
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('adminTableContainer').style.display = '';
                document.querySelector('#adminTable tbody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading data: ${error.message}
                        </td>
                    </tr>
                `;
                
                // Check if permission denied - could be Firebase rules issue
                if (error.code === 'permission-denied') {
                    showToast('Permission denied. Please check your Firebase rules.', 'danger');
                    console.error("This is likely a Firebase rules issue. Make sure your rules allow reading/writing data from your Netlify domain.");
                    
                    // Check if admin user exists and if we're authenticated
                    if (currentUser) {
                        // Try to create the collection with basic permissions
                        createInitialUserData();
                    }
                } else {
                    showToast('Failed to load user data: ' + error.message, 'danger');
                }
            });
    }
    
    // Create initial user data function
    function createInitialUserData() {
        console.log("Attempting to create initial user data...");
        
        // First check if the current user is admin
        if (!currentUser || !checkAdmin(currentUser.email)) {
            console.error("Cannot create initial data: not authenticated as admin");
            return;
        }
        
        db.collection('users').doc('initial').set({
            name: 'Initial User',
            email: 'initial@example.com',
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            attendanceData: {
                subjects: {}
            },
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            console.log("Initial user created successfully");
            showToast('Initial user created. You should now be able to see data.', 'success');
            loadUserData(); // Try loading data again
        })
        .catch(error => {
            console.error("Error creating initial user:", error);
            showToast('Error creating initial user: ' + error.message, 'danger');
        });
    }
    
    // Sample data creation function
    function createSampleUserData() {
        console.log("Creating sample user data...");
        showToast('Creating sample data...', 'info');
        
        const sampleUsers = [
            {
                name: 'John Doe',
                email: 'john@example.com',
                attendanceData: {
                    subjects: {
                        'Computer Science': {
                            present: 15,
                            absent: 2
                        },
                        'Mathematics': {
                            present: 12,
                            absent: 5
                        }
                    }
                }
            },
            {
                name: 'Jane Smith',
                email: 'jane@example.com',
                attendanceData: {
                    subjects: {
                        'Computer Science': {
                            present: 14,
                            absent: 3
                        },
                        'Mathematics': {
                            present: 16,
                            absent: 1
                        }
                    }
                }
            }
        ];
        
        const batch = db.batch();
        
        sampleUsers.forEach((user, index) => {
            const userRef = db.collection('users').doc(`sample_user_${index}`);
            batch.set(userRef, {
                ...user,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        
        batch.commit()
            .then(() => {
                console.log("Sample data created");
                showToast('Sample data created successfully!', 'success');
                loadUserData();
            })
            .catch(error => {
                console.error("Error creating sample data:", error);
                showToast('Error creating sample data: ' + error.message, 'danger');
            });
    }

    // Show user details in modal
    function showUserDetails(user) {
        // Populate basic information with null checks
        const profileUserName = document.getElementById('profileUserName');
        const profileUserEmail = document.getElementById('profileUserEmail');
        const profileUserId = document.getElementById('profileUserId');
        const profileRegDate = document.getElementById('profileRegDate');
        const profileLastLogin = document.getElementById('profileLastLogin');
        const profileStatus = document.getElementById('profileStatus');

        if (profileUserName) profileUserName.textContent = user.name || 'Unknown';
        if (profileUserEmail) profileUserEmail.textContent = user.email || 'No email';
        if (profileUserId) profileUserId.textContent = user.id || 'Unknown';
        if (profileRegDate) profileRegDate.textContent = user.registrationDate || 'Unknown';
        if (profileLastLogin) profileLastLogin.textContent = user.lastLogin || 'Never';
        if (profileStatus) profileStatus.textContent = user.isActive ? 'Active' : 'Inactive';

        // Populate contact details with null checks
        const profilePhone = document.getElementById('profilePhone');
        const profileDepartment = document.getElementById('profileDepartment');
        const profileStudentId = document.getElementById('profileStudentId');
        const profileYear = document.getElementById('profileYear');

        if (profilePhone) profilePhone.textContent = user.phone || 'Not provided';
        if (profileDepartment) profileDepartment.textContent = user.department || 'Not specified';
        if (profileStudentId) profileStudentId.textContent = user.studentId || 'Not provided';
        if (profileYear) profileYear.textContent = user.year || 'Not specified';

        // Set role badge with null check
        const roleElement = document.getElementById('profileUserRole');
        if (roleElement) {
            if (user.isAdmin) {
                roleElement.textContent = 'Administrator';
                roleElement.className = 'badge bg-danger';
            } else {
                roleElement.textContent = 'Student';
                roleElement.className = 'badge bg-primary';
            }
        }

        // Load user activity
        loadUserActivity(user);

        // Load attendance summary
        loadUserAttendanceSummary(user);

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
        modal.show();
    }

    // Load user activity for profile modal
    async function loadUserActivity(user) {
        const userId = user.id;
        const tbody = document.getElementById('profileActivityTable');

        // Check if element exists before trying to set innerHTML
        if (!tbody) {
            console.error('profileActivityTable element not found');
            return;
        }

        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Loading activity...</td></tr>';

        try {
            // Try to get activity data without ordering first to avoid index issues
            let snapshot;
            try {
                snapshot = await firebase.firestore()
                    .collection('userLogs')
                    .where('userId', '==', userId)
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
            } catch (indexError) {
                console.warn('Index not available, trying without orderBy:', indexError);
                // Fallback: get data without ordering
                snapshot = await firebase.firestore()
                    .collection('userLogs')
                    .where('userId', '==', userId)
                    .limit(10)
                    .get();
            }

            tbody.innerHTML = '';

            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No activity found</td></tr>';
                return;
            }

            // Convert to array and sort manually if needed
            const activities = [];
            snapshot.forEach(doc => {
                const activity = doc.data();
                activities.push(activity);
            });

            // Sort by timestamp if available
            activities.sort((a, b) => {
                if (a.timestamp && b.timestamp) {
                    return b.timestamp.toDate() - a.timestamp.toDate();
                }
                return 0;
            });

            activities.forEach(activity => {
                const timestamp = activity.timestamp ?
                    new Date(activity.timestamp.toDate()).toLocaleString() : 'Unknown';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${timestamp}</td>
                    <td>${activity.activity || 'Unknown'}</td>
                    <td>${activity.page || 'Unknown'}</td>
                    <td>${activity.device || activity.browser || 'Unknown'}</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading user activity:', error);
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading activity</td></tr>';

            // Check for index creation message
            if (error.message && error.message.includes("The query requires an index")) {
                const firestoreIndexUrl = "https://console.firebase.google.com/project/" + firebase.app().options.projectId + "/firestore/indexes";
                tbody.innerHTML += `<tr><td colspan="4" class="text-center text-warning">
                    <strong>Firestore Index Required</strong><br>
                    <small>Collection: userLogs, Fields: userId (Ascending), timestamp (Descending)</small><br>
                    <a href="${firestoreIndexUrl}" target="_blank" class="btn btn-sm btn-warning mt-2">Create Index in Firebase Console</a>
                </td></tr>`;
            }
        }
    }

    // Load attendance summary for profile modal
    async function loadUserAttendanceSummary(user) {
        const attendanceSummaryDiv = document.getElementById('profileAttendanceSummary');

        // Check if element exists before trying to set innerHTML
        if (!attendanceSummaryDiv) {
            console.error('profileAttendanceSummary element not found');
            return;
        }

        attendanceSummaryDiv.innerHTML = '<div class="text-center text-muted">Loading summary...</div>';

        // Check for user.id to prevent errors
        if (!user || !user.id) {
            console.error("loadUserAttendanceSummary: user or user.id is undefined.", user);
            attendanceSummaryDiv.innerHTML = '<div class="text-center text-danger">Could not load summary: Invalid user data.</div>';
            return;
        }
        const userId = user.id;

        try {
            let totalPresent = 0;
            let totalAbsent = 0;
            let totalSessions = 0;

            const snapshot = await firebase.firestore()
                .collection('attendance')
                .where('userId', '==', userId)
                .get();

            snapshot.forEach(doc => {
                const attendance = doc.data();
                totalSessions++;
                if (attendance.status === 'present') {
                    totalPresent++;
                } else {
                    totalAbsent++;
                }
            });

            const percentage = totalSessions > 0 ? Math.round((totalPresent / totalSessions) * 100) : 0;

            // Safely update elements with null checks
            const presentElement = document.getElementById('profileTotalPresent');
            const absentElement = document.getElementById('profileTotalAbsent');
            const sessionsElement = document.getElementById('profileTotalSessions');
            const percentageElement = document.getElementById('profileAttendancePercentage');

            if (presentElement) presentElement.textContent = totalPresent;
            if (absentElement) absentElement.textContent = totalAbsent;
            if (sessionsElement) sessionsElement.textContent = totalSessions;
            if (percentageElement) percentageElement.textContent = `${percentage}%`;

            const subjects = user.attendanceData?.subjects || {};
            const labels = [];
            const presentData = [];

            if(Object.keys(subjects).length > 0) {
                for(const subjectName in subjects) {
                    const subject = subjects[subjectName];
                    const total = (subject.present || 0) + (subject.absent || 0);
                    labels.push(subjectName);
                    presentData.push(subject.present || 0);
                }
            }

            updateUserAttendanceChart(labels, presentData);

        } catch (error) {
            console.error('Error loading attendance summary:', error);
            attendanceSummaryDiv.innerHTML = '<div class="text-center text-danger">Error loading summary</div>';
        }
    }

    // Helper function to show Firestore index creation instructions
    function showFirestoreIndexInstructions() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Firestore Index Required</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>To enable user activity tracking, you need to create a Firestore index:</p>
                        <ol>
                            <li>Go to <a href="https://console.firebase.google.com/project/${firebase.app().options.projectId}/firestore/indexes" target="_blank">Firebase Console - Firestore Indexes</a></li>
                            <li>Click "Create Index"</li>
                            <li>Set Collection ID: <code>userLogs</code></li>
                            <li>Add fields:
                                <ul>
                                    <li><code>userId</code> - Ascending</li>
                                    <li><code>timestamp</code> - Descending</li>
                                </ul>
                            </li>
                            <li>Click "Create Index"</li>
                        </ol>
                        <p><small>Index creation may take a few minutes to complete.</small></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();

        // Remove modal from DOM when hidden
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    }

    // Load subjects
    function loadSubjects() {
        const spinner = document.getElementById('subjectsSpinner');
        const list = document.getElementById('subjectsList');
        spinner.style.display = 'flex';
        list.innerHTML = '';

        console.log("Loading subjects...");
        
        // Make sure we have a reference to the authenticated user
        if (!currentUser) {
            spinner.style.display = 'none';
            showToast('Authentication error. Please reload the page.', 'danger');
            return;
        }

        // First check if the subjects collection exists, if not create it
        db.collection('subjects').get()
            .then(snapshot => {
                spinner.style.display = 'none';
                console.log("Subjects data received, count:", snapshot.size);
                
                if(snapshot.empty) {
                    list.innerHTML = '<li class="list-group-item">No subjects found. Add your first subject above.</li>';
                    document.getElementById('totalSubjectsStat').textContent = 0;
                    
                    // Offer to create sample subjects
                    if (confirm("No subjects found. Would you like to create sample subjects?")) {
                        createSampleSubjects();
                    }
                    return;
                }
                
                document.getElementById('totalSubjectsStat').textContent = snapshot.size;
                snapshot.forEach(doc => {
                    const subject = doc.data();
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    
                    // Create subject information container
                    const subjectInfo = document.createElement('div');
                    const subjectName = document.createElement('div');
                    subjectName.className = 'fw-bold';
                    subjectName.textContent = subject.name;
                    subjectInfo.appendChild(subjectName);
                    
                    // Display class days if available
                    if (subject.classDays && subject.classDays.length > 0) {
                        const classDays = document.createElement('small');
                        classDays.className = 'text-muted';
                        classDays.textContent = `Days: ${subject.classDays.join(', ')}`;
                        subjectInfo.appendChild(classDays);
                    }
                    
                    // Display class order if available
                    if (subject.classOrder) {
                        const classOrder = document.createElement('small');
                        classOrder.className = 'text-muted d-block';
                        classOrder.textContent = `Order: ${subject.classOrder}`;
                        subjectInfo.appendChild(classOrder);
                    }
                    
                    li.appendChild(subjectInfo);
                    
                    // Add buttons container
                    const btnGroup = document.createElement('div');
                    btnGroup.className = 'btn-group';
                    
                    // Add edit button
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-outline-primary me-2';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.onclick = () => editSubject(doc.id, subject);
                    btnGroup.appendChild(editBtn);
                    
                    // Add delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-outline-danger';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.onclick = () => deleteSubject(doc.id, subject.name);
                    btnGroup.appendChild(deleteBtn);

                    li.appendChild(btnGroup);
                    list.appendChild(li);
                });

                // Also populate attendance filter dropdown
                const attendanceFilterSubject = document.getElementById('attendanceFilterSubject');
                if (attendanceFilterSubject) {
                    // Clear existing options except "All Subjects"
                    attendanceFilterSubject.innerHTML = '<option value="">All Subjects</option>';

                    snapshot.forEach(doc => {
                        const subject = doc.data();
                        const option = document.createElement('option');
                        option.value = subject.name;
                        option.textContent = subject.name;
                        attendanceFilterSubject.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error("Error loading subjects:", error);
                spinner.style.display = 'none';
                list.innerHTML = `
                    <li class="list-group-item text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading subjects: ${error.message}
                    </li>
                `;
                
                // If permission denied, try to create the collection
                if (error.code === 'permission-denied') {
                    showToast('Creating subjects collection...', 'info');
                    console.log("Permission denied when accessing subjects. Creating initial collection...");
                    // Create an initial empty document to establish the collection
                    db.collection('subjects').doc('initial').set({
                        createdBy: currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        name: 'Initial Subject',
                        classDays: ['Monday'],
                        classOrder: 1
                    })
                    .then(() => {
                        showToast('Subjects collection created. You can now add subjects.', 'success');
                        console.log("Subjects collection created successfully");
                        loadSubjects(); // Try loading again
                    })
                    .catch(innerError => {
                        showToast('Error creating subjects: ' + innerError.message, 'danger');
                        console.error("Error creating subjects collection:", innerError);
                    });
                } else {
                    showToast('Error loading subjects: ' + error.message, 'danger');
                }
            });
    }

    // Create sample subjects function
    function createSampleSubjects() {
        console.log("Creating sample subjects...");
        showToast('Creating sample subjects...', 'info');
        
        const sampleSubjects = [
            {
                name: 'Computer Science',
                classDays: ['Monday', 'Wednesday', 'Friday'],
                classOrder: 1
            },
            {
                name: 'Mathematics',
                classDays: ['Tuesday', 'Thursday'],
                classOrder: 2 
            },
            {
                name: 'Physics',
                classDays: ['Monday', 'Thursday'],
                classOrder: 3
            }
        ];
        
        const batch = db.batch();
        
        sampleSubjects.forEach((subject, index) => {
            const subjectRef = db.collection('subjects').doc(`sample_subject_${index}`);
            batch.set(subjectRef, {
                ...subject,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        
        batch.commit()
            .then(() => {
                console.log("Sample subjects created");
                showToast('Sample subjects created successfully!', 'success');
                loadSubjects();
            })
            .catch(error => {
                console.error("Error creating sample subjects:", error);
                showToast('Error creating sample subjects: ' + error.message, 'danger');
            });
    }

    // Add subject
    function addSubject() {
        const subjectNameInput = document.getElementById('subjectName');
        const name = subjectNameInput.value.trim();
        if(!name) {
            showToast('Please enter a subject name.', 'warning');
            return;
        }

        // Get all selected days
        const selectedDays = [];
        document.querySelectorAll('.class-day-checkbox:checked').forEach(checkbox => {
            selectedDays.push(checkbox.value);
        });

        if(selectedDays.length === 0) {
            showToast('Please select at least one class day.', 'warning');
            return;
        }
        
        // Get class order
        const classOrder = parseInt(document.getElementById('classOrder').value) || null;

        const addBtn = document.getElementById('addSubjectBtn');
        addBtn.disabled = true;
        addBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';

        // Check if we have the current user
        if (!currentUser) {
            showToast('Authentication error. Please reload the page.', 'danger');
            addBtn.disabled = false;
            addBtn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Add Subject';
            return;
        }

        db.collection('subjects').add({ 
            name: name,
            classDays: selectedDays,
            classOrder: classOrder,
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            showToast('Subject added successfully!', 'success');
            subjectNameInput.value = '';
            document.getElementById('classOrder').value = '';
            // Clear checkbox selections
            document.querySelectorAll('.class-day-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            loadSubjects();
        })
        .catch(error => {
            console.error("Error adding subject: ", error);
            
            // If permission denied, try to create the collection first
            if (error.code === 'permission-denied') {
                db.collection('subjects').doc('initial').set({
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    name: 'Initial Subject',
                    classDays: ['Monday'],
                    classOrder: 1
                })
                .then(() => {
                    // Now try to add the actual subject
                    return db.collection('subjects').add({ 
                        name: name,
                        classDays: selectedDays,
                        classOrder: classOrder,
                        createdBy: currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    showToast('Subject added successfully!', 'success');
                    subjectNameInput.value = '';
                    document.getElementById('classOrder').value = '';
                    // Clear checkbox selections
                    document.querySelectorAll('.class-day-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    loadSubjects();
                })
                .catch(innerError => {
                    showToast('Error adding subject: ' + innerError.message, 'danger');
                    console.error("Error in second attempt:", innerError);
                });
            } else {
                showToast('Error adding subject: ' + error.message, 'danger');
            }
        })
        .finally(() => {
            addBtn.disabled = false;
            addBtn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Add Subject';
        });
    }

    // Delete subject
    function deleteSubject(id, name) {
        if (!confirm(`Are you sure you want to delete the subject "${name}"? This cannot be undone.`)) {
            return;
        }

        db.collection('subjects').doc(id).delete()
            .then(() => {
                showToast(`Subject "${name}" deleted successfully.`, 'success');
                loadSubjects();
            })
            .catch(error => {
                showToast('Error deleting subject: ' + error.message, 'danger');
                console.error("Error deleting subject:", error);
            });
    }
 
    // Update Dashboard Chart
    function updateDashboardChart(users) {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        const fallback = document.getElementById('attendanceChartFallback');
        // Filter out users with no attendance data
        const usersWithData = users.filter(u => u.attendancePercent > 0);
        if (attendanceChartInstance) attendanceChartInstance.destroy();
        if (usersWithData.length === 0) {
            fallback.style.display = '';
            return;
        } else {
            fallback.style.display = 'none';
        }
        attendanceChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: usersWithData.map(u => u.name),
                datasets: [{
                    label: 'Attendance %',
                    data: usersWithData.map(u => u.attendancePercent),
                    backgroundColor: 'var(--primary-gradient)',
                    borderColor: 'var(--primary-solid)',
                    borderWidth: 1,
                    borderRadius: 8,
                    maxBarThickness: 48,
                    hoverBackgroundColor: 'var(--primary-gradient-hover)',
                    hoverBorderColor: 'var(--primary-light)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        enabled: true,
                        backgroundColor: 'var(--card-bg)',
                        titleColor: 'var(--text-main)',
                        bodyColor: 'var(--text-main)',
                        borderColor: 'var(--border-color)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: false
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { 
                            color: 'var(--text-muted)', 
                            font: { weight: 600 } 
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { 
                            color: 'var(--separator)',
                            drawBorder: false
                        },
                        ticks: { 
                            color: 'var(--text-muted)', 
                            font: { weight: 600 }, 
                            stepSize: 20 
                        }
                    }
                }
            }
        });
    }

    // Advanced Chart Variables
    let userActivityChartInstance = null;
    let errorFrequencyChartInstance = null;
    let projectActivityChartInstance = null;
    let geographicChartInstance = null;

    // Function to create User Activity Trends Chart
    async function createUserActivityChart() {
        const ctx = document.getElementById('userActivityChart');
        if (!ctx) return;

        try {
            // Generate sample data for the last 7 days
            const last7Days = [];
            const activityData = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

                // Simulate activity data (in real app, this would come from user logs)
                activityData.push(Math.floor(Math.random() * 50) + 20);
            }

            if (userActivityChartInstance) {
                userActivityChartInstance.destroy();
            }

            userActivityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Active Users',
                        data: activityData,
                        borderColor: 'var(--primary-solid)',
                        backgroundColor: 'var(--primary-alpha-10)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'var(--primary-solid)',
                        pointBorderColor: 'var(--card-bg)',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: 'var(--primary-light)',
                        pointHoverBorderColor: 'var(--card-bg)',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'var(--card-bg)',
                            titleColor: 'var(--text-main)',
                            bodyColor: 'var(--text-main)',
                            borderColor: 'var(--border-color)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            padding: 12
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: 'var(--text-muted)',
                                font: { weight: 500 }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { 
                                color: 'var(--separator)',
                                drawBorder: false
                            },
                            ticks: { 
                                color: 'var(--text-muted)',
                                font: { weight: 500 }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating user activity chart:', error);
        }
    }

    // Function to create Error Frequency Chart
    async function createErrorFrequencyChart() {
        const ctx = document.getElementById('errorFrequencyChart');
        if (!ctx) return;

        try {
            // Fetch error data from Firestore
            const snapshot = await firebase.firestore().collection('errorLogs')
                .orderBy('timestamp', 'desc')
                .limit(100)
                .get();

            const errorTypes = {};
            const last7Days = {};

            // Initialize last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString();
                last7Days[dateStr] = 0;
            }

            snapshot.forEach(doc => {
                const error = doc.data();
                const errorType = error.type || 'unknown';
                const timestamp = error.timestamp ? error.timestamp.toDate() : new Date();
                const dateStr = timestamp.toLocaleDateString();

                // Count by type
                errorTypes[errorType] = (errorTypes[errorType] || 0) + 1;

                // Count by date (last 7 days)
                if (last7Days.hasOwnProperty(dateStr)) {
                    last7Days[dateStr]++;
                }
            });

            if (errorFrequencyChartInstance) {
                errorFrequencyChartInstance.destroy();
            }

            errorFrequencyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(last7Days),
                    datasets: [{
                        label: 'Errors',
                        data: Object.values(last7Days),
                        backgroundColor: 'var(--danger)',
                        borderRadius: 6,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--text-muted)' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'var(--separator)' },
                            ticks: { color: 'var(--text-muted)' }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating error frequency chart:', error);
            // Create chart with sample data if Firebase fails
            if (errorFrequencyChartInstance) {
                errorFrequencyChartInstance.destroy();
            }

            errorFrequencyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Errors',
                        data: [2, 1, 3, 0, 1, 0, 1],
                        backgroundColor: 'var(--danger)',
                        borderRadius: 6,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    }

    // Function to create Project Activity Chart
    async function createProjectActivityChart() {
        const ctx = document.getElementById('projectActivityChart');
        if (!ctx) return;

        try {
            // Fetch project data from Firestore
            const snapshot = await firebase.firestore().collection('projectLogs')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();

            const last7Days = {};
            const projectTypes = {};

            // Initialize last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                last7Days[dateStr] = 0;
            }

            snapshot.forEach(doc => {
                const project = doc.data();
                const timestamp = project.timestamp ? project.timestamp.toDate() : new Date();
                const dateStr = timestamp.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                // Count by date (last 7 days)
                if (last7Days.hasOwnProperty(dateStr)) {
                    last7Days[dateStr]++;
                }

                // Count by type
                if (project.tags && Array.isArray(project.tags)) {
                    project.tags.forEach(tag => {
                        projectTypes[tag] = (projectTypes[tag] || 0) + 1;
                    });
                }
            });

            if (projectActivityChartInstance) {
                projectActivityChartInstance.destroy();
            }

            projectActivityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(last7Days),
                    datasets: [{
                        label: 'Project Updates',
                        data: Object.values(last7Days),
                        borderColor: 'var(--success-solid)',
                        backgroundColor: 'var(--success-alpha-10)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'var(--success-solid)',
                        pointBorderColor: 'var(--card-bg)',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: 'var(--success-light)',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--text-muted)' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'var(--separator)' },
                            ticks: { color: 'var(--text-muted)' }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating project activity chart:', error);
            // Create chart with sample data if Firebase fails
            if (projectActivityChartInstance) {
                projectActivityChartInstance.destroy();
            }

            projectActivityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jul 5', 'Jul 6', 'Jul 7', 'Jul 8', 'Jul 9', 'Jul 10', 'Jul 11'],
                    datasets: [{
                        label: 'Project Updates',
                        data: [1, 2, 1, 3, 2, 1, 2],
                        borderColor: 'var(--success-solid)',
                        backgroundColor: 'var(--success-alpha-10)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    }

    // Function to create Geographic Distribution Chart
    async function createGeographicChart() {
        const ctx = document.getElementById('geographicChart');
        if (!ctx) return;

        try {
            // Simulate geographic data (in real app, this would come from user location data)
            const locations = {
                'Bangalore': 45,
                'Mumbai': 32,
                'Delhi': 28,
                'Chennai': 22,
                'Hyderabad': 18,
                'Pune': 15,
                'Kolkata': 12,
                'Others': 8
            };

            if (geographicChartInstance) {
                geographicChartInstance.destroy();
            }

            geographicChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(locations),
                    datasets: [{
                        data: Object.values(locations),
                        backgroundColor: [
                            'var(--primary)',
                            'var(--secondary)',
                            'var(--accent)',
                            'var(--success)',
                            'var(--warning)',
                            'var(--danger)',
                            '#6f42c1',
                            '#fd7e14'
                        ],
                        borderWidth: 2,
                        borderColor: 'var(--card-bg)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                color: 'var(--text-main)'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} users (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        } catch (error) {
            console.error('Error creating geographic chart:', error);
        }
    }

    function updateUserAttendanceChart(labels, data) {
        const chartElement = document.getElementById('userAttendanceChart');
        if (!chartElement) {
            console.warn('userAttendanceChart element not found');
            return;
        }
        const ctx = chartElement.getContext('2d');
        
        // If no data, show a message
        if (labels.length === 0 || data.every(val => val === 0)) {
            if (userAttendanceChartInstance) {
                userAttendanceChartInstance.destroy();
                userAttendanceChartInstance = null;
            }
            
            // Display a message in the chart area
            ctx.font = '14px Arial';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            ctx.fillText('No attendance data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        
        if (userAttendanceChartInstance) {
            userAttendanceChartInstance.destroy();
        }
        
        userAttendanceChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Present Days',
                    data: data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)'
                    ],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }
    
    // Edit subject 
    function editSubject(id, subject) {
        // Populate the edit form with subject data
        document.getElementById('editSubjectId').value = id;
        document.getElementById('editSubjectName').value = subject.name || '';
        
        // Set class order if available
        document.getElementById('editClassOrder').value = subject.classOrder || '';
        
        // Reset all checkboxes first
        document.querySelectorAll('.edit-class-day-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Check the days that this subject is taught
        if (subject.classDays && Array.isArray(subject.classDays)) {
            subject.classDays.forEach(day => {
                const checkbox = document.getElementById('edit' + day);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editSubjectModal'));
        modal.show();
    }
    
    // Update subject changes
    function updateSubject() {
        const id = document.getElementById('editSubjectId').value;
        const name = document.getElementById('editSubjectName').value.trim();
        
        if (!name) {
            showToast('Please enter a subject name.', 'warning');
            return;
        }
        
        // Get all selected days
        const selectedDays = [];
        document.querySelectorAll('.edit-class-day-checkbox:checked').forEach(checkbox => {
            selectedDays.push(checkbox.value);
        });
        
        if (selectedDays.length === 0) {
            showToast('Please select at least one class day.', 'warning');
            return;
        }
        
        // Get class order
        const classOrder = parseInt(document.getElementById('editClassOrder').value) || null;
        
        const saveBtn = document.getElementById('saveSubjectChanges');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
        
        db.collection('subjects').doc(id).update({
            name: name,
            classDays: selectedDays,
            classOrder: classOrder,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editSubjectModal')).hide();
            showToast('Subject updated successfully!', 'success');
            loadSubjects();
        })
        .catch(error => {
            console.error("Error updating subject:", error);
            showToast('Error updating subject: ' + error.message, 'danger');
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'Save Changes';
        });
    }

    // Edit attendance record
    function editAttendanceRecord(recordId, recordData) {
        // Populate the edit form with record data
        document.getElementById('editAttendanceId').value = recordId;
        document.getElementById('editAttendanceUser').value = recordData.userName;
        document.getElementById('editAttendanceSubject').value = recordData.subjectName;
        document.getElementById('editAttendanceDate').value = recordData.date;
        document.getElementById('editAttendanceNotes').value = recordData.notes || '';
        
        // Set status radio button
        if (recordData.status === 'present') {
            document.getElementById('editStatusPresent').checked = true;
        } else {
            document.getElementById('editStatusAbsent').checked = true;
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editAttendanceModal'));
        modal.show();
    }
    
    // Update attendance record
    function updateAttendanceRecord() {
        const recordId = document.getElementById('editAttendanceId').value;
        const date = document.getElementById('editAttendanceDate').value;
        const status = document.querySelector('input[name="editAttendanceStatus"]:checked').value;
        const notes = document.getElementById('editAttendanceNotes').value.trim();
        
        if (!date) {
            showToast('Please select a date.', 'warning');
            return;
        }
        
        const saveBtn = document.getElementById('saveAttendanceChanges');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
        
        // First get the original record to check if status has changed
        db.collection('manualAttendance').doc(recordId).get()
            .then(doc => {
                const originalData = doc.data();
                const statusChanged = originalData.status !== status;
                const userId = originalData.userId;
                const subjectName = originalData.subjectName;
                
                // Update the attendance record
                return db.collection('manualAttendance').doc(recordId).update({
                    date: date,
                    status: status,
                    notes: notes,
                    updatedById: currentUser.uid,
                    updatedByName: 'Admin',
                    updatedByEmail: currentUser.email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => ({ statusChanged, userId, subjectName, originalStatus: originalData.status }));
            })
            .then(({ statusChanged, userId, subjectName, originalStatus }) => {
                // If status changed, update the user's attendance data
                if (statusChanged && userId && subjectName) {
                    return db.collection('users').doc(userId).get().then(doc => {
                        const userData = doc.data() || {};
                        const attendanceData = userData.attendanceData || { subjects: {} };
                        
                        // Initialize subject data if it doesn't exist
                        if (!attendanceData.subjects[subjectName]) {
                            attendanceData.subjects[subjectName] = { present: 0, absent: 0 };
                        }
                        
                        // Decrement the original status count
                        if (originalStatus === 'present') {
                            attendanceData.subjects[subjectName].present = Math.max(0, (attendanceData.subjects[subjectName].present || 0) - 1);
                        } else {
                            attendanceData.subjects[subjectName].absent = Math.max(0, (attendanceData.subjects[subjectName].absent || 0) - 1);
                        }
                        
                        // Increment the new status count
                        if (status === 'present') {
                            attendanceData.subjects[subjectName].present += 1;
                        } else {
                            attendanceData.subjects[subjectName].absent += 1;
                        }
                        
                        // Update the user document with the new attendance data
                        return db.collection('users').doc(userId).update({
                            attendanceData: attendanceData,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                }
                return Promise.resolve();
            })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('editAttendanceModal')).hide();
                showToast('Attendance record updated successfully!', 'success');
                loadRecentAttendance();
                
                // Also refresh user data to update stats
                loadUserData();
            })
            .catch(error => {
                console.error("Error updating attendance:", error);
                showToast('Error updating attendance: ' + error.message, 'danger');
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'Save Changes';
            });
    }
    
    // Delete attendance record
    function deleteAttendanceRecord(recordId, recordData) {
        if (!confirm(`Are you sure you want to delete this attendance record for ${recordData.userName}?`)) {
            return;
        }
        
        // First, save the record to the deleted records collection
        db.collection('deletedRecords').add({
            itemType: 'manualAttendance',
            originalId: recordId,
            itemData: recordData,
            deletedById: currentUser.uid,
            deletedByName: 'Admin',
            deletedByEmail: currentUser.email,
            deletedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            // Now delete the record
            return db.collection('manualAttendance').doc(recordId).delete();
        })
        .then(() => {
            // Update the user's attendance data
            return db.collection('users').doc(recordData.userId).get().then(doc => {
                const userData = doc.data() || {};
                const attendanceData = userData.attendanceData || { subjects: {} };
                
                // Initialize subject data if it doesn't exist
                if (!attendanceData.subjects[recordData.subjectName]) {
                    attendanceData.subjects[recordData.subjectName] = { present: 0, absent: 0 };
                }
                
                // Decrement the status count
                if (recordData.status === 'present') {
                    attendanceData.subjects[recordData.subjectName].present = Math.max(0, (attendanceData.subjects[recordData.subjectName].present || 0) - 1);
                } else {
                    attendanceData.subjects[recordData.subjectName].absent = Math.max(0, (attendanceData.subjects[recordData.subjectName].absent || 0) - 1);
                }
                
                // Update the user document with the new attendance data
                return db.collection('users').doc(recordData.userId).update({
                    attendanceData: attendanceData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
        })
        .then(() => {
            showToast('Attendance record deleted successfully!', 'success');
            loadRecentAttendance();
            
            // Also refresh user data to update stats
            loadUserData();
        })
        .catch(error => {
            console.error("Error deleting attendance:", error);
            showToast('Error deleting attendance: ' + error.message, 'danger');
        });
    }
    
    // Note: showToast function is defined earlier in the enhanced initialization section
    
    // Check if user is admin
    function checkAdmin(email) {
        console.log("Checking admin status for email:", email);
        console.log("Admin emails list:", adminEmails);
        const isAdmin = adminEmails.includes(email);
        console.log("Is admin:", isAdmin);
        return isAdmin;
    }
    
    // Check if running on Netlify and show Firebase rules information
    function checkNetlifyEnvironment() {
        console.log("Checking if running on Netlify...");
        
        // Check if we're on Netlify by looking at the hostname
        const isNetlify = window.location.hostname.includes('netlify.app') || 
                          window.location.hostname.includes('netlify.com');
                          
        // Check for potential CORS issues
        checkCorsIssues();
                          
        if (isNetlify) {
            console.log("Running on Netlify domain:", window.location.hostname);
            
            // Create a dismissible warning at the top of the page
            const warningDiv = document.createElement('div');
            warningDiv.className = 'alert alert-warning alert-dismissible fade show mx-3 mt-3';
            warningDiv.innerHTML = `
                <strong>Netlify Deployment Notice:</strong> 
                If you're seeing this message and data is not loading, you need to update your Firebase Security Rules.
                Add the domain <code>${window.location.hostname}</code> to your authorized domains in Firebase console.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                <div class="mt-2">
                    <button class="btn btn-sm btn-info" id="showFirebaseRulesBtn">Show Firebase Rules Tips</button>
                </div>
            `;
            
            // Insert the warning at the top of the body
            document.body.insertBefore(warningDiv, document.body.firstChild);
            
            // Add event listener to the button
            document.getElementById('showFirebaseRulesBtn').addEventListener('click', showFirebaseRulesTips);
        }
    }
    
    // Show Firebase rules tips
    function showFirebaseRulesTips() {
        // Create modal if it doesn't exist
        if (!document.getElementById('rulesModal')) {
            const modalDiv = document.createElement('div');
            modalDiv.className = 'modal fade';
            modalDiv.id = 'rulesModal';
            modalDiv.setAttribute('tabindex', '-1');
            modalDiv.setAttribute('aria-labelledby', 'rulesModalLabel');
            modalDiv.setAttribute('aria-hidden', 'true');
            
            modalDiv.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="rulesModalLabel">Firebase Rules for Netlify Deployment</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>To make your Firebase database work with your Netlify deployment, you need to update your security rules:</p>
                            
                            <h6 class="mt-3">Step 1: Add Netlify domain to Firebase Authentication</h6>
                            <ol>
                                <li>Go to the <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                                <li>Select your project</li>
                                <li>Go to Authentication  Settings  Authorized Domains</li>
                                <li>Add your Netlify domain: <code>${window.location.hostname}</code></li>
                            </ol>
                            
                            <h6 class="mt-3">Step 2: Update Firestore Rules</h6>
                            <p>Go to Firestore Database  Rules and update with rules like these:</p>
                            <pre class="bg-light p-3 border rounded"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow admin operations on all documents
    match /{document=**} {
      allow read, write: if request.auth != null && 
        request.auth.token.email in ['admin@admin.com', 'youremail@example.com'];
    }
    
    // Allow authenticated users to read their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow authenticated users to read subject data
    match /subjects/{document=**} {
      allow read: if request.auth != null;
    }
  }
}</code></pre>

                            <div class="alert alert-info mt-3">
                                <strong>Tip:</strong> Make sure to replace <code>youremail@example.com</code> with your actual admin email.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modalDiv);
        }
        
        // Show the modal
        const rulesModal = new bootstrap.Modal(document.getElementById('rulesModal'));
        rulesModal.show();
    }

    // Check for potential CORS issues
    function checkCorsIssues() {
        // Make a simple test request to Firestore
        console.log("Testing Firestore connectivity...");
        db.collection('test_connection').doc('test').get()
            .then(() => {
                console.log(" Firestore connection successful");
            })
            .catch(error => {
                console.error(" Firestore connection error:", error);
                
                // Check if it's a CORS error
                if (error.code === 'permission-denied' || error.name === 'FirebaseError') {
                    console.warn("This may be a Firebase rules or CORS issue");
                    
                    // Create a toast notification
                    showToast('Firebase connectivity issue detected. Check console for details.', 'warning');
                }
            });
    }
    
    // Create manual attendance collection if it doesn't exist
    function createManualAttendanceCollection() {
        if (!currentUser) {
            showToast('Authentication error. Please reload the page.', 'danger');
            return;
        }
        
        showToast('Creating manual attendance collection...', 'info');
        db.collection('manualAttendance').doc('initial').set({
            userId: 'initial',
            userName: 'Initial User',
            userEmail: 'initial@example.com',
            subjectId: 'initial',
            subjectName: 'Initial Subject',
            date: new Date().toISOString().split('T')[0],
            status: 'present',
            notes: 'Initial record to establish collection',
            addedById: currentUser.uid,
            addedByName: 'Admin',
            addedByEmail: currentUser.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            showToast('Manual attendance collection created successfully!', 'success');
            loadRecentAttendance();
        })
        .catch(error => {
            showToast('Error creating manual attendance collection: ' + error.message, 'danger');
            console.error("Error creating manual attendance collection:", error);
        });
    }

    // Add manual attendance record
    function addManualAttendance() {
        const userId = document.getElementById('attendanceUserSelect').value;
        const subjectId = document.getElementById('attendanceSubjectSelect').value;
        const date = document.getElementById('attendanceDate').value;
        const status = document.querySelector('input[name="attendanceStatus"]:checked')?.value;
        const notes = document.getElementById('attendanceNotes').value.trim();
        
        if (!userId) {
            showToast('Please select a user.', 'warning');
            return;
        }
        
        if (!subjectId) {
            showToast('Please select a subject.', 'warning');
            return;
        }
        
        if (!date) {
            showToast('Please select a date.', 'warning');
            return;
        }
        
        if (!status) {
            showToast('Please select a status.', 'warning');
            return;
        }
        
        const addBtn = document.getElementById('addAttendanceBtn');
        addBtn.disabled = true;
        addBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';
        
        // Get user and subject details
        Promise.all([
            db.collection('users').doc(userId).get(),
            db.collection('subjects').doc(subjectId).get()
        ])
        .then(([userDoc, subjectDoc]) => {
            if (!userDoc.exists) {
                throw new Error('User not found');
            }
            
            if (!subjectDoc.exists) {
                throw new Error('Subject not found');
            }
            
            const userData = userDoc.data();
            const subjectData = subjectDoc.data();
            
            // Create attendance record
            return db.collection('manualAttendance').add({
                userId: userId,
                userName: userData.name || userData.email || 'Unknown',
                userEmail: userData.email || 'No email',
                subjectId: subjectId,
                subjectName: subjectData.name || 'Unknown Subject',
                date: date,
                status: status,
                notes: notes,
                addedById: currentUser.uid,
                addedByName: 'Admin',
                addedByEmail: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => ({ userData, subjectData }));
        })
        .then(({ userData, subjectData }) => {
            // Update the user's attendance data
            const attendanceData = userData.attendanceData || { subjects: {} };
            const subjectName = subjectData.name;
            
            // Initialize subject data if it doesn't exist
            if (!attendanceData.subjects[subjectName]) {
                attendanceData.subjects[subjectName] = { present: 0, absent: 0 };
            }
            
            // Update the attendance count
            if (status === 'present') {
                attendanceData.subjects[subjectName].present = (attendanceData.subjects[subjectName].present || 0) + 1;
            } else {
                attendanceData.subjects[subjectName].absent = (attendanceData.subjects[subjectName].absent || 0) + 1;
            }
            
            // Update the user document with the new attendance data
            return db.collection('users').doc(userId).update({
                attendanceData: attendanceData,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        })
        .then(() => {
            showToast('Attendance record added successfully!', 'success');
            
            // Clear form
            document.getElementById('attendanceUserSelect').value = '';
            document.getElementById('attendanceSubjectSelect').value = '';
            document.getElementById('attendanceNotes').value = '';
            document.getElementById('statusPresent').checked = true;
            
            // Reload attendance data
            loadRecentAttendance();
            
            // Also refresh user data to update stats
            loadUserData();
        })
        .catch(error => {
            console.error("Error adding attendance:", error);
            showToast('Error adding attendance: ' + error.message, 'danger');
        })
        .finally(() => {
            addBtn.disabled = false;
            addBtn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Add Attendance';
        });
    }

    // Function to load error logs with enhanced error handling and debugging
    async function loadErrorLogs(searchTerm = '') {
        const tbody = safeGetElement('errorLogsTableBody', 'Load Error Logs');
        const spinner = safeGetElement('errorLogsSpinner', 'Load Error Logs');

        console.log(' Loading error logs...', { searchTerm });

        if (!tbody) {
            console.error(" Error logs table body not found");
            return;
        }

        if (!spinner) {
            console.warn(" Error logs spinner not found");
        }

        // Show spinner
        if (spinner) {
            spinner.style.display = 'block';
        }
        tbody.innerHTML = '';

        try {
            // Check Firebase connection
            if (!firebase || !firebase.firestore) {
                throw new Error('Firebase not initialized properly');
            }

            const db = firebase.firestore();
            console.log(' Firebase connection established');

            // Get filter values
            const typeFilter = document.getElementById('errorTypeFilter')?.value || '';
            const dateFrom = document.getElementById('errorDateFrom')?.value;
            const dateTo = document.getElementById('errorDateTo')?.value;

            console.log(' Filters applied:', { typeFilter, dateFrom, dateTo });

            // Build query with better error handling
            let query = db.collection('errorLogs');

            // Apply date filters if provided
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                query = query.where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(fromDate));
                console.log(' Date from filter applied:', fromDate);
            }

            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                query = query.where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(toDate));
                console.log(' Date to filter applied:', toDate);
            }

            // Order by timestamp and limit results
            query = query.orderBy('timestamp', 'desc').limit(100);

            console.log(' Executing Firestore query...');
            const snapshot = await query.get();
            console.log(` Query completed. Found ${snapshot.size} documents`);

            if (snapshot.empty) {
                console.log(' No error logs found in database');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <div class="py-4">
                                <i class="fas fa-inbox fa-2x mb-3 text-muted"></i>
                                <p class="mb-2">No error logs found</p>
                                <small class="text-muted">Error logs will appear here when errors occur in the application</small>
                                <br>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="generateTestErrorLogs()" id="generateTestErrorsBtn">
                                    <i class="fas fa-flask me-1"></i>Generate Test Data
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                if (spinner) spinner.style.display = 'none';
                return;
            }

            const errorLogs = [];
            snapshot.forEach(doc => {
                const errorData = doc.data();
                console.log(' Processing error log:', doc.id, errorData);
                errorLogs.push({ id: doc.id, ...errorData });
            });

            // Apply client-side filters
            let filteredLogs = errorLogs;

            // Filter by search term
            if (searchTerm) {
                const searchLower = searchTerm.toLowerCase();
                filteredLogs = filteredLogs.filter(log =>
                    (log.errorId && log.errorId.toLowerCase().includes(searchLower)) ||
                    (log.type && log.type.toLowerCase().includes(searchLower)) ||
                    (log.message && log.message.toLowerCase().includes(searchLower)) ||
                    (log.userName && log.userName.toLowerCase().includes(searchLower)) ||
                    (log.userEmail && log.userEmail.toLowerCase().includes(searchLower))
                );
                console.log(` Search filter applied. ${filteredLogs.length} results for "${searchTerm}"`);
            }

            // Filter by error type
            if (typeFilter) {
                filteredLogs = filteredLogs.filter(log =>
                    log.type && log.type.toLowerCase().includes(typeFilter.toLowerCase())
                );
                console.log(` Type filter applied. ${filteredLogs.length} results for type "${typeFilter}"`);
            }

            if (filteredLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No matching error logs found</td></tr>';
                if (spinner) spinner.style.display = 'none';
                return;
            }

            // Populate table
            console.log(` Populating table with ${filteredLogs.length} error logs`);
            filteredLogs.forEach((errorLog, index) => {
                try {
                    // Handle different timestamp formats
                    let timestamp = 'Unknown';
                    if (errorLog.timestamp) {
                        if (errorLog.timestamp.toDate) {
                            // Firestore Timestamp
                            timestamp = errorLog.timestamp.toDate().toLocaleString();
                        } else if (errorLog.timestamp.seconds) {
                            // Firestore Timestamp object
                            timestamp = new Date(errorLog.timestamp.seconds * 1000).toLocaleString();
                        } else if (typeof errorLog.timestamp === 'string' || typeof errorLog.timestamp === 'number') {
                            // String or number timestamp
                            timestamp = new Date(errorLog.timestamp).toLocaleString();
                        }
                    }

                    const errorType = errorLog.type || 'Unknown';
                    const errorMessage = errorLog.message || 'No message';
                    const errorId = errorLog.errorId || `ERR-${errorLog.id || index}`;
                    const userName = errorLog.userName || 'Unknown User';
                    const userEmail = errorLog.userEmail || 'No email';
                    const page = errorLog.page || 'Unknown';

                    // Truncate long messages
                    const truncatedMessage = errorMessage.length > 50 ?
                        errorMessage.substring(0, 50) + '...' : errorMessage;

                    // Create badge color based on error type
                    let badgeClass = 'bg-danger';
                    switch (errorType.toLowerCase()) {
                        case 'warning':
                            badgeClass = 'bg-warning';
                            break;
                        case 'info':
                            badgeClass = 'bg-info';
                            break;
                        case 'validation':
                            badgeClass = 'bg-secondary';
                            break;
                        case 'network':
                            badgeClass = 'bg-primary';
                            break;
                        default:
                            badgeClass = 'bg-danger';
                    }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <code class="text-danger">${errorId}</code>
                        </td>
                        <td>
                            <small>${timestamp}</small>
                        </td>
                        <td>
                            <span class="badge ${badgeClass}">${errorType}</span>
                        </td>
                        <td title="${errorMessage.replace(/"/g, '&quot;')}">${truncatedMessage}</td>
                        <td>
                            <strong>${userName}</strong>
                            <small class="text-muted d-block">${userEmail}</small>
                        </td>
                        <td><small>${page}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="showErrorDetails('${errorLog.id}', ${JSON.stringify(errorLog).replace(/"/g, '&quot;')})">
                                <i class="fas fa-eye"></i> Details
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                } catch (rowError) {
                    console.error(' Error creating table row:', rowError, errorLog);
                }
            });

            if (spinner) spinner.style.display = 'none';

            if (!searchTerm) {
                showToast(` Loaded ${filteredLogs.length} error logs successfully!`, 'success');
            }

            console.log(' Error logs loaded successfully');

        } catch (error) {
            console.error(" Error loading error logs:", error);

            // Provide detailed error information
            let errorMessage = error.message;
            if (error.code) {
                errorMessage += ` (Code: ${error.code})`;
            }

            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        <div class="py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p class="mb-2"><strong>Error loading logs</strong></p>
                            <small class="text-muted">${errorMessage}</small>
                            <br>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadErrorLogs()">
                                <i class="fas fa-sync-alt me-1"></i>Retry
                            </button>
                        </div>
                    </td>
                </tr>
            `;

            if (spinner) spinner.style.display = 'none';
            showToast(' Error loading error logs: ' + errorMessage, 'danger');
        }
    }

    // Function to generate test error logs
    async function generateTestErrorLogs() {
        const btn = document.getElementById('generateTestErrorsBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
        btn.disabled = true;

        try {
            const testErrors = [
                {
                    errorId: 'ERR-' + Date.now() + '-001',
                    type: 'javascript',
                    message: 'Cannot read property "length" of undefined',
                    stack: 'TypeError: Cannot read property "length" of undefined\n    at validateInput (script.js:123:45)\n    at submitForm (script.js:89:12)',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userName: 'Test User',
                    userEmail: 'test@example.com',
                    page: 'dashboard.html',
                    url: window.location.origin + '/dashboard.html',
                    browser: 'Chrome 91.0.4472.124',
                    os: 'Windows 10',
                    device: 'Desktop',
                    sessionId: 'sess_' + Math.random().toString(36).substr(2, 9)
                },
                {
                    errorId: 'ERR-' + Date.now() + '-002',
                    type: 'network',
                    message: 'Failed to fetch user data from server',
                    stack: 'NetworkError: Failed to fetch\n    at fetchUserData (api.js:45:23)\n    at loadProfile (profile.js:12:8)',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userName: 'Jane Smith',
                    userEmail: 'jane@example.com',
                    page: 'profile.html',
                    url: window.location.origin + '/profile.html',
                    browser: 'Firefox 89.0',
                    os: 'macOS 11.4',
                    device: 'Desktop',
                    sessionId: 'sess_' + Math.random().toString(36).substr(2, 9)
                },
                {
                    errorId: 'ERR-' + Date.now() + '-003',
                    type: 'firebase',
                    message: 'Permission denied: Missing or insufficient permissions',
                    stack: 'FirebaseError: Missing or insufficient permissions\n    at validateRequest (firebase-auth.js:234:56)\n    at signInUser (auth.js:78:90)',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userName: 'John Doe',
                    userEmail: 'john@example.com',
                    page: 'login.html',
                    url: window.location.origin + '/login.html',
                    browser: 'Safari 14.1.1',
                    os: 'iOS 14.6',
                    device: 'Mobile',
                    sessionId: 'sess_' + Math.random().toString(36).substr(2, 9)
                },
                {
                    errorId: 'ERR-' + Date.now() + '-004',
                    type: 'validation',
                    message: 'Invalid email format provided',
                    stack: 'ValidationError: Invalid email format\n    at validateEmail (validation.js:67:89)\n    at processForm (form.js:23:45)',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userName: 'Alice Johnson',
                    userEmail: 'alice@example.com',
                    page: 'admin.html',
                    url: window.location.origin + '/admin.html',
                    browser: 'Edge 91.0.864.59',
                    os: 'Windows 11',
                    device: 'Desktop',
                    sessionId: 'sess_' + Math.random().toString(36).substr(2, 9)
                }
            ];

            // Add test errors to Firestore
            const batch = firebase.firestore().batch();
            testErrors.forEach(error => {
                const docRef = firebase.firestore().collection('errorLogs').doc();
                batch.set(docRef, error);
            });

            await batch.commit();

            showToast('Test error logs generated successfully!', 'success');

            // Refresh the error logs display
            setTimeout(() => {
                loadErrorLogs();
            }, 1000);

        } catch (error) {
            console.error('Error generating test logs:', error);
            showToast('Failed to generate test error logs: ' + error.message, 'danger');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Function to clear all error logs
    async function clearAllErrorLogs() {
        if (!confirm('Are you sure you want to delete ALL error logs? This action cannot be undone.')) {
            return;
        }

        const btn = document.getElementById('clearErrorLogsBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Clearing...';
        btn.disabled = true;

        try {
            const snapshot = await firebase.firestore().collection('errorLogs').get();

            if (snapshot.empty) {
                showToast('No error logs to clear', 'info');
                return;
            }

            const batch = firebase.firestore().batch();
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });

            await batch.commit();

            showToast(`Cleared ${snapshot.size} error logs successfully!`, 'success');

            // Refresh the error logs display
            loadErrorLogs();

        } catch (error) {
            console.error('Error clearing error logs:', error);
            showToast('Failed to clear error logs: ' + error.message, 'danger');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Function to show error details in a modal
    function showErrorDetails(errorId, errorData) {
        // Create a modal for error details
        const modalHtml = `
            <div class="modal fade" id="errorDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Error Details: ${errorData.errorId}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Error ID:</strong> <code>${errorData.errorId}</code><br>
                                    <strong>Type:</strong> ${errorData.type}<br>
                                    <strong>Timestamp:</strong> ${errorData.timestamp ? new Date(errorData.timestamp.seconds * 1000).toLocaleString() : 'Unknown'}<br>
                                    <strong>User:</strong> ${errorData.userName} (${errorData.userEmail})<br>
                                    <strong>Page:</strong> ${errorData.page}<br>
                                    <strong>URL:</strong> ${errorData.url}<br>
                                </div>
                                <div class="col-md-6">
                                    <strong>Browser:</strong> ${errorData.browser || 'Unknown'}<br>
                                    <strong>OS:</strong> ${errorData.os || 'Unknown'}<br>
                                    <strong>Device:</strong> ${errorData.device || 'Unknown'}<br>
                                    <strong>Session ID:</strong> ${errorData.sessionId || 'Unknown'}<br>
                                </div>
                            </div>
                            <hr>
                            <strong>Error Message:</strong>
                            <pre class="bg-light p-3 rounded">${errorData.message}</pre>
                            ${errorData.stack ? `<strong>Stack Trace:</strong><pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">${errorData.stack}</pre>` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('errorDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('errorDetailsModal'));
        modal.show();
    }

    // Open Full Activity Log Modal
    function openFullActivityLogModal() {
        console.log(' Opening full activity log modal...');

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('fullActivityLogModal'));
        modal.show();

        // Load full activity log
        loadFullActivityLog();

        // Set up event listeners for the modal
        setupFullActivityLogListeners();
    }

    // Load full activity log with pagination
    let currentFullLogPage = 1;
    const fullLogPageSize = 100;

    async function loadFullActivityLog(page = 1, filters = {}) {
        console.log(' Loading full activity log...', { page, filters });

        const tbody = document.getElementById('fullActivityTableBody');
        const statsElement = document.getElementById('fullLogStats');

        if (!tbody) {
            console.error(' Full activity table body not found');
            return;
        }

        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Loading...</td></tr>';

        try {
            const db = firebase.firestore();
            let query = db.collection('userLogs');

            // Apply filters
            if (filters.dateFrom) {
                const fromDate = new Date(filters.dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                query = query.where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(fromDate));
            }

            if (filters.dateTo) {
                const toDate = new Date(filters.dateTo);
                toDate.setHours(23, 59, 59, 999);
                query = query.where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(toDate));
            }

            // Order and paginate
            query = query.orderBy('timestamp', 'desc');

            // Get total count for pagination (simplified approach)
            const totalSnapshot = await query.get();
            const totalLogs = totalSnapshot.size;
            const totalPages = Math.ceil(totalLogs / fullLogPageSize);

            // Apply pagination
            const startIndex = (page - 1) * fullLogPageSize;
            const logs = [];
            totalSnapshot.docs.slice(startIndex, startIndex + fullLogPageSize).forEach(doc => {
                logs.push({ id: doc.id, ...doc.data() });
            });

            // Clear table
            tbody.innerHTML = '';

            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No activity logs found</td></tr>';
                if (statsElement) statsElement.textContent = 'No logs found';
                return;
            }

            // Apply client-side filters
            let filteredLogs = logs;

            if (filters.search) {
                const searchLower = filters.search.toLowerCase();
                filteredLogs = filteredLogs.filter(log =>
                    (log.userName && log.userName.toLowerCase().includes(searchLower)) ||
                    (log.userEmail && log.userEmail.toLowerCase().includes(searchLower)) ||
                    (log.activity && log.activity.toLowerCase().includes(searchLower)) ||
                    (log.page && log.page.toLowerCase().includes(searchLower)) ||
                    (log.ipAddress && log.ipAddress.toLowerCase().includes(searchLower))
                );
            }

            if (filters.activityType && filters.activityType !== 'all') {
                filteredLogs = filteredLogs.filter(log => {
                    const activity = (log.activity || '').toLowerCase();
                    switch (filters.activityType) {
                        case 'login':
                            return activity.includes('login') || activity.includes('logout');
                        case 'attendance':
                            return activity.includes('attendance') || activity.includes('marked');
                        case 'view':
                            return activity.includes('viewed') || activity.includes('view');
                        case 'error':
                            return activity.includes('error');
                        default:
                            return true;
                    }
                });
            }

            // Populate table
            filteredLogs.forEach(log => {
                const tr = document.createElement('tr');

                // Format timestamp
                let timestamp = 'Unknown';
                if (log.timestamp) {
                    if (log.timestamp.toDate) {
                        timestamp = log.timestamp.toDate().toLocaleString();
                    } else if (log.timestamp.seconds) {
                        timestamp = new Date(log.timestamp.seconds * 1000).toLocaleString();
                    }
                }

                tr.innerHTML = `
                    <td><small>${timestamp}</small></td>
                    <td>
                        <strong>${log.userName || 'Unknown'}</strong>
                        <br><small class="text-muted">${log.userEmail || 'No email'}</small>
                    </td>
                    <td>${log.activity || 'Unknown'}</td>
                    <td>${log.page || 'Unknown'}</td>
                    <td>${log.device || log.browser || 'Unknown'}</td>
                    <td>${log.ipAddress || 'Unknown'}</td>
                    <td>
                        ${log.sessionId ?
                            `<span class="badge bg-info">${log.sessionId.substring(0, 8)}...</span>` :
                            '<span class="badge bg-secondary">No session</span>'
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showActivityDetails('${log.id}', ${JSON.stringify(log).replace(/"/g, '&quot;')})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Update stats and pagination
            if (statsElement) {
                statsElement.textContent = `Showing ${filteredLogs.length} of ${totalLogs} logs (Page ${page} of ${totalPages})`;
            }

            updateFullLogPagination(page, totalPages);
            currentFullLogPage = page;

        } catch (error) {
            console.error(' Error loading full activity log:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        Error loading logs: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    // Update pagination controls for full log
    function updateFullLogPagination(currentPage, totalPages) {
        const prevBtn = document.getElementById('fullLogPrevPage');
        const nextBtn = document.getElementById('fullLogNextPage');
        const currentPageSpan = document.getElementById('fullLogCurrentPage');

        if (currentPageSpan) currentPageSpan.textContent = currentPage;

        if (prevBtn) {
            prevBtn.parentElement.classList.toggle('disabled', currentPage <= 1);
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    loadFullActivityLog(currentPage - 1, getCurrentFullLogFilters());
                }
            };
        }

        if (nextBtn) {
            nextBtn.parentElement.classList.toggle('disabled', currentPage >= totalPages);
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    loadFullActivityLog(currentPage + 1, getCurrentFullLogFilters());
                }
            };
        }
    }

    // Get current filters from full log modal
    function getCurrentFullLogFilters() {
        return {
            search: document.getElementById('fullLogSearch')?.value || '',
            activityType: document.getElementById('fullLogFilter')?.value || 'all',
            dateFrom: document.getElementById('fullLogDateFrom')?.value || '',
            dateTo: document.getElementById('fullLogDateTo')?.value || ''
        };
    }

    // Setup event listeners for full activity log modal
    function setupFullActivityLogListeners() {
        const applyFiltersBtn = document.getElementById('applyFullLogFilters');
        if (applyFiltersBtn) {
            applyFiltersBtn.onclick = () => {
                loadFullActivityLog(1, getCurrentFullLogFilters());
            };
        }

        const clearFiltersBtn = document.getElementById('clearFullLogFilters');
        if (clearFiltersBtn) {
            clearFiltersBtn.onclick = () => {
                document.getElementById('fullLogSearch').value = '';
                document.getElementById('fullLogFilter').value = 'all';
                document.getElementById('fullLogDateFrom').value = '';
                document.getElementById('fullLogDateTo').value = '';
                loadFullActivityLog(1, {});
            };
        }

        const exportBtn = document.getElementById('exportFullLogs');
        if (exportBtn) {
            exportBtn.onclick = () => {
                exportFullActivityLog();
            };
        }
    }

    // Export full activity log
    async function exportFullActivityLog() {
        try {
            showToast('Preparing export...', 'info');

            const db = firebase.firestore();
            const snapshot = await db.collection('userLogs')
                .orderBy('timestamp', 'desc')
                .get();

            const logs = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                logs.push({
                    timestamp: data.timestamp ? data.timestamp.toDate().toLocaleString() : 'Unknown',
                    userName: data.userName || 'Unknown',
                    userEmail: data.userEmail || 'Unknown',
                    activity: data.activity || 'Unknown',
                    page: data.page || 'Unknown',
                    device: data.device || 'Unknown',
                    browser: data.browser || 'Unknown',
                    os: data.os || 'Unknown',
                    ipAddress: data.ipAddress || 'Unknown',
                    sessionId: data.sessionId || 'Unknown'
                });
            });

            // Create and download CSV
            const csvContent = [
                ['Timestamp', 'User Name', 'User Email', 'Activity', 'Page', 'Device', 'Browser', 'OS', 'IP Address', 'Session ID'],
                ...logs.map(log => [
                    log.timestamp, log.userName, log.userEmail, log.activity,
                    log.page, log.device, log.browser, log.os, log.ipAddress, log.sessionId
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `full_activity_log_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showToast('Activity log exported successfully!', 'success');
        } catch (error) {
            console.error('Error exporting activity log:', error);
            showToast('Error exporting activity log: ' + error.message, 'danger');
        }
    }

    // Show activity details in a modal
    function showActivityDetails(logId, logData) {
        // Set up the modal content
        document.getElementById('activityDetailsTitle').textContent = `Activity Details: ${logData.activity || 'Unknown'}`;
        
        const detailsContainer = document.getElementById('activityDetailsContent');
        if (!detailsContainer) return;
        
        // Format timestamp
        let timestamp = 'Unknown';
        if (logData.timestamp) {
            const date = logData.timestamp.toDate();
            timestamp = date.toLocaleString();
        }
        
        // Build HTML content with all available details
        let htmlContent = `
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Basic Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 30%">User:</th>
                            <td>${logData.userName || 'Unknown'} (${logData.userEmail || 'No email'})</td>
                        </tr>
                        <tr>
                            <th>Activity:</th>
                            <td>${logData.activity || 'Unknown'}</td>
                        </tr>
                        <tr>
                            <th>Timestamp:</th>
                            <td>${timestamp}</td>
                        </tr>
                        <tr>
                            <th>Page:</th>
                            <td>${logData.page || 'Unknown'}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">System Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 30%">IP Address:</th>
                            <td>${logData.ipAddress || 'Unknown'}</td>
                        </tr>
                        <tr>
                            <th>Browser:</th>
                            <td>${logData.browser || 'Unknown'}</td>
                        </tr>
                        <tr>
                            <th>Operating System:</th>
                            <td>${logData.os || 'Unknown'}</td>
                        </tr>
                        <tr>
                            <th>Device:</th>
                            <td>${logData.device || 'Unknown'}</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
        
        // Add additional data if available
        if (logData.additionalData) {
            htmlContent += `
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Additional Data</h5>
                    </div>
                    <div class="card-body">
                        <pre class="mb-0" style="max-height: 200px; overflow-y: auto;">${JSON.stringify(logData.additionalData, null, 2)}</pre>
                    </div>
                </div>
            `;
        }
        
        detailsContainer.innerHTML = htmlContent;
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('activityDetailsModal'));
        modal.show();
    }

    // Show deleted item details in a modal
    function showDeletedItemDetails(recordId, recordData) {
        // Set up the modal content
        document.getElementById('deletedDetailsTitle').textContent = `Deleted ${recordData.itemType || 'Item'} Details`;
        
        const detailsContainer = document.getElementById('deletedDetailsContent');
        if (!detailsContainer) return;
        
        // Format timestamp
        let deletedAt = 'Unknown';
        if (recordData.deletedAt) {
            const date = recordData.deletedAt.toDate();
            deletedAt = date.toLocaleString();
        }
        
        // Build HTML content with all available details
        let htmlContent = `
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Deletion Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 30%">Item Type:</th>
                            <td>${recordData.itemType || 'Unknown'}</td>
                        </tr>
                        <tr>
                            <th>Original ID:</th>
                            <td>${recordData.originalId || 'Unknown'}</td>
                        </tr>
                        <tr>
                            <th>Deleted By:</th>
                            <td>${recordData.deletedByName || 'Unknown'} (${recordData.deletedByEmail || 'No email'})</td>
                        </tr>
                        <tr>
                            <th>Deleted At:</th>
                            <td>${deletedAt}</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
        
        // Add item data if available
        if (recordData.itemData) {
            htmlContent += `
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Item Data</h5>
                    </div>
                    <div class="card-body">
                        <pre class="mb-0" style="max-height: 300px; overflow-y: auto;">${JSON.stringify(recordData.itemData, null, 2)}</pre>
                    </div>
                </div>
            `;
            
            // Add restore button if it's a restorable item type
            if (['subject', 'manualAttendance'].includes(recordData.itemType)) {
                htmlContent += `
                    <div class="mt-3">
                        <button id="restoreItemBtn" class="btn btn-warning">
                            <i class="fas fa-undo-alt me-2"></i>Restore Item
                        </button>
                    </div>
                `;
            }
        }
        
        detailsContainer.innerHTML = htmlContent;
        
        // Add event listener to restore button if it exists
        const restoreBtn = document.getElementById('restoreItemBtn');
        if (restoreBtn) {
            restoreBtn.addEventListener('click', () => restoreDeletedItem(recordId, recordData));
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('deletedDetailsModal'));
        modal.show();
    }
    
    // Restore a deleted item
    function restoreDeletedItem(recordId, recordData) {
        if (!confirm(`Are you sure you want to restore this ${recordData.itemType}?`)) {
            return;
        }
        
        const restoreBtn = document.getElementById('restoreItemBtn');
        if (restoreBtn) {
            restoreBtn.disabled = true;
            restoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Restoring...';
        }
        
        // Different restore logic based on item type
        let restorePromise;
        
        if (recordData.itemType === 'subject') {
            // Restore a subject
            restorePromise = db.collection('subjects').doc(recordData.originalId).set(recordData.itemData);
        } else if (recordData.itemType === 'manualAttendance') {
            // Restore attendance record
            restorePromise = db.collection('manualAttendance').doc(recordData.originalId).set(recordData.itemData);
        } else {
            // Generic restore
            restorePromise = Promise.reject(new Error('Cannot restore this item type'));
        }
        
        restorePromise
            .then(() => {
                // Delete the record from deleted records
                return db.collection('deletedRecords').doc(recordId).delete();
            })
            .then(() => {
                showToast(`${recordData.itemType} restored successfully!`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('deletedDetailsModal')).hide();
                
                // Reload relevant data
                loadDeletedReports();
                if (recordData.itemType === 'subject') {
                    loadSubjects();
                } else if (recordData.itemType === 'manualAttendance') {
                    loadRecentAttendance();
                }
            })
            .catch(error => {
                console.error("Error restoring item:", error);
                showToast('Error restoring item: ' + error.message, 'danger');
            })
            .finally(() => {
                if (restoreBtn) {
                    restoreBtn.disabled = false;
                    restoreBtn.innerHTML = '<i class="fas fa-undo-alt me-2"></i>Restore Item';
                }
            });
    }

    // Show/hide loading overlay
    function showLoading(show = true) {
        const overlay = document.getElementById('loadingOverlay');
        if(show) {
            overlay.classList.remove('d-none');
            overlay.classList.add('d-flex');
        } else {
            overlay.classList.add('d-none');
            overlay.classList.remove('d-flex');
        }
    }

    // Notification Management Functions
    function initializeNotificationManagement() {
        // Prevent multiple initializations
        if (window.notificationManagementInitialized) {
            console.log('Notification management already initialized, skipping...');
            return;
        }

        console.log('Initializing notification management...');

        // Load users for specific notification dropdown
        loadUsersForNotifications();

        // Setup notification form
        setupNotificationForm();

        // Load recent notifications
        loadRecentNotifications();

        // Load all notifications
        loadAllNotifications();

        // Setup delete all notifications button
        const deleteAllBtn = document.getElementById('deleteAllNotificationsBtn');
        if (deleteAllBtn && !deleteAllBtn.dataset.listenerAdded) {
            deleteAllBtn.addEventListener('click', deleteAllNotifications);
            deleteAllBtn.dataset.listenerAdded = 'true';
        }

        // Mark as initialized
        window.notificationManagementInitialized = true;
        console.log('Notification management initialization completed');
    }

    function loadUsersForNotifications() {
        firebase.firestore().collection('users').get()
            .then(snapshot => {
                const specificUserSelect = document.getElementById('specificUser');
                specificUserSelect.innerHTML = '<option value="">Select a user</option>';

                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${userData.name || 'Unknown'} (${userData.email || 'No email'})`;
                    specificUserSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading users for notifications:', error);
            });
    }

    function setupNotificationForm() {
        const form = document.getElementById('notificationForm');
        const recipientSelect = document.getElementById('notificationRecipient');
        const specificUserDiv = document.getElementById('specificUserDiv');

        // Check if form is already set up to prevent duplicate event listeners
        if (form && form.dataset.setupComplete === 'true') {
            console.log('Notification form already set up, skipping...');
            return;
        }

        if (!form) {
            console.error('Notification form not found');
            return;
        }

        // Show/hide specific user dropdown
        if (recipientSelect) {
            recipientSelect.addEventListener('change', function() {
                if (this.value === 'specific') {
                    if (specificUserDiv) specificUserDiv.style.display = 'block';
                } else {
                    if (specificUserDiv) specificUserDiv.style.display = 'none';
                }
            });
        }

        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            sendNotification();
        });

        // Mark form as set up
        form.dataset.setupComplete = 'true';
        console.log('Notification form setup completed');
    }

    function sendNotification() {
        // Prevent multiple rapid submissions
        if (window.notificationSending) {
            console.log('Notification already being sent, ignoring duplicate request');
            return;
        }

        const authorName = document.getElementById('authorName').value;
        const title = document.getElementById('notificationTitle').value;
        const message = document.getElementById('notificationMessage').value;
        const recipient = document.getElementById('notificationRecipient').value;
        const specificUser = document.getElementById('specificUser').value;
        const isUrgent = document.getElementById('notificationUrgent').checked;

        if (!authorName || !title || !message || !recipient) {
            showToast('Please fill in all required fields including author name', 'error');
            return;
        }

        if (recipient === 'specific' && !specificUser) {
            showToast('Please select a specific user', 'error');
            return;
        }

        // Set sending flag
        window.notificationSending = true;
        console.log('Starting notification send process...');

        // Disable submit button to prevent multiple clicks
        const submitBtn = document.querySelector('#notificationForm button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
        }

        const notificationData = {
            title: title,
            message: message,
            authorName: authorName, // Custom author name from form
            senderName: authorName, // For backward compatibility
            senderEmail: currentUser.email,
            senderId: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            urgent: isUrgent,
            read: false,
            isAdmin: true // Mark as admin message
        };

        if (recipient === 'all') {
            // Send to all users
            sendToAllUsers(notificationData);
        } else {
            // Send to specific user
            notificationData.recipientId = specificUser;
            sendToSpecificUser(notificationData);
        }
    }

    function sendToAllUsers(notificationData) {
        // Get all users first
        firebase.firestore().collection('users').get()
            .then(snapshot => {
                const batch = firebase.firestore().batch();

                snapshot.forEach(doc => {
                    const notificationRef = firebase.firestore().collection('notifications').doc();
                    const userNotificationData = {
                        ...notificationData,
                        recipientId: doc.id,
                        recipientName: doc.data().name || 'Unknown',
                        recipientEmail: doc.data().email || 'No email'
                    };
                    batch.set(notificationRef, userNotificationData);
                });

                return batch.commit();
            })
            .then(() => {
                console.log('Notification sent to all users successfully');
                showToast('Notification sent to all users successfully!', 'success');
                clearNotificationForm();
                loadRecentNotifications();
                loadAllNotifications();
            })
            .catch(error => {
                console.error('Error sending notification to all users:', error);
                showToast('Error sending notification: ' + error.message, 'error');
            })
            .finally(() => {
                // Reset sending flag and restore button
                resetNotificationSendingState();
            });
    }

    function sendToSpecificUser(notificationData) {
        // Get user data first
        firebase.firestore().collection('users').doc(notificationData.recipientId).get()
            .then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    notificationData.recipientName = userData.name || 'Unknown';
                    notificationData.recipientEmail = userData.email || 'No email';

                    return firebase.firestore().collection('notifications').add(notificationData);
                } else {
                    throw new Error('User not found');
                }
            })
            .then(() => {
                console.log('Notification sent to specific user successfully');
                showToast('Notification sent successfully!', 'success');
                clearNotificationForm();
                loadRecentNotifications();
                loadAllNotifications();
            })
            .catch(error => {
                console.error('Error sending notification:', error);
                showToast('Error sending notification: ' + error.message, 'error');
            })
            .finally(() => {
                // Reset sending flag and restore button
                resetNotificationSendingState();
            });
    }

    function resetNotificationSendingState() {
        // Reset sending flag
        window.notificationSending = false;

        // Restore submit button
        const submitBtn = document.querySelector('#notificationForm button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-send me-2"></i>Send Notification';
        }

        console.log('Notification sending state reset');
    }

    function clearNotificationForm() {
        document.getElementById('notificationForm').reset();
        document.getElementById('specificUserDiv').style.display = 'none';

        // Also reset the sending state when clearing the form
        resetNotificationSendingState();
    }

    function loadRecentNotifications() {
        firebase.firestore()
            .collection('notifications')
            .orderBy('timestamp', 'desc')
            .limit(5)
            .get()
            .then(snapshot => {
                const tbody = document.getElementById('recentNotificationsTable');
                tbody.innerHTML = '';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No notifications sent yet</td></tr>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'Unknown';

                    row.innerHTML = `
                        <td>${data.title || 'No title'}</td>
                        <td>${data.recipientName || 'Unknown'}</td>
                        <td>${timestamp}</td>
                        <td><span class="badge ${data.read ? 'bg-success' : 'bg-warning'}">${data.read ? 'Read' : 'Unread'}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error loading recent notifications:', error);
            });
    }

    function loadAllNotifications() {
        firebase.firestore()
            .collection('notifications')
            .orderBy('timestamp', 'desc')
            .get()
            .then(snapshot => {
                const tbody = document.querySelector('#allNotificationsTable tbody');
                tbody.innerHTML = '';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No notifications found</td></tr>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'Unknown';

                    row.innerHTML = `
                        <td>${data.title || 'No title'}</td>
                        <td>${data.message ? (data.message.length > 50 ? data.message.substring(0, 50) + '...' : data.message) : 'No message'}</td>
                        <td>${data.recipientName || 'Unknown'}</td>
                        <td>${timestamp}</td>
                        <td><span class="badge ${data.read ? 'bg-success' : 'bg-warning'}">${data.read ? 'Read' : 'Unread'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteNotificationAdmin('${doc.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error loading all notifications:', error);
            });
    }

    function deleteNotificationAdmin(notificationId) {
        if (confirm('Are you sure you want to delete this notification?')) {
            firebase.firestore()
                .collection('notifications')
                .doc(notificationId)
                .delete()
                .then(() => {
                    showToast('Notification deleted successfully', 'success');
                    loadRecentNotifications();
                    loadAllNotifications();
                })
                .catch(error => {
                    console.error('Error deleting notification:', error);
                    showToast('Error deleting notification', 'error');
                });
        }
    }

    // Function to delete all notifications
    function deleteAllNotifications() {
        // Show confirmation dialog with detailed warning
        const confirmMessage = ` WARNING: This action will permanently delete ALL notifications from the system.

This includes:
 All sent notifications to users
 All read and unread messages
 All notification history

This action CANNOT be undone.

Are you absolutely sure you want to proceed?`;

        if (!confirm(confirmMessage)) {
            return;
        }

        // Second confirmation for extra safety
        const secondConfirm = prompt('To confirm this destructive action, please type "DELETE ALL" (without quotes):');
        if (secondConfirm !== 'DELETE ALL') {
            showToast('Action cancelled - confirmation text did not match', 'warning');
            return;
        }

        // Show loading state
        const deleteBtn = document.getElementById('deleteAllNotificationsBtn');
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
        deleteBtn.disabled = true;

        // Get all notifications and delete them in batches
        firebase.firestore()
            .collection('notifications')
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    showToast('No notifications to delete', 'info');
                    return;
                }

                const totalNotifications = snapshot.size;
                console.log(`Deleting ${totalNotifications} notifications...`);

                // Delete in batches of 500 (Firestore batch limit)
                const batchSize = 500;
                const batches = [];
                let currentBatch = firebase.firestore().batch();
                let operationCount = 0;

                snapshot.forEach(doc => {
                    currentBatch.delete(doc.ref);
                    operationCount++;

                    if (operationCount === batchSize) {
                        batches.push(currentBatch);
                        currentBatch = firebase.firestore().batch();
                        operationCount = 0;
                    }
                });

                // Add the last batch if it has operations
                if (operationCount > 0) {
                    batches.push(currentBatch);
                }

                // Execute all batches
                return Promise.all(batches.map(batch => batch.commit()));
            })
            .then(() => {
                showToast('All notifications deleted successfully', 'success');
                loadRecentNotifications();
                loadAllNotifications();

                // Log the action for audit purposes
                console.log(`Admin ${currentUser.email} deleted all notifications at ${new Date().toISOString()}`);

                // Optionally log to a separate audit collection
                firebase.firestore().collection('adminAuditLog').add({
                    action: 'DELETE_ALL_NOTIFICATIONS',
                    adminEmail: currentUser.email,
                    adminUid: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    details: 'All notifications were deleted from the system'
                }).catch(error => {
                    console.warn('Failed to log audit entry:', error);
                });
            })
            .catch(error => {
                console.error('Error deleting all notifications:', error);
                showToast('Error deleting notifications: ' + error.message, 'error');
            })
            .finally(() => {
                // Restore button state
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            });
    }

    // Remove the duplicate auth state listener - we already have one above
    // Just ensure notification management is initialized when admin logs in

    // Error Analytics Chart Variables
    let errorTrendsChartInstance = null;
    let errorTypesChartInstance = null;
    let errorsByUserChartInstance = null;
    let errorsByPageChartInstance = null;

    // Function to toggle error analytics section
    function toggleErrorAnalytics() {
        const section = document.getElementById('errorAnalyticsSection');
        const btn = document.getElementById('toggleErrorChartsBtn');

        if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-chart-bar me-1"></i>Hide Analytics';
            createErrorAnalyticsCharts();
        } else {
            section.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-chart-bar me-1"></i>Analytics';
        }
    }

    // Function to create all error analytics charts
    async function createErrorAnalyticsCharts() {
        try {
            await Promise.all([
                createErrorTrendsChart(),
                createErrorTypesChart(),
                createErrorsByUserChart(),
                createErrorsByPageChart()
            ]);
        } catch (error) {
            console.error('Error creating analytics charts:', error);
        }
    }

    // Function to create Error Trends Chart
    async function createErrorTrendsChart() {
        const ctx = document.getElementById('errorTrendsChart');
        if (!ctx) return;

        try {
            const snapshot = await firebase.firestore().collection('errorLogs')
                .orderBy('timestamp', 'desc')
                .limit(100)
                .get();

            const last7Days = {};

            // Initialize last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                last7Days[dateStr] = 0;
            }

            snapshot.forEach(doc => {
                const error = doc.data();
                const timestamp = error.timestamp ? error.timestamp.toDate() : new Date();
                const dateStr = timestamp.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                if (last7Days.hasOwnProperty(dateStr)) {
                    last7Days[dateStr]++;
                }
            });

            if (errorTrendsChartInstance) {
                errorTrendsChartInstance.destroy();
            }

            errorTrendsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(last7Days),
                    datasets: [{
                        label: 'Errors',
                        data: Object.values(last7Days),
                        borderColor: 'var(--error-solid)',
                        backgroundColor: 'var(--error-alpha-10)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: 'var(--error-solid)',
                        pointBorderColor: 'var(--card-bg)',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: 'var(--error-light)',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--text-muted)' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'var(--separator)' },
                            ticks: { color: 'var(--text-muted)' }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating error trends chart:', error);
        }
    }

    // Function to create Error Types Chart
    async function createErrorTypesChart() {
        const ctx = document.getElementById('errorTypesChart');
        if (!ctx) return;

        try {
            const snapshot = await firebase.firestore().collection('errorLogs')
                .orderBy('timestamp', 'desc')
                .limit(100)
                .get();

            const errorTypes = {};

            snapshot.forEach(doc => {
                const error = doc.data();
                const errorType = error.type || 'unknown';
                errorTypes[errorType] = (errorTypes[errorType] || 0) + 1;
            });

            if (errorTypesChartInstance) {
                errorTypesChartInstance.destroy();
            }

            errorTypesChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(errorTypes),
                    datasets: [{
                        data: Object.values(errorTypes),
                        backgroundColor: [
                            'var(--danger)',
                            'var(--warning)',
                            'var(--primary)',
                            'var(--secondary)',
                            'var(--accent)',
                            '#6f42c1',
                            '#fd7e14',
                            '#20c997'
                        ],
                        borderWidth: 2,
                        borderColor: 'var(--card-bg)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                color: 'var(--text-main)'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    },
                    cutout: '60%'
                }
            });
        } catch (error) {
            console.error('Error creating error types chart:', error);
        }
    }

    // Function to create Errors by User Chart
    async function createErrorsByUserChart() {
        const ctx = document.getElementById('errorsByUserChart');
        if (!ctx) return;

        try {
            const snapshot = await firebase.firestore().collection('errorLogs')
                .orderBy('timestamp', 'desc')
                .limit(100)
                .get();

            const userErrors = {};

            snapshot.forEach(doc => {
                const error = doc.data();
                const userName = error.userName || 'Unknown User';
                userErrors[userName] = (userErrors[userName] || 0) + 1;
            });

            // Get top 10 users with most errors
            const sortedUsers = Object.entries(userErrors)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            if (errorsByUserChartInstance) {
                errorsByUserChartInstance.destroy();
            }

            errorsByUserChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedUsers.map(([user]) => user),
                    datasets: [{
                        label: 'Errors',
                        data: sortedUsers.map(([, count]) => count),
                        backgroundColor: 'var(--warning)',
                        borderRadius: 6,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'var(--separator)' },
                            ticks: { color: 'var(--text-muted)' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: 'var(--text-muted)' }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating errors by user chart:', error);
        }
    }

    // Function to create Errors by Page Chart
    async function createErrorsByPageChart() {
        const ctx = document.getElementById('errorsByPageChart');
        if (!ctx) return;

        try {
            const snapshot = await firebase.firestore().collection('errorLogs')
                .orderBy('timestamp', 'desc')
                .limit(100)
                .get();

            const pageErrors = {};

            snapshot.forEach(doc => {
                const error = doc.data();
                const page = error.page || 'Unknown Page';
                pageErrors[page] = (pageErrors[page] || 0) + 1;
            });

            // Get top 8 pages with most errors
            const sortedPages = Object.entries(pageErrors)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);

            if (errorsByPageChartInstance) {
                errorsByPageChartInstance.destroy();
            }

            errorsByPageChartInstance = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: sortedPages.map(([page]) => page),
                    datasets: [{
                        data: sortedPages.map(([, count]) => count),
                        backgroundColor: [
                            'rgba(255, 59, 48, 0.7)',
                            'rgba(255, 149, 0, 0.7)',
                            'rgba(0, 122, 255, 0.7)',
                            'rgba(52, 199, 89, 0.7)',
                            'rgba(175, 82, 222, 0.7)',
                            'rgba(255, 45, 85, 0.7)',
                            'rgba(90, 200, 250, 0.7)',
                            'rgba(255, 204, 0, 0.7)'
                        ],
                        borderWidth: 2,
                        borderColor: 'var(--card-bg)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                color: 'var(--text-main)'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            cornerRadius: 8
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating errors by page chart:', error);
        }
    }

    //  ADDITIONAL ERROR PREVENTION
    // Prevent React-related errors (this app doesn't use React)
    if (typeof window.React === 'undefined') {
        window.React = {
            createElement: () => null,
            Component: class {},
            render: () => null
        };
    }

    // Prevent WebSocket errors from browser extensions
    const originalWebSocket = window.WebSocket;
    window.WebSocket = function(url, protocols) {
        try {
            return new originalWebSocket(url, protocols);
        } catch (error) {
            console.warn('WebSocket connection blocked (likely browser extension):', error.message);
            // Return a mock WebSocket to prevent errors
            return {
                readyState: 3, // CLOSED
                close: () => {},
                send: () => {},
                addEventListener: () => {},
                removeEventListener: () => {}
            };
        }
    };

    // Prevent content script errors
    if (typeof window.chrome !== 'undefined' && window.chrome.runtime) {
        const originalSendMessage = window.chrome.runtime.sendMessage;
        window.chrome.runtime.sendMessage = function(...args) {
            try {
                return originalSendMessage.apply(this, args);
            } catch (error) {
                console.warn('Chrome extension message blocked:', error.message);
                return Promise.resolve();
            }
        };
    }

    // Prevent inspector.js and DevTools related errors
    if (typeof window.__REACT_DEVTOOLS_GLOBAL_HOOK__ === 'undefined') {
        window.__REACT_DEVTOOLS_GLOBAL_HOOK__ = {
            isDisabled: true,
            supportsFiber: true,
            inject: () => {},
            onCommitFiberRoot: () => {},
            onCommitFiberUnmount: () => {},
        };
    }

    // Override problematic DOM methods that might cause inspector errors
    const originalQuerySelector = Document.prototype.querySelector;
    const originalQuerySelectorAll = Document.prototype.querySelectorAll;
    const originalGetElementById = Document.prototype.getElementById;

    Document.prototype.querySelector = function(selector) {
        try {
            return originalQuerySelector.call(this, selector);
        } catch (error) {
            if (error.message.includes('inspector') || error.message.includes('extension')) {
                return null;
            }
            throw error;
        }
    };

    Document.prototype.querySelectorAll = function(selector) {
        try {
            return originalQuerySelectorAll.call(this, selector);
        } catch (error) {
            if (error.message.includes('inspector') || error.message.includes('extension')) {
                return [];
            }
            throw error;
        }
    };

    Document.prototype.getElementById = function(id) {
        try {
            return originalGetElementById.call(this, id);
        } catch (error) {
            if (error.message.includes('inspector') || error.message.includes('extension')) {
                return null;
            }
            throw error;
        }
    };

    // Prevent fetch errors from extensions
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        try {
            return originalFetch.apply(this, args);
        } catch (error) {
            if (error.message.includes('extension') || error.message.includes('inspector')) {
                return Promise.reject(new Error('Network request blocked'));
            }
            throw error;
        }
    };

    //  INITIALIZE ADMIN PANEL
    // Enhanced global error handlers with specific filtering
    window.addEventListener('unhandledrejection', function(event) {
        const reason = event.reason?.message || event.reason || '';

        // Filter out extension and inspector related rejections
        const suppressPatterns = [
            'chrome-extension:',
            'moz-extension:',
            'inspector',
            'contentScript',
            'Extension context invalidated',
            'Script error',
            'NetworkError when attempting to fetch resource',
            'Failed to fetch',
            'Load failed'
        ];

        const shouldSuppress = suppressPatterns.some(pattern =>
            String(reason).toLowerCase().includes(pattern.toLowerCase())
        );

        if (shouldSuppress) {
            event.preventDefault();
            return;
        }

        console.error('Unhandled promise rejection:', event.reason);
        event.preventDefault();

        // Show user-friendly error message only for relevant errors
        if (typeof showToast === 'function' && !shouldSuppress) {
            showToast('An error occurred. Please try again.', 'danger');
        }
    });

    window.addEventListener('error', function(event) {
        const errorMessage = event.error?.message || event.message || '';
        const filename = event.filename || '';

        // Enhanced filtering for various error types
        const suppressPatterns = [
            'chrome-extension:',
            'moz-extension:',
            'inspector',
            'contentScript',
            'Extension context invalidated',
            'Minified React error',
            'Script error',
            'ResizeObserver loop limit exceeded',
            'Non-Error promise rejection captured',
            'Cannot access contents of',
            'SecurityError: Blocked a frame',
            'The operation was aborted'
        ];

        const shouldSuppress = suppressPatterns.some(pattern =>
            errorMessage.toLowerCase().includes(pattern.toLowerCase()) ||
            filename.toLowerCase().includes(pattern.toLowerCase())
        );

        if (shouldSuppress) {
            event.preventDefault();
            event.stopPropagation();
            return false;
        }

        console.error('Global error:', event.error);

        // Show user-friendly error message for null reference errors
        if (errorMessage.includes("Cannot set properties of null") ||
            errorMessage.includes("Cannot read properties of null")) {
            console.warn('Null reference error caught:', errorMessage);
            if (typeof showToast === 'function') {
                showToast('Interface loading error. Please refresh the page.', 'warning');
            }
        }
    });

    // Start initialization immediately when script loads
    console.log(' Admin Panel Script Loaded - Starting Initialization...');

    // Initialize as soon as possible
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeAdminPanel);
    } else {
        // DOM already loaded
        initializeAdminPanel();
    }

    // Also initialize when window loads (fallback)
    window.addEventListener('load', function() {
        if (!window.adminPanelInitialized) {
            console.log(' Fallback initialization triggered');
            initializeAdminPanel();
        }
    });

    // Export functions for debugging
    window.adminPanelDebug = {
        initializeAdminPanel,
        showDiagnostics,
        logAdminError,
        testFirebaseConnectivity,
        validateUIElements,
        checkDependencies,
        status: () => window.adminPanelStatus,
        errors: () => window.adminPanelErrors
    };

    console.log(' Admin Panel Debug Tools Available: window.adminPanelDebug');

    // Debug: Test if user details functions are available
    console.log(' Testing user details functions...');
    console.log('viewUserDetails function:', typeof viewUserDetails);
    console.log('exportSingleUserReport function:', typeof exportSingleUserReport);

    // Add debug functions to window for testing
    window.debugUserDetails = {
        testViewUserDetails: (userId) => {
            console.log('Testing viewUserDetails with userId:', userId);
            if (typeof viewUserDetails === 'function') {
                viewUserDetails(userId);
            } else {
                console.error('viewUserDetails function not found!');
            }
        },
        testExportUserReport: (userId) => {
            console.log('Testing exportSingleUserReport with userId:', userId);
            if (typeof exportSingleUserReport === 'function') {
                exportSingleUserReport(userId);
            } else {
                console.error('exportSingleUserReport function not found!');
            }
        },
        testModal: () => {
            console.log('Testing modal display...');
            const modalElement = document.getElementById('userDetailsModal');
            console.log('Modal element found:', !!modalElement);
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
        }
    };

    // ==========================================
    // ENHANCED REPORTING SYSTEM FUNCTIONS
    // ==========================================

    // Global variables for reports
    let currentUserReportData = [];
    let currentSubjectReportData = [];
    let reportCharts = {};

    // Initialize Reports System
    function initializeReportsSystem() {
        console.log(' Initializing Enhanced Reports System...');

        // Set up event listeners for report tabs
        setupReportEventListeners();

        // Load initial data
        loadUserReports();
        loadSubjectReports();
        loadSubjectsForFilter();

        // Set default date ranges
        setDefaultDateRanges();

        console.log(' Reports System Initialized');
    }

    // Set up event listeners for reports
    function setupReportEventListeners() {
        // User Reports Event Listeners
        document.getElementById('applyUserFilters')?.addEventListener('click', applyUserFilters);
        document.getElementById('clearUserFilters')?.addEventListener('click', clearUserFilters);
        document.getElementById('exportUserReportPDF')?.addEventListener('click', exportUserReportPDF);
        document.getElementById('exportUserReportExcel')?.addEventListener('click', exportUserReportExcel);
        document.getElementById('refreshUserReport')?.addEventListener('click', loadUserReports);

        // Subject Reports Event Listeners
        document.getElementById('applySubjectFilters')?.addEventListener('click', applySubjectFilters);
        document.getElementById('clearSubjectFilters')?.addEventListener('click', clearSubjectFilters);
        document.getElementById('exportSubjectReportPDF')?.addEventListener('click', exportSubjectReportPDF);
        document.getElementById('exportSubjectReportExcel')?.addEventListener('click', exportSubjectReportExcel);
        document.getElementById('refreshSubjectReport')?.addEventListener('click', loadSubjectReports);

        // Analytics tab event listener
        document.getElementById('analytics-reports-tab')?.addEventListener('shown.bs.tab', loadAnalyticsCharts);
    }

    // Set default date ranges (last 30 days)
    function setDefaultDateRanges() {
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

        const todayStr = today.toISOString().split('T')[0];
        const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];

        // Set user report dates
        const userDateFrom = document.getElementById('userReportDateFrom');
        const userDateTo = document.getElementById('userReportDateTo');
        if (userDateFrom) userDateFrom.value = thirtyDaysAgoStr;
        if (userDateTo) userDateTo.value = todayStr;

        // Set subject report dates
        const subjectDateFrom = document.getElementById('subjectReportDateFrom');
        const subjectDateTo = document.getElementById('subjectReportDateTo');
        if (subjectDateFrom) subjectDateFrom.value = thirtyDaysAgoStr;
        if (subjectDateTo) subjectDateTo.value = todayStr;
    }

    // Load subjects for filter dropdown
    async function loadSubjectsForFilter() {
        try {
            const subjectsSnapshot = await db.collection('subjects').get();
            const subjectSelect = document.getElementById('subjectReportSelect');

            if (subjectSelect) {
                subjectSelect.innerHTML = '<option value="">All Subjects</option>';

                subjectsSnapshot.forEach(doc => {
                    const subject = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = subject.name || 'Unnamed Subject';
                    subjectSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading subjects for filter:', error);
        }
    }

    // Load User Reports
    async function loadUserReports() {
        const spinner = document.getElementById('userReportSpinner');
        const tableBody = document.getElementById('userReportsTableBody');

        if (spinner) spinner.style.display = 'inline-block';
        if (tableBody) tableBody.innerHTML = '<tr><td colspan="9" class="text-center">Loading user reports...</td></tr>';

        try {
            // Get all users
            const usersSnapshot = await db.collection('users').get();
            const userReportData = [];

            for (const userDoc of usersSnapshot.docs) {
                const userData = userDoc.data();
                const userId = userDoc.id;

                // Calculate attendance statistics
                const attendanceStats = await calculateUserAttendanceStats(userId, userData);

                userReportData.push({
                    id: userId,
                    name: userData.name || 'Unknown',
                    email: userData.email || 'No email',
                    role: userData.role || 'student',
                    ...attendanceStats
                });
            }

            currentUserReportData = userReportData;
            displayUserReports(userReportData);
            updateUserStatistics(userReportData);

        } catch (error) {
            console.error('Error loading user reports:', error);
            showToast('Error loading user reports: ' + error.message, 'danger');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading reports</td></tr>';
            }
        } finally {
            if (spinner) spinner.style.display = 'none';
        }
    }

    // Calculate user attendance statistics
    async function calculateUserAttendanceStats(userId, userData) {
        try {
            // Get attendance records for this user
            const attendanceSnapshot = await db.collection('manualAttendance')
                .where('userId', '==', userId)
                .get();

            let totalSessions = 0;
            let presentCount = 0;
            let absentCount = 0;
            let lastActivity = null;

            attendanceSnapshot.forEach(doc => {
                const record = doc.data();
                totalSessions++;

                if (record.status === 'present') {
                    presentCount++;
                } else {
                    absentCount++;
                }

                // Track last activity
                const recordDate = new Date(record.date);
                if (!lastActivity || recordDate > lastActivity) {
                    lastActivity = recordDate;
                }
            });

            // Also check attendanceData in user document
            const attendanceData = userData.attendanceData?.subjects || {};
            Object.values(attendanceData).forEach(subject => {
                if (subject.present) presentCount += subject.present;
                if (subject.absent) absentCount += subject.absent;
                totalSessions += (subject.present || 0) + (subject.absent || 0);
            });

            const attendancePercentage = totalSessions > 0 ? Math.round((presentCount / totalSessions) * 100) : 0;

            return {
                totalSessions,
                presentCount,
                absentCount,
                attendancePercentage,
                lastActivity: lastActivity ? lastActivity.toLocaleDateString() : 'Never'
            };
        } catch (error) {
            console.error('Error calculating attendance stats for user:', userId, error);
            return {
                totalSessions: 0,
                presentCount: 0,
                absentCount: 0,
                attendancePercentage: 0,
                lastActivity: 'Error'
            };
        }
    }

    // Display user reports in table
    function displayUserReports(data) {
        const tableBody = document.getElementById('userReportsTableBody');
        const countBadge = document.getElementById('userReportCount');

        if (!tableBody) return;

        if (countBadge) countBadge.textContent = `${data.length} users`;

        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No users found</td></tr>';
            return;
        }

        tableBody.innerHTML = data.map(user => {
            const attendanceClass = user.attendancePercentage >= 80 ? 'text-success' :
                                  user.attendancePercentage >= 60 ? 'text-warning' : 'text-danger';

            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${user.name}</div>
                                <small class="text-muted">${user.id}</small>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-primary'}">${user.role}</span>
                    </td>
                    <td>${user.totalSessions}</td>
                    <td><span class="text-success">${user.presentCount}</span></td>
                    <td><span class="text-danger">${user.absentCount}</span></td>
                    <td>
                        <span class="${attendanceClass} fw-bold">${user.attendancePercentage}%</span>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar ${user.attendancePercentage >= 80 ? 'bg-success' : user.attendancePercentage >= 60 ? 'bg-warning' : 'bg-danger'}"
                                 style="width: ${user.attendancePercentage}%"></div>
                        </div>
                    </td>
                    <td>${user.lastActivity}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewUserDetails('${user.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="exportSingleUserReport('${user.id}')" title="Export Report">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Update user statistics cards
    function updateUserStatistics(data) {
        const totalUsers = data.length;
        const highAttendance = data.filter(user => user.attendancePercentage >= 80).length;
        const mediumAttendance = data.filter(user => user.attendancePercentage >= 60 && user.attendancePercentage < 80).length;
        const lowAttendance = data.filter(user => user.attendancePercentage < 60).length;

        document.getElementById('totalUsersCount').textContent = totalUsers;
        document.getElementById('highAttendanceCount').textContent = highAttendance;
        document.getElementById('mediumAttendanceCount').textContent = mediumAttendance;
        document.getElementById('lowAttendanceCount').textContent = lowAttendance;
    }

    // Apply user filters
    function applyUserFilters() {
        const dateFrom = document.getElementById('userReportDateFrom').value;
        const dateTo = document.getElementById('userReportDateTo').value;
        const minAttendance = parseInt(document.getElementById('userReportMinAttendance').value) || 0;
        const role = document.getElementById('userReportRole').value;

        let filteredData = [...currentUserReportData];

        // Filter by attendance percentage
        if (minAttendance > 0) {
            filteredData = filteredData.filter(user => user.attendancePercentage >= minAttendance);
        }

        // Filter by role
        if (role) {
            filteredData = filteredData.filter(user => user.role === role);
        }

        // TODO: Implement date filtering when we have proper date tracking

        displayUserReports(filteredData);
        updateUserStatistics(filteredData);
        showToast(`Applied filters. Showing ${filteredData.length} users.`, 'info');
    }

    // Clear user filters
    function clearUserFilters() {
        document.getElementById('userReportDateFrom').value = '';
        document.getElementById('userReportDateTo').value = '';
        document.getElementById('userReportMinAttendance').value = '';
        document.getElementById('userReportRole').value = '';

        setDefaultDateRanges();
        displayUserReports(currentUserReportData);
        updateUserStatistics(currentUserReportData);
        showToast('Filters cleared.', 'info');
    }

    // Load Subject Reports
    async function loadSubjectReports() {
        const spinner = document.getElementById('subjectReportSpinner');
        const tableBody = document.getElementById('subjectReportsTableBody');

        if (spinner) spinner.style.display = 'inline-block';
        if (tableBody) tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Loading subject reports...</td></tr>';

        try {
            // Get all subjects
            const subjectsSnapshot = await db.collection('subjects').get();
            const subjectReportData = [];

            for (const subjectDoc of subjectsSnapshot.docs) {
                const subjectData = subjectDoc.data();
                const subjectId = subjectDoc.id;

                // Calculate subject attendance statistics
                const attendanceStats = await calculateSubjectAttendanceStats(subjectId, subjectData.name);

                subjectReportData.push({
                    id: subjectId,
                    name: subjectData.name || 'Unnamed Subject',
                    ...attendanceStats
                });
            }

            currentSubjectReportData = subjectReportData;
            displaySubjectReports(subjectReportData);
            updateSubjectStatistics(subjectReportData);

        } catch (error) {
            console.error('Error loading subject reports:', error);
            showToast('Error loading subject reports: ' + error.message, 'danger');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading reports</td></tr>';
            }
        } finally {
            if (spinner) spinner.style.display = 'none';
        }
    }

    // Calculate subject attendance statistics
    async function calculateSubjectAttendanceStats(subjectId, subjectName) {
        try {
            // Get attendance records for this subject
            const attendanceSnapshot = await db.collection('manualAttendance')
                .where('subjectId', '==', subjectId)
                .get();

            let totalSessions = 0;
            let presentCount = 0;
            let absentCount = 0;
            let lastSession = null;
            const uniqueStudents = new Set();

            attendanceSnapshot.forEach(doc => {
                const record = doc.data();
                totalSessions++;
                uniqueStudents.add(record.userId);

                if (record.status === 'present') {
                    presentCount++;
                } else {
                    absentCount++;
                }

                // Track last session
                const recordDate = new Date(record.date);
                if (!lastSession || recordDate > lastSession) {
                    lastSession = recordDate;
                }
            });

            // Also check user documents for this subject
            const usersSnapshot = await db.collection('users').get();
            usersSnapshot.forEach(userDoc => {
                const userData = userDoc.data();
                const attendanceData = userData.attendanceData?.subjects || {};

                if (attendanceData[subjectName]) {
                    const subjectData = attendanceData[subjectName];
                    presentCount += subjectData.present || 0;
                    absentCount += subjectData.absent || 0;
                    totalSessions += (subjectData.present || 0) + (subjectData.absent || 0);
                    uniqueStudents.add(userDoc.id);
                }
            });

            const attendanceRate = totalSessions > 0 ? Math.round((presentCount / totalSessions) * 100) : 0;

            return {
                totalStudents: uniqueStudents.size,
                totalSessions,
                presentCount,
                absentCount,
                attendanceRate,
                lastSession: lastSession ? lastSession.toLocaleDateString() : 'Never'
            };
        } catch (error) {
            console.error('Error calculating attendance stats for subject:', subjectId, error);
            return {
                totalStudents: 0,
                totalSessions: 0,
                presentCount: 0,
                absentCount: 0,
                attendanceRate: 0,
                lastSession: 'Error'
            };
        }
    }

    // Display subject reports in table
    function displaySubjectReports(data) {
        const tableBody = document.getElementById('subjectReportsTableBody');
        const countBadge = document.getElementById('subjectReportCount');

        if (!tableBody) return;

        if (countBadge) countBadge.textContent = `${data.length} subjects`;

        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No subjects found</td></tr>';
            return;
        }

        tableBody.innerHTML = data.map(subject => {
            const attendanceClass = subject.attendanceRate >= 80 ? 'text-success' :
                                  subject.attendanceRate >= 60 ? 'text-warning' : 'text-danger';

            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-info rounded-circle d-flex align-items-center justify-content-center me-2">
                                <i class="fas fa-book text-white"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${subject.name}</div>
                                <small class="text-muted">${subject.id}</small>
                            </div>
                        </div>
                    </td>
                    <td>${subject.totalStudents}</td>
                    <td>${subject.totalSessions}</td>
                    <td><span class="text-success">${subject.presentCount}</span></td>
                    <td><span class="text-danger">${subject.absentCount}</span></td>
                    <td>
                        <span class="${attendanceClass} fw-bold">${subject.attendanceRate}%</span>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar ${subject.attendanceRate >= 80 ? 'bg-success' : subject.attendanceRate >= 60 ? 'bg-warning' : 'bg-danger'}"
                                 style="width: ${subject.attendanceRate}%"></div>
                        </div>
                    </td>
                    <td>${subject.lastSession}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewSubjectDetails('${subject.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="exportSingleSubjectReport('${subject.id}')" title="Export Report">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Update subject statistics cards
    function updateSubjectStatistics(data) {
        const totalSubjects = data.length;
        const totalSessions = data.reduce((sum, subject) => sum + subject.totalSessions, 0);
        const totalPresent = data.reduce((sum, subject) => sum + subject.presentCount, 0);
        const totalAbsent = data.reduce((sum, subject) => sum + subject.absentCount, 0);
        const overallRate = (totalPresent + totalAbsent) > 0 ? Math.round((totalPresent / (totalPresent + totalAbsent)) * 100) : 0;

        document.getElementById('totalSubjectsCount').textContent = totalSubjects;
        document.getElementById('totalSessionsCount').textContent = totalSessions;
        document.getElementById('overallAttendanceRate').textContent = `${overallRate}%`;
    }

    // Apply subject filters
    function applySubjectFilters() {
        const selectedSubject = document.getElementById('subjectReportSelect').value;
        const dateFrom = document.getElementById('subjectReportDateFrom').value;
        const dateTo = document.getElementById('subjectReportDateTo').value;

        let filteredData = [...currentSubjectReportData];

        // Filter by selected subject
        if (selectedSubject) {
            filteredData = filteredData.filter(subject => subject.id === selectedSubject);
        }

        // TODO: Implement date filtering when we have proper date tracking

        displaySubjectReports(filteredData);
        updateSubjectStatistics(filteredData);
        showToast(`Applied filters. Showing ${filteredData.length} subjects.`, 'info');
    }

    // Clear subject filters
    function clearSubjectFilters() {
        document.getElementById('subjectReportSelect').value = '';
        document.getElementById('subjectReportDateFrom').value = '';
        document.getElementById('subjectReportDateTo').value = '';

        setDefaultDateRanges();
        displaySubjectReports(currentSubjectReportData);
        updateSubjectStatistics(currentSubjectReportData);
        showToast('Filters cleared.', 'info');
    }

    // Export User Report to PDF
    async function exportUserReportPDF() {
        const exportBtn = document.getElementById('exportUserReportPDF');
        if (exportBtn) {
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
        }

        try {
            if (!window.jspdf) {
                throw new Error('jsPDF library not loaded');
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Get current filtered data
            const tableBody = document.getElementById('userReportsTableBody');
            const displayedRows = tableBody.querySelectorAll('tr');
            const userData = [];

            // Extract data from displayed table rows
            displayedRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) {
                    userData.push([
                        cells[0].querySelector('.fw-bold')?.textContent || '',
                        cells[1].textContent,
                        cells[2].querySelector('.badge')?.textContent || '',
                        cells[3].textContent,
                        cells[4].textContent,
                        cells[5].textContent,
                        cells[6].querySelector('span')?.textContent || '',
                        cells[7].textContent
                    ]);
                }
            });

            // Set up the document
            doc.setFontSize(20);
            doc.text('User Attendance Report', 20, 20);

            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);
            doc.text(`Total Users: ${userData.length}`, 20, 40);

            // Add summary statistics
            const stats = calculateReportStatistics(currentUserReportData);
            doc.text(`High Attendance (80%): ${stats.highAttendance}`, 20, 50);
            doc.text(`Medium Attendance (60-79%): ${stats.mediumAttendance}`, 20, 60);
            doc.text(`Low Attendance (<60%): ${stats.lowAttendance}`, 20, 70);

            // Add table
            doc.autoTable({
                startY: 80,
                head: [['Name', 'Email', 'Role', 'Sessions', 'Present', 'Absent', 'Attendance %', 'Last Activity']],
                body: userData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [52, 58, 64] },
                alternateRowStyles: { fillColor: [248, 249, 250] }
            });

            // Save the PDF
            const fileName = `user_attendance_report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);

            showToast('User report PDF exported successfully!', 'success');

        } catch (error) {
            console.error('Error exporting user report PDF:', error);
            showToast('Error exporting PDF: ' + error.message, 'danger');
        } finally {
            if (exportBtn) {
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i>Export PDF';
            }
        }
    }

    // Export Subject Report to PDF
    async function exportSubjectReportPDF() {
        const exportBtn = document.getElementById('exportSubjectReportPDF');
        if (exportBtn) {
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
        }

        try {
            if (!window.jspdf) {
                throw new Error('jsPDF library not loaded');
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Get current filtered data
            const tableBody = document.getElementById('subjectReportsTableBody');
            const displayedRows = tableBody.querySelectorAll('tr');
            const subjectData = [];

            // Extract data from displayed table rows
            displayedRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                    subjectData.push([
                        cells[0].querySelector('.fw-bold')?.textContent || '',
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent,
                        cells[4].textContent,
                        cells[5].querySelector('span')?.textContent || '',
                        cells[6].textContent
                    ]);
                }
            });

            // Set up the document
            doc.setFontSize(20);
            doc.text('Subject Attendance Report', 20, 20);

            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);
            doc.text(`Total Subjects: ${subjectData.length}`, 20, 40);

            // Add summary statistics
            const totalSessions = currentSubjectReportData.reduce((sum, s) => sum + s.totalSessions, 0);
            const overallRate = calculateOverallAttendanceRate(currentSubjectReportData);
            doc.text(`Total Sessions: ${totalSessions}`, 20, 50);
            doc.text(`Overall Attendance Rate: ${overallRate}%`, 20, 60);

            // Add table
            doc.autoTable({
                startY: 70,
                head: [['Subject', 'Students', 'Sessions', 'Present', 'Absent', 'Rate %', 'Last Session']],
                body: subjectData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [52, 58, 64] },
                alternateRowStyles: { fillColor: [248, 249, 250] }
            });

            // Save the PDF
            const fileName = `subject_attendance_report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);

            showToast('Subject report PDF exported successfully!', 'success');

        } catch (error) {
            console.error('Error exporting subject report PDF:', error);
            showToast('Error exporting PDF: ' + error.message, 'danger');
        } finally {
            if (exportBtn) {
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<i class="fas fa-file-pdf me-1"></i>Export PDF';
            }
        }
    }

    // Export User Report to Excel (CSV)
    function exportUserReportExcel() {
        try {
            const tableBody = document.getElementById('userReportsTableBody');
            const displayedRows = tableBody.querySelectorAll('tr');

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "User Attendance Report\n";
            csvContent += `Generated on: ${new Date().toLocaleString()}\n\n`;
            csvContent += "Name,Email,Role,Total Sessions,Present,Absent,Attendance %,Last Activity\n";

            displayedRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) {
                    const rowData = [
                        cells[0].querySelector('.fw-bold')?.textContent || '',
                        cells[1].textContent,
                        cells[2].querySelector('.badge')?.textContent || '',
                        cells[3].textContent,
                        cells[4].textContent,
                        cells[5].textContent,
                        cells[6].querySelector('span')?.textContent || '',
                        cells[7].textContent
                    ];
                    csvContent += rowData.map(field => `"${field}"`).join(',') + '\n';
                }
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `user_attendance_report_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('User report CSV exported successfully!', 'success');
        } catch (error) {
            console.error('Error exporting user report CSV:', error);
            showToast('Error exporting CSV: ' + error.message, 'danger');
        }
    }

    // Export Subject Report to Excel (CSV)
    function exportSubjectReportExcel() {
        try {
            const tableBody = document.getElementById('subjectReportsTableBody');
            const displayedRows = tableBody.querySelectorAll('tr');

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Subject Attendance Report\n";
            csvContent += `Generated on: ${new Date().toLocaleString()}\n\n`;
            csvContent += "Subject,Total Students,Total Sessions,Present Count,Absent Count,Attendance Rate %,Last Session\n";

            displayedRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                    const rowData = [
                        cells[0].querySelector('.fw-bold')?.textContent || '',
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent,
                        cells[4].textContent,
                        cells[5].querySelector('span')?.textContent || '',
                        cells[6].textContent
                    ];
                    csvContent += rowData.map(field => `"${field}"`).join(',') + '\n';
                }
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `subject_attendance_report_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Subject report CSV exported successfully!', 'success');
        } catch (error) {
            console.error('Error exporting subject report CSV:', error);
            showToast('Error exporting CSV: ' + error.message, 'danger');
        }
    }

    // Utility function to calculate report statistics
    function calculateReportStatistics(userData) {
        return {
            highAttendance: userData.filter(user => user.attendancePercentage >= 80).length,
            mediumAttendance: userData.filter(user => user.attendancePercentage >= 60 && user.attendancePercentage < 80).length,
            lowAttendance: userData.filter(user => user.attendancePercentage < 60).length
        };
    }

    // Utility function to calculate overall attendance rate
    function calculateOverallAttendanceRate(subjectData) {
        const totalPresent = subjectData.reduce((sum, subject) => sum + subject.presentCount, 0);
        const totalAbsent = subjectData.reduce((sum, subject) => sum + subject.absentCount, 0);
        return (totalPresent + totalAbsent) > 0 ? Math.round((totalPresent / (totalPresent + totalAbsent)) * 100) : 0;
    }

    // View user details - Complete implementation
    async function viewUserDetails(userId) {
        console.log(' viewUserDetails called with userId:', userId);
        try {
            // Check if modal element exists
            const modalElement = document.getElementById('userDetailsModal');
            if (!modalElement) {
                throw new Error('User details modal element not found');
            }
            console.log(' Modal element found');

            // Check if Bootstrap is available
            if (typeof bootstrap === 'undefined') {
                throw new Error('Bootstrap library not loaded');
            }
            console.log(' Bootstrap library available');

            // Show the modal
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            console.log(' Modal shown');

            // Show loading spinner
            const spinner = document.getElementById('userDetailsSpinner');
            const content = document.getElementById('userDetailsContent');
            if (spinner) spinner.style.display = 'block';
            if (content) content.style.display = 'none';
            console.log(' Loading spinner shown');

            // Check if database is available
            if (typeof db === 'undefined') {
                throw new Error('Database connection not available');
            }
            console.log(' Database connection available');

            // Fetch user data
            console.log(' Fetching user data for:', userId);
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) {
                throw new Error('User not found');
            }
            console.log(' User data fetched successfully');

            const userData = userDoc.data();

            // Populate basic user information
            document.getElementById('modalUserName').textContent = userData.name || 'Unknown';
            document.getElementById('modalUserEmail').textContent = userData.email || 'No email';
            document.getElementById('modalUserId').textContent = userId;
            document.getElementById('modalUserRole').textContent = userData.role || 'student';
            document.getElementById('modalUserRole').className = `badge ${userData.role === 'admin' ? 'bg-danger' : 'bg-primary'}`;

            // Format dates
            const createdDate = userData.createdAt ? userData.createdAt.toDate().toLocaleDateString() : 'Unknown';
            const lastLogin = userData.lastLogin ? userData.lastLogin.toDate().toLocaleDateString() : 'Never';
            document.getElementById('modalUserCreated').textContent = createdDate;
            document.getElementById('modalUserLastLogin').textContent = lastLogin;

            // Calculate attendance statistics
            const attendanceStats = await calculateUserAttendanceStats(userId, userData);

            // Update statistics cards
            document.getElementById('modalTotalSessions').textContent = attendanceStats.totalSessions;
            document.getElementById('modalPresentCount').textContent = attendanceStats.presentCount;
            document.getElementById('modalAbsentCount').textContent = attendanceStats.absentCount;
            document.getElementById('modalAttendanceRate').textContent = `${attendanceStats.attendancePercentage}%`;

            // Load subject-wise attendance
            await loadUserSubjectAttendance(userId, userData);

            // Load recent attendance history
            await loadUserAttendanceHistory(userId);

            // Create attendance chart
            createUserAttendanceChart(attendanceStats);

            // Hide loading spinner and show content
            document.getElementById('userDetailsSpinner').style.display = 'none';
            document.getElementById('userDetailsContent').style.display = 'block';

            // Set up export button
            document.getElementById('exportUserDetailsReport').onclick = () => exportSingleUserReport(userId);

        } catch (error) {
            console.error('Error loading user details:', error);
            showToast('Error loading user details: ' + error.message, 'danger');

            // Hide loading spinner and show error
            document.getElementById('userDetailsSpinner').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <p class="text-danger">Error loading user details</p>
                    <p class="text-muted">${error.message}</p>
                </div>
            `;
        }
    }

    // Load user subject-wise attendance
    async function loadUserSubjectAttendance(userId, userData) {
        try {
            const subjectsTableBody = document.getElementById('modalUserSubjects');
            subjectsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading subjects...</td></tr>';

            // Get attendance data from user document
            const attendanceData = userData.attendanceData?.subjects || {};

            // Get manual attendance records
            const manualAttendanceSnapshot = await db.collection('manualAttendance')
                .where('userId', '==', userId)
                .get();

            // Aggregate attendance by subject
            const subjectStats = {};

            // Process user document attendance data
            Object.entries(attendanceData).forEach(([subjectName, data]) => {
                if (!subjectStats[subjectName]) {
                    subjectStats[subjectName] = { present: 0, absent: 0 };
                }
                subjectStats[subjectName].present += data.present || 0;
                subjectStats[subjectName].absent += data.absent || 0;
            });

            // Process manual attendance records
            manualAttendanceSnapshot.forEach(doc => {
                const record = doc.data();
                const subjectName = record.subjectName;

                if (!subjectStats[subjectName]) {
                    subjectStats[subjectName] = { present: 0, absent: 0 };
                }

                if (record.status === 'present') {
                    subjectStats[subjectName].present++;
                } else {
                    subjectStats[subjectName].absent++;
                }
            });

            // Populate the table
            if (Object.keys(subjectStats).length === 0) {
                subjectsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No attendance data found</td></tr>';
                return;
            }

            subjectsTableBody.innerHTML = Object.entries(subjectStats).map(([subjectName, stats]) => {
                const total = stats.present + stats.absent;
                const percentage = total > 0 ? Math.round((stats.present / total) * 100) : 0;
                const progressClass = percentage >= 80 ? 'bg-success' : percentage >= 60 ? 'bg-warning' : 'bg-danger';

                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-book text-info me-2"></i>
                                ${subjectName}
                            </div>
                        </td>
                        <td><span class="text-success fw-bold">${stats.present}</span></td>
                        <td><span class="text-danger fw-bold">${stats.absent}</span></td>
                        <td><span class="fw-bold">${total}</span></td>
                        <td>
                            <span class="fw-bold ${percentage >= 80 ? 'text-success' : percentage >= 60 ? 'text-warning' : 'text-danger'}">
                                ${percentage}%
                            </span>
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${progressClass}" style="width: ${percentage}%">
                                    ${percentage}%
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading user subject attendance:', error);
            document.getElementById('modalUserSubjects').innerHTML =
                '<tr><td colspan="6" class="text-center text-danger">Error loading subject data</td></tr>';
        }
    }

    // Load user attendance history
    async function loadUserAttendanceHistory(userId) {
        try {
            const historyTableBody = document.getElementById('modalUserHistory');
            historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Loading history...</td></tr>';

            // Get recent manual attendance records (last 20)
            const historySnapshot = await db.collection('manualAttendance')
                .where('userId', '==', userId)
                .orderBy('date', 'desc')
                .limit(20)
                .get();

            if (historySnapshot.empty) {
                historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No attendance history found</td></tr>';
                return;
            }

            historyTableBody.innerHTML = historySnapshot.docs.map(doc => {
                const record = doc.data();
                const statusClass = record.status === 'present' ? 'text-success' : 'text-danger';
                const statusIcon = record.status === 'present' ? 'fa-check-circle' : 'fa-times-circle';

                return `
                    <tr>
                        <td>${record.date || 'Unknown'}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-book text-info me-2"></i>
                                ${record.subjectName || 'Unknown'}
                            </div>
                        </td>
                        <td>
                            <span class="${statusClass}">
                                <i class="fas ${statusIcon} me-1"></i>
                                ${record.status || 'Unknown'}
                            </span>
                        </td>
                        <td>${record.addedByName || 'Unknown'}</td>
                        <td>${record.notes || '-'}</td>
                    </tr>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading user attendance history:', error);
            document.getElementById('modalUserHistory').innerHTML =
                '<tr><td colspan="5" class="text-center text-danger">Error loading history</td></tr>';
        }
    }

    // Create user attendance chart
    function createUserAttendanceChart(attendanceStats) {
        const ctx = document.getElementById('userAttendanceChart');
        if (!ctx) return;

        try {
            // Destroy existing chart if it exists
            if (window.userModalChart) {
                window.userModalChart.destroy();
            }

            window.userModalChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [attendanceStats.presentCount, attendanceStats.absentCount],
                        backgroundColor: ['var(--success-solid)', 'var(--error-solid)'],
                        borderWidth: 2,
                        borderColor: 'var(--card-bg)',
                        hoverBackgroundColor: ['var(--success-light)', 'var(--error-light)'],
                        hoverBorderColor: 'var(--card-bg)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating user attendance chart:', error);
        }
    }

    // View subject details (placeholder for future implementation)
    function viewSubjectDetails(subjectId) {
        showToast(`Viewing details for subject: ${subjectId}`, 'info');
        // TODO: Implement subject details modal or navigation
    }

    // Export single user report - Complete implementation
    async function exportSingleUserReport(userId) {
        console.log(' exportSingleUserReport called with userId:', userId);
        try {
            showToast('Generating user report...', 'info');
            console.log(' Toast shown, starting report generation');

            // Get user data
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) {
                throw new Error('User not found');
            }

            const userData = userDoc.data();
            const attendanceStats = await calculateUserAttendanceStats(userId, userData);

            // Get subject-wise attendance data
            const attendanceData = userData.attendanceData?.subjects || {};
            const manualAttendanceSnapshot = await db.collection('manualAttendance')
                .where('userId', '==', userId)
                .get();

            // Aggregate subject data
            const subjectStats = {};

            // Process user document attendance data
            Object.entries(attendanceData).forEach(([subjectName, data]) => {
                if (!subjectStats[subjectName]) {
                    subjectStats[subjectName] = { present: 0, absent: 0 };
                }
                subjectStats[subjectName].present += data.present || 0;
                subjectStats[subjectName].absent += data.absent || 0;
            });

            // Process manual attendance records
            const attendanceHistory = [];
            manualAttendanceSnapshot.forEach(doc => {
                const record = doc.data();
                const subjectName = record.subjectName;

                if (!subjectStats[subjectName]) {
                    subjectStats[subjectName] = { present: 0, absent: 0 };
                }

                if (record.status === 'present') {
                    subjectStats[subjectName].present++;
                } else {
                    subjectStats[subjectName].absent++;
                }

                // Add to history
                attendanceHistory.push({
                    date: record.date || 'Unknown',
                    subject: record.subjectName || 'Unknown',
                    status: record.status || 'Unknown',
                    addedBy: record.addedByName || 'Unknown',
                    notes: record.notes || ''
                });
            });

            // Sort history by date (newest first)
            attendanceHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Generate PDF
            if (!window.jspdf) {
                throw new Error('jsPDF library not loaded');
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(20);
            doc.text('Individual User Attendance Report', 20, 20);

            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);

            // User Information
            doc.setFontSize(16);
            doc.text('User Information', 20, 50);

            doc.setFontSize(12);
            doc.text(`Name: ${userData.name || 'Unknown'}`, 20, 60);
            doc.text(`Email: ${userData.email || 'No email'}`, 20, 70);
            doc.text(`Role: ${userData.role || 'student'}`, 20, 80);
            doc.text(`User ID: ${userId}`, 20, 90);

            // Attendance Summary
            doc.setFontSize(16);
            doc.text('Attendance Summary', 20, 110);

            doc.setFontSize(12);
            doc.text(`Total Sessions: ${attendanceStats.totalSessions}`, 20, 120);
            doc.text(`Present: ${attendanceStats.presentCount}`, 20, 130);
            doc.text(`Absent: ${attendanceStats.absentCount}`, 20, 140);
            doc.text(`Attendance Rate: ${attendanceStats.attendancePercentage}%`, 20, 150);

            // Subject-wise Attendance Table
            let yPosition = 170;
            doc.setFontSize(16);
            doc.text('Subject-wise Attendance', 20, yPosition);
            yPosition += 10;

            const subjectTableData = Object.entries(subjectStats).map(([subject, stats]) => {
                const total = stats.present + stats.absent;
                const percentage = total > 0 ? Math.round((stats.present / total) * 100) : 0;
                return [subject, stats.present.toString(), stats.absent.toString(), total.toString(), `${percentage}%`];
            });

            doc.autoTable({
                startY: yPosition,
                head: [['Subject', 'Present', 'Absent', 'Total', 'Attendance %']],
                body: subjectTableData,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [52, 58, 64] },
                alternateRowStyles: { fillColor: [248, 249, 250] }
            });

            // Recent Attendance History
            yPosition = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(16);
            doc.text('Recent Attendance History', 20, yPosition);
            yPosition += 10;

            const historyTableData = attendanceHistory.slice(0, 15).map(record => [
                record.date,
                record.subject,
                record.status,
                record.addedBy,
                record.notes.substring(0, 30) + (record.notes.length > 30 ? '...' : '')
            ]);

            doc.autoTable({
                startY: yPosition,
                head: [['Date', 'Subject', 'Status', 'Added By', 'Notes']],
                body: historyTableData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [52, 58, 64] },
                alternateRowStyles: { fillColor: [248, 249, 250] }
            });

            // Save the PDF
            const fileName = `user_report_${userData.name || 'user'}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);

            showToast('User report exported successfully!', 'success');

        } catch (error) {
            console.error('Error exporting user report:', error);
            showToast('Error exporting user report: ' + error.message, 'danger');
        }
    }

    // Export single subject report (placeholder for future implementation)
    function exportSingleSubjectReport(subjectId) {
        showToast(`Exporting report for subject: ${subjectId}`, 'info');
        // TODO: Implement single subject report export
    }

    // Load Analytics Charts
    function loadAnalyticsCharts() {
        console.log(' Loading analytics charts...');

        // Load all charts
        loadAttendanceDistributionChart();
        loadAttendanceTrendsChart();
        loadSubjectPerformanceChart();
        loadDailyAttendanceChart();
    }

    // Load Attendance Distribution Chart
    function loadAttendanceDistributionChart() {
        const ctx = document.getElementById('attendanceDistributionChart');
        if (!ctx) return;

        try {
            // Destroy existing chart if it exists
            if (reportCharts.distributionChart) {
                reportCharts.distributionChart.destroy();
            }

            const stats = calculateReportStatistics(currentUserReportData);

            reportCharts.distributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['High (80%)', 'Medium (60-79%)', 'Low (<60%)'],
                    datasets: [{
                        data: [stats.highAttendance, stats.mediumAttendance, stats.lowAttendance],
                        backgroundColor: ['var(--success-solid)', 'var(--warning-solid)', 'var(--error-solid)'],
                        borderWidth: 2,
                        borderColor: 'var(--card-bg)',
                        hoverBackgroundColor: ['var(--success-light)', 'var(--warning-light)', 'var(--error-light)'],
                        hoverBorderColor: 'var(--card-bg)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating attendance distribution chart:', error);
        }
    }

    // Load Attendance Trends Chart (placeholder)
    function loadAttendanceTrendsChart() {
        const ctx = document.getElementById('attendanceTrendsChart');
        if (!ctx) return;

        try {
            // Destroy existing chart if it exists
            if (reportCharts.trendsChart) {
                reportCharts.trendsChart.destroy();
            }

            // Sample data for demonstration
            const labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            const attendanceData = [85, 78, 82, 88];

            reportCharts.trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Attendance %',
                        data: attendanceData,
                        borderColor: 'var(--info-solid)',
                        backgroundColor: 'var(--info-alpha-10)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointBackgroundColor: 'var(--info-solid)',
                        pointBorderColor: 'var(--card-bg)',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating attendance trends chart:', error);
        }
    }

    // Load Subject Performance Chart
    function loadSubjectPerformanceChart() {
        const ctx = document.getElementById('subjectPerformanceChart');
        if (!ctx) return;

        try {
            // Destroy existing chart if it exists
            if (reportCharts.performanceChart) {
                reportCharts.performanceChart.destroy();
            }

            const subjectNames = currentSubjectReportData.map(s => s.name);
            const attendanceRates = currentSubjectReportData.map(s => s.attendanceRate);

            reportCharts.performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: subjectNames,
                    datasets: [{
                        label: 'Attendance Rate %',
                        data: attendanceRates,
                        backgroundColor: attendanceRates.map(rate =>
                            rate >= 80 ? '#28a745' : rate >= 60 ? '#ffc107' : '#dc3545'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating subject performance chart:', error);
        }
    }

    // Load Daily Attendance Chart (placeholder)
    function loadDailyAttendanceChart() {
        const ctx = document.getElementById('dailyAttendanceChart');
        if (!ctx) return;

        try {
            // Destroy existing chart if it exists
            if (reportCharts.dailyChart) {
                reportCharts.dailyChart.destroy();
            }

            // Sample data for demonstration
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const attendanceData = [88, 85, 90, 82, 78];

            reportCharts.dailyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Average Attendance %',
                        data: attendanceData,
                        backgroundColor: 'var(--info-solid)',
                        borderColor: 'var(--info-light)',
                        borderWidth: 1,
                        hoverBackgroundColor: 'var(--info-light)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating daily attendance chart:', error);
        }
    }

    // Initialize reports when the reports tab is first shown
    document.getElementById('reports-tab')?.addEventListener('shown.bs.tab', function() {
        if (!window.reportsInitialized) {
            initializeReportsSystem();
            window.reportsInitialized = true;
        }
    });

    // Add reports initialization to the main admin panel initialization
    const originalInitializeAdminPanel = initializeAdminPanel;
    initializeAdminPanel = function() {
        originalInitializeAdminPanel();

        // Initialize reports system after a short delay to ensure DOM is ready
        setTimeout(() => {
            if (document.getElementById('reports-content')) {
                console.log(' Setting up reports system integration...');
                // Don't auto-initialize reports, wait for tab to be shown
                window.reportsInitialized = false;
            }
        }, 1000);
    };

    // Make functions globally accessible for onclick handlers
    window.viewUserDetails = viewUserDetails;
    window.exportSingleUserReport = exportSingleUserReport;
    window.viewSubjectDetails = viewSubjectDetails;
    window.exportSingleSubjectReport = exportSingleSubjectReport;




    // Resend Email System Functions
    let emailStats = {
        success: 0,
        failed: 0
    };

    function initializeResendEmailSystem() {
        updateResendServiceStatus();
        loadEmailStatistics();
        setupResendEventListeners();
    }

    // Get the correct server URL
    function getServerUrl() {
        // If we're on localhost:3001, use relative URLs
        if (window.location.hostname === 'localhost' && window.location.port === '3001') {
            return '';
        }
        // Otherwise, use the full URL to the email server
        return 'http://localhost:3001';
    }

    async function updateResendServiceStatus() {
        const statusElement = document.getElementById('resendServiceStatus');
        if (!statusElement) return;

        statusElement.className = 'badge bg-warning';
        statusElement.textContent = 'Checking...';

        try {
            const serverUrl = getServerUrl();
            const response = await fetch(`${serverUrl}/health`);
            if (response.ok) {
                const data = await response.json();
                if (data.status === 'OK') {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = 'Online';
                } else {
                    statusElement.className = 'badge bg-warning';
                    statusElement.textContent = 'Partial';
                }
            } else {
                throw new Error('Service unavailable');
            }
        } catch (error) {
            statusElement.className = 'badge bg-danger';
            statusElement.textContent = 'Offline';
            console.error('Resend service check failed:', error);
        }
    }

    function loadEmailStatistics() {
        const successElement = document.getElementById('emailsSuccessCount');
        const failedElement = document.getElementById('emailsFailedCount');
        const testCountElement = document.getElementById('testEmailsCount');

        if (successElement) successElement.textContent = emailStats.success;
        if (failedElement) failedElement.textContent = emailStats.failed;
        if (testCountElement) testCountElement.textContent = emailStats.success + emailStats.failed;
    }

    function setupResendEventListeners() {
        // Test email buttons
        const testResendEmailBtn = document.getElementById('testResendEmailBtn');
        const sendTestEmailBtn = document.getElementById('sendTestEmailBtn');
        const sendWelcomeTestBtn = document.getElementById('sendWelcomeTestBtn');
        const checkStatusBtn = document.getElementById('checkResendStatusBtn');
        const viewTemplatesBtn = document.getElementById('viewEmailTemplatesBtn');

        if (testResendEmailBtn) {
            testResendEmailBtn.addEventListener('click', () => sendTestEmail('hello'));
        }

        if (sendTestEmailBtn) {
            sendTestEmailBtn.addEventListener('click', sendCustomTestEmail);
        }

        if (sendWelcomeTestBtn) {
            sendWelcomeTestBtn.addEventListener('click', () => sendTestEmail('welcome'));
        }

        if (checkStatusBtn) {
            checkStatusBtn.addEventListener('click', updateResendServiceStatus);
        }

        if (viewTemplatesBtn) {
            viewTemplatesBtn.addEventListener('click', loadEmailTemplates);
        }
    }

    async function sendTestEmail(emailType = 'hello') {
        const emailInput = document.getElementById('testEmailAddress');
        const nameInput = document.getElementById('testUserName');

        if (!emailInput) {
            showToast('Email input not found', 'danger');
            return;
        }

        const email = emailInput.value.trim();
        const name = nameInput ? nameInput.value.trim() || 'Test User' : 'Test User';

        if (!email) {
            showToast('Please enter an email address', 'danger');
            return;
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showToast('Please enter a valid email address', 'danger');
            return;
        }

        try {
            showTestResult('Sending test email...', 'info');

            const serverUrl = getServerUrl();
            const response = await fetch(`${serverUrl}/test-email`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    testEmail: email,
                    testType: emailType
                })
            });

            let result;
            try {
                result = await response.json();
            } catch (jsonError) {
                throw new Error(`Server returned invalid JSON. Status: ${response.status}`);
            }

            if (response.ok && result.success) {
                emailStats.success++;
                showToast(`Test ${emailType} email sent successfully!`, 'success');
                showTestResult(` Test email sent successfully to ${email}`, 'success');
            } else {
                emailStats.failed++;
                const errorMsg = result.error || `HTTP ${response.status}`;
                showToast(`Failed to send test email: ${errorMsg}`, 'danger');
                showTestResult(` Failed to send test email: ${errorMsg}`, 'error');
            }

            loadEmailStatistics();
        } catch (error) {
            emailStats.failed++;
            console.error('Test email error:', error);
            showToast('Error sending test email', 'danger');
            showTestResult(` Error sending test email: ${error.message}`, 'error');
            loadEmailStatistics();
        }
    }

    async function sendCustomTestEmail() {
        const emailInput = document.getElementById('testEmailAddress');
        const nameInput = document.getElementById('testUserName');
        const typeSelect = document.getElementById('testEmailType');

        if (!emailInput || !typeSelect) {
            showToast('Required inputs not found', 'danger');
            return;
        }

        const email = emailInput.value.trim();
        const name = nameInput ? nameInput.value.trim() || 'Test User' : 'Test User';
        const emailType = typeSelect.value;

        if (!email) {
            showToast('Please enter an email address', 'danger');
            return;
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showToast('Please enter a valid email address', 'danger');
            return;
        }

        try {
            showTestResult(`Sending ${emailType} email...`, 'info');

            const serverUrl = getServerUrl();
            const response = await fetch(`${serverUrl}/send-email`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    to: email,
                    name: name,
                    type: emailType
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                emailStats.success++;
                showToast(`${emailType} email sent successfully!`, 'success');
                showTestResult(` ${emailType} email sent successfully to ${email}`, 'success');
            } else {
                emailStats.failed++;
                showToast(`Failed to send ${emailType} email: ${result.error}`, 'danger');
                showTestResult(` Failed to send ${emailType} email: ${result.error}`, 'error');
            }

            loadEmailStatistics();
        } catch (error) {
            emailStats.failed++;
            console.error('Email sending error:', error);
            showToast('Error sending email', 'danger');
            showTestResult(` Error sending email: ${error.message}`, 'error');
            loadEmailStatistics();
        }
    }

    function showTestResult(message, type) {
        const resultsCard = document.getElementById('emailTestResults');
        const resultsContent = document.getElementById('testResultsContent');

        if (!resultsCard || !resultsContent) return;

        resultsCard.style.display = 'block';

        const timestamp = new Date().toLocaleTimeString();
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' : 'alert-info';

        const resultHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <small class="text-muted">${timestamp}</small><br>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        resultsContent.insertAdjacentHTML('afterbegin', resultHtml);

        // Keep only last 5 results
        const alerts = resultsContent.querySelectorAll('.alert');
        if (alerts.length > 5) {
            alerts[alerts.length - 1].remove();
        }
    }

    async function loadEmailTemplates() {
        const templatesCard = document.getElementById('emailTemplatesCard');
        const templatesList = document.getElementById('emailTemplatesList');

        if (!templatesCard || !templatesList) return;

        try {
            const serverUrl = getServerUrl();
            const response = await fetch(`${serverUrl}/email-templates`);
            const data = await response.json();

            if (response.ok && data.templates) {
                templatesCard.style.display = 'block';

                const templatesHtml = data.templates.map(template => `
                    <div class="border rounded p-2 mb-2">
                        <strong>${template.name}</strong><br>
                        <small class="text-muted">${template.description}</small>
                    </div>
                `).join('');

                templatesList.innerHTML = templatesHtml;
            } else {
                showToast('Failed to load email templates', 'danger');
            }
        } catch (error) {
            console.error('Error loading templates:', error);
            showToast('Error loading email templates', 'danger');
        }
    }

    // Initialize Resend system when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for other scripts to load
        setTimeout(initializeResendEmailSystem, 1000);
    });

    </script>
</body>
</html>